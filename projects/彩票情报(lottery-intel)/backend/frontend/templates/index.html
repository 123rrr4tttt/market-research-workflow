<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å½©ç¥¨æƒ…æŠ¥ä»ªè¡¨ç›˜</title>
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        margin: 0;
        padding: 24px;
        background: #f8fafc;
        color: #1e293b;
        line-height: 1.6;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
      }
      header {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 24px;
      }
      h1 {
        margin: 0 0 8px 0;
        font-size: 28px;
        color: #0f172a;
      }
      header p {
        margin: 0;
        color: #64748b;
      }
      header a {
        color: #2563eb;
        text-decoration: none;
        font-weight: 500;
      }
      header a:hover {
        text-decoration: underline;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      label {
        font-weight: 500;
        color: #475569;
        white-space: nowrap;
      }
      input, select {
        padding: 10px 14px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
        background: white;
      }
      input:focus, select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      input[type="number"] {
        width: 100px;
      }
      input[type="date"] {
        min-width: 160px;
      }
      input[type="checkbox"] {
        width: auto;
        margin-right: 6px;
        cursor: pointer;
      }
      button {
        padding: 10px 20px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      button:hover:not(:disabled) {
        background: #1d4ed8;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      button:active:not(:disabled) {
        transform: translateY(0);
      }
      button:disabled {
        background: #94a3b8;
        cursor: not-allowed;
        transform: none;
      }
      button.secondary {
        background: #64748b;
      }
      button.secondary:hover:not(:disabled) {
        background: #475569;
      }
      section {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 24px;
      }
      section h2 {
        margin: 0 0 20px 0;
        font-size: 20px;
        color: #0f172a;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 12px;
      }
      code {
        background: #f1f5f9;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 13px;
        color: #6366f1;
        font-family: 'Monaco', 'Menlo', monospace;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 16px;
        font-size: 14px;
      }
      th, td {
        border: 1px solid #e2e8f0;
        padding: 12px;
        text-align: left;
      }
      th {
        background: #f8fafc;
        font-weight: 600;
        color: #475569;
        position: sticky;
        top: 0;
      }
      tbody tr:hover {
        background: #f8fafc;
      }
      tbody tr:nth-child(even) {
        background: #fafbfc;
      }
      tbody tr:nth-child(even):hover {
        background: #f1f5f9;
      }
      .card {
        border: 1px solid #e2e8f0;
        padding: 20px;
        border-radius: 8px;
        margin-top: 16px;
        background: #fafbfc;
        min-height: 60px;
        transition: all 0.2s;
      }
      .card.loading {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
      }
      .card.error {
        background: #fef2f2;
        border-color: #fecaca;
        color: #991b1b;
      }
      .card.success {
        background: #f0fdf4;
        border-color: #bbf7d0;
      }
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #cbd5e1;
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .result-item {
        border-bottom: 1px solid #e2e8f0;
        padding: 16px 0;
      }
      .result-item:last-child {
        border-bottom: none;
      }
      .result-title {
        font-weight: 600;
        font-size: 16px;
        color: #0f172a;
        margin-bottom: 6px;
      }
      .result-meta {
        color: #64748b;
        font-size: 13px;
        margin-bottom: 8px;
      }
      .result-summary {
        color: #475569;
        margin-top: 8px;
        line-height: 1.6;
      }
      .result-highlight {
        margin-top: 8px;
        padding: 8px;
        background: #fef3c7;
        border-left: 3px solid #f59e0b;
        border-radius: 4px;
        font-size: 13px;
      }
      .result-highlight strong {
        color: #92400e;
      }
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        margin-right: 8px;
      }
      .badge-success {
        background: #dcfce7;
        color: #166534;
      }
      .badge-error {
        background: #fee2e2;
        color: #991b1b;
      }
      .badge-warning {
        background: #fef3c7;
        color: #92400e;
      }
      .badge-info {
        background: #dbeafe;
        color: #1e40af;
      }
      .link {
        color: #2563eb;
        text-decoration: none;
      }
      .link:hover {
        text-decoration: underline;
      }
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #64748b;
      }
      .empty-state::before {
        content: "ğŸ“‹";
        font-size: 48px;
        display: block;
        margin-bottom: 12px;
      }
      @media (max-width: 768px) {
        body {
          padding: 12px;
        }
        section {
          padding: 16px;
        }
        .row {
          flex-direction: column;
          align-items: stretch;
        }
        label {
          margin-bottom: 4px;
        }
        input, select, button {
          width: 100%;
        }
        table {
          font-size: 12px;
        }
        th, td {
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ¯ å½©ç¥¨æƒ…æŠ¥ä»ªè¡¨ç›˜</h1>
        <p><a href="settings.html">âš™ï¸ ç³»ç»Ÿè®¾ç½®</a> | å®æ—¶æ•°æ®ç›‘æ§ä¸åˆ†æå¹³å°</p>
      </header>

      <section>
        <h2>ğŸ” æ”¿ç­–æœç´¢</h2>
        <div class="row">
          <label>å·ï¼š</label>
          <select id="search-state">
            <option value="CA" selected>CA</option>
          </select>
          <label>å…³é”®è¯ï¼š</label>
          <input id="search-query" placeholder="è¾“å…¥å…³é”®è¯æˆ–çŸ­è¯­..." style="flex: 1; min-width: 200px;" />
          <select id="search-mode">
            <option value="hybrid">æ··åˆæœç´¢</option>
            <option value="bm25">BM25</option>
            <option value="vector">å‘é‡æœç´¢</option>
          </select>
          <button onclick="runSearch()" id="search-btn">ğŸ” æœç´¢</button>
        </div>
        <div id="search-output" class="card">
          <div class="empty-state">è¾“å…¥å…³é”®è¯åç‚¹å‡»"æœç´¢"æŸ¥çœ‹ç»“æœ</div>
        </div>
      </section>

      <section>
        <h2>ğŸ“Š æŠ¥å‘Šç”Ÿæˆ</h2>
        <div class="row">
          <label>å·ï¼š</label>
          <label><input type="checkbox" name="report-state" value="CA" checked /> CA</label>
          <label><input type="checkbox" name="report-state" value="NY" /> NY</label>
          <label><input type="checkbox" name="report-state" value="TX" /> TX</label>
        </div>
        <div class="row">
          <label>å¼€å§‹æ—¥æœŸï¼š</label>
          <input id="report-start" type="date" />
          <label>ç»“æŸæ—¥æœŸï¼š</label>
          <input id="report-end" type="date" />
          <select id="report-format">
            <option value="html" selected>HTML é¢„è§ˆ</option>
            <option value="csv">CSV ä¸‹è½½</option>
          </select>
          <button onclick="generateReport()" id="report-btn">ğŸ“„ ç”ŸæˆæŠ¥å‘Š</button>
        </div>
        <div id="report-output" class="card">
          <div class="empty-state">é€‰æ‹©æ¡ä»¶åç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"</div>
        </div>
      </section>

      <section>
        <h2>ğŸ“ˆ å¸‚åœºæ•°æ®</h2>
        <div class="row">
          <label>å·ï¼š</label>
          <select id="market-state">
            <option value="CA" selected>CA</option>
            <option value="NY">NY</option>
            <option value="TX">TX</option>
          </select>
          <label>å‘¨æœŸï¼š</label>
          <select id="market-period">
            <option value="daily">æŒ‰æ—¥</option>
            <option value="monthly">æŒ‰æœˆ</option>
          </select>
          <button onclick="loadMarket()" id="market-btn">ğŸ“Š æ‹‰å–å¸‚åœºæ•°æ®</button>
        </div>
        <div id="market-output" class="card">
          <div class="empty-state">ç‚¹å‡»"æ‹‰å–å¸‚åœºæ•°æ®"æŸ¥çœ‹ç»“æœ</div>
        </div>
      </section>

      <section>
        <h2>ğŸ”„ æ•°æ®é‡‡é›†æµç¨‹</h2>
        <div class="row">
          <label>æ”¿ç­–å·ï¼š</label>
          <select id="ingest-state">
            <option value="CA" selected>CA</option>
          </select>
          <label><input type="checkbox" id="ingest-async" /> å¼‚æ­¥ï¼ˆCeleryï¼‰</label>
          <button onclick="ingestPolicy()" id="ingest-policy-btn">ğŸš€ æ‰§è¡Œæ”¿ç­–æŠ“å–</button>
        </div>
        <div class="row" style="margin-top:12px;">
          <label>å¸‚åœºå·ï¼š</label>
          <select id="ingest-market-state">
            <option value="CA" selected>CA</option>
            <option value="NY">NY</option>
            <option value="TX">TX</option>
          </select>
          <label>ç©æ³•ï¼š</label>
          <select id="ingest-market-game">
            <option value="">å…¨éƒ¨</option>
            <option value="SuperLotto Plus">SuperLotto Plus</option>
            <option value="Powerball">Powerball</option>
            <option value="Mega Millions">Mega Millions</option>
            <option value="Powerball US">Powerball (US)</option>
            <option value="NY Lottery Open Data">NY Lottery Open Data</option>
            <option value="Texas Powerball">Texas Powerball</option>
          </select>
          <label>æ•°é‡ï¼š</label>
          <input id="ingest-market-limit" type="number" min="1" max="100" placeholder="é»˜è®¤" />
          <label><input type="checkbox" id="ingest-market-async" /> å¼‚æ­¥</label>
          <button onclick="ingestMarket()" id="ingest-market-btn">ğŸš€ æ‰§è¡Œå¸‚åœºæŠ“å–</button>
        </div>
        <div class="row" style="margin-top:12px;">
          <label>åŠ å· PDF æŠ¥å‘Šï¼š</label>
          <input id="ingest-report-limit" type="number" min="1" max="20" value="3" />
          <button onclick="ingestReports()" id="ingest-report-btn">ğŸ“‘ æŠ“å–é”€å”®æŠ¥å‘Š</button>
        </div>
        <div id="ingest-output" class="card">
          <div class="empty-state">æ‰§è¡ŒæŠ“å–åå°†åœ¨æ­¤æ˜¾ç¤ºä»»åŠ¡ç»“æœæˆ–ä»»åŠ¡ç¼–å·</div>
        </div>

        <div style="margin-top:20px;" class="row">
          <button onclick="loadIngestHistory()" id="history-btn" class="secondary">ğŸ”„ åˆ·æ–°å†å²</button>
        </div>
        <div id="history-output" class="card">
          <div class="empty-state">æ˜¾ç¤ºæœ€è¿‘çš„é‡‡é›†/ç´¢å¼•ä»»åŠ¡å†å²</div>
        </div>
        <div style="color:#64748b; font-size:13px; margin-top:8px; padding: 8px; background: #f1f5f9; border-radius: 6px;">
          ğŸ’¡ æç¤ºï¼šæäº¤ä»»åŠ¡åä¼šè‡ªåŠ¨åˆ·æ–°ï¼Œè‹¥çŠ¶æ€ä¸º <span class="badge badge-warning">running</span> è¡¨ç¤ºä»»åŠ¡æ‰§è¡Œä¸­ã€‚
        </div>
      </section>

      <section>
        <h2>ğŸŒ å¤–éƒ¨èµ„æºå‘ç°</h2>
        <div class="row">
          <label>ä¸»é¢˜ï¼š</label>
          <input id="discovery-topic" placeholder="ä¾‹å¦‚ï¼šCalifornia lottery regulation" style="flex: 1; min-width: 260px;" />
          <select id="discovery-language">
            <option value="en">è‹±æ–‡å…³é”®è¯</option>
            <option value="zh">ä¸­æ–‡å…³é”®è¯</option>
          </select>
          <select id="discovery-provider" style="min-width: 140px;">
            <option value="auto">ğŸ”„ è‡ªåŠ¨é€‰æ‹©</option>
            <option value="ddg">ğŸ¦† DuckDuckGo</option>
            <option value="google">ğŸ” Google (100/å¤©)</option>
            <option value="serpstack">ğŸ“Š Serpstack (100/æœˆ)</option>
            <option value="serpapi">ğŸ’ SerpAPI (ä»˜è´¹)</option>
          </select>
          <button onclick="runDiscovery()" id="discovery-btn">ğŸ” æœç´¢èµ„æ–™</button>
        </div>
        <div style="color:#64748b; font-size:13px; margin-top:8px; padding: 8px; background: #f1f5f9; border-radius: 6px;">
          ğŸ’¡ æç¤ºï¼šé€‰æ‹©"è‡ªåŠ¨é€‰æ‹©"æ—¶ä¼šæŒ‰ä¼˜å…ˆçº§å°è¯•ï¼ˆDDG â†’ Google â†’ Serpstack â†’ SerpAPIï¼‰ï¼Œæ‰‹åŠ¨é€‰æ‹©åˆ™ä»…ä½¿ç”¨æŒ‡å®šæœåŠ¡
        </div>
        <div id="discovery-output" class="card">
          <div class="empty-state">è¾“å…¥ä¸»é¢˜åç‚¹å‡»"æœç´¢èµ„æ–™"æŸ¥çœ‹ç»“æœ</div>
        </div>
      </section>
    </div>

    <script>
      function setLoading(elementId, buttonId = null) {
        const container = document.getElementById(elementId);
        container.className = 'card loading';
        container.innerHTML = '<span class="spinner"></span>åŠ è½½ä¸­...';
        if (buttonId) {
          const btn = document.getElementById(buttonId);
          if (btn) btn.disabled = true;
        }
      }

      async function parseErrorResponse(res) {
        try {
          const text = await res.text();
          try {
            const json = JSON.parse(text);
            if (json.detail) {
              return `HTTP ${res.status}: ${json.detail}`;
            }
            if (json.error) {
              return `HTTP ${res.status}: ${json.error}`;
            }
            return `HTTP ${res.status}: ${text}`;
          } catch {
            return `HTTP ${res.status}: ${text || res.statusText}`;
          }
        } catch {
          return `HTTP ${res.status}: ${res.statusText || 'æœªçŸ¥é”™è¯¯'}`;
        }
      }

      function setError(elementId, message, buttonId = null) {
        const container = document.getElementById(elementId);
        container.className = 'card error';
        // å°è¯•è§£æ JSON æ ¼å¼çš„é”™è¯¯ä¿¡æ¯
        let displayMessage = message;
        try {
          const jsonMatch = message.match(/\{.*\}/);
          if (jsonMatch) {
            const json = JSON.parse(jsonMatch[0]);
            if (json.detail) {
              displayMessage = json.detail;
            } else if (json.error) {
              displayMessage = json.error;
            }
          }
        } catch {
          // ä¿æŒåŸæ ·
        }
        container.innerHTML = `
          <div><strong>âŒ é”™è¯¯ï¼š</strong>${escapeHtml(displayMessage)}</div>
          <div style="margin-top: 8px; font-size: 12px; color: #991b1b;">
            <details>
              <summary style="cursor: pointer;">æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</summary>
              <pre style="margin-top: 8px; font-size: 11px; overflow-x: auto;">${escapeHtml(message)}</pre>
            </details>
          </div>
        `;
        if (buttonId) {
          const btn = document.getElementById(buttonId);
          if (btn) btn.disabled = false;
        }
      }

      async function runSearch() {
        const state = document.getElementById('search-state').value;
        const query = document.getElementById('search-query').value.trim();
        if (!query) {
          setError('search-output', 'è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'search-btn');
          return;
        }
        const mode = document.getElementById('search-mode').value;
        setLoading('search-output', 'search-btn');
        try {
          const encodedQuery = encodeURIComponent(query);
          const url = `/api/v1/search?q=${encodedQuery}&state=${state}&rank=${mode}&top_k=10`;
          const res = await fetch(url);
          if (!res.ok) {
            const errorMsg = await parseErrorResponse(res);
            throw new Error(`${errorMsg} (è¯·æ±‚: ${url})`);
          }
          const data = await res.json();
          renderSearchResults(data);
          document.getElementById('search-btn').disabled = false;
        } catch (err) {
          setError('search-output', err.message, 'search-btn');
        }
      }

      document.getElementById('search-query').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') runSearch();
      });

      async function loadMarket() {
        const state = document.getElementById('market-state').value;
        const period = document.getElementById('market-period').value;
        setLoading('market-output', 'market-btn');
        try {
          const url = `/api/v1/market?state=${state}&period=${period}`;
          const res = await fetch(url);
          if (!res.ok) {
            const errorMsg = await parseErrorResponse(res);
            throw new Error(`${errorMsg} (è¯·æ±‚: ${url})`);
          }
          const data = await res.json();
          renderMarketResults(data);
          document.getElementById('market-btn').disabled = false;
        } catch (err) {
          setError('market-output', err.message, 'market-btn');
        }
      }

      let historyTimer = null;

      async function ingestPolicy() {
        const state = document.getElementById('ingest-state').value;
        const asyncMode = document.getElementById('ingest-async').checked;
        setLoading('ingest-output', 'ingest-policy-btn');
        try {
          const url = '/api/v1/ingest/policy';
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ state, async_mode: asyncMode }),
          });
          if (!res.ok) {
            const errorMsg = await parseErrorResponse(res);
            throw new Error(`${errorMsg} (è¯·æ±‚: POST ${url})`);
          }
          const data = await res.json();
          renderIngestResult(data, asyncMode ? 'policy_async' : 'policy');
          triggerHistoryPolling(asyncMode);
          document.getElementById('ingest-policy-btn').disabled = false;
        } catch (err) {
          setError('ingest-output', err.message, 'ingest-policy-btn');
        }
      }

      async function ingestMarket() {
        const state = document.getElementById('ingest-market-state').value;
        const asyncMode = document.getElementById('ingest-market-async').checked;
        const game = document.getElementById('ingest-market-game').value;
        const limitRaw = document.getElementById('ingest-market-limit').value;
        const limit = limitRaw ? Number(limitRaw) : null;
        setLoading('ingest-output', 'ingest-market-btn');
        try {
          const url = '/api/v1/ingest/market';
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              state,
              async_mode: asyncMode,
              game: game || null,
              limit: Number.isFinite(limit) ? limit : null,
            }),
          });
          if (!res.ok) {
            const errorMsg = await parseErrorResponse(res);
            throw new Error(`${errorMsg} (è¯·æ±‚: POST ${url})`);
          }
          const data = await res.json();
          renderIngestResult(data, asyncMode ? 'market_async' : 'market');
          triggerHistoryPolling(asyncMode);
          document.getElementById('ingest-market-btn').disabled = false;
        } catch (err) {
          setError('ingest-output', err.message, 'ingest-market-btn');
        }
      }

      async function ingestReports() {
        const limitRaw = document.getElementById('ingest-report-limit').value;
        const limit = limitRaw ? Number(limitRaw) : 3;
        setLoading('ingest-output', 'ingest-report-btn');
        try {
          const url = '/api/v1/ingest/reports/california';
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ limit: Number.isFinite(limit) ? limit : 3 }),
          });
          if (!res.ok) {
            const errorMsg = await parseErrorResponse(res);
            throw new Error(`${errorMsg} (è¯·æ±‚: POST ${url})`);
          }
          const data = await res.json();
          renderIngestResult(data, 'market_report');
          triggerHistoryPolling(false);
          document.getElementById('ingest-report-btn').disabled = false;
        } catch (err) {
          setError('ingest-output', err.message, 'ingest-report-btn');
        }
      }

      async function loadIngestHistory() {
        const container = document.getElementById('history-output');
        if (!container.classList.contains('loading')) {
          container.className = 'card loading';
          container.innerHTML = '<span class="spinner"></span>åŠ è½½å†å²ä¸­...';
        }
        try {
          const url = '/api/v1/ingest/history';
          const res = await fetch(url);
          if (!res.ok) {
            const errorMsg = await parseErrorResponse(res);
            throw new Error(`${errorMsg} (è¯·æ±‚: GET ${url})`);
          }
          const data = await res.json();
          renderHistory(data);
        } catch (err) {
          setError('history-output', err.message);
        }
      }

      function triggerHistoryPolling(asyncMode) {
        loadIngestHistory();
        if (historyTimer) {
          clearInterval(historyTimer);
          historyTimer = null;
        }
        if (asyncMode) {
          historyTimer = setInterval(loadIngestHistory, 3000);
        }
      }

      function renderSearchResults(data) {
        const container = document.getElementById('search-output');
        container.className = 'card';
        if (!data || !Array.isArray(data.results) || !data.results.length) {
          container.innerHTML = '<div class="empty-state">æš‚æ— æœç´¢ç»“æœï¼Œå¯å°è¯•æ›´æ¢å…³é”®å­—æˆ–æŠ“å–æ•°æ®</div>';
          return;
        }
        const items = data.results.map((item, idx) => {
          const highlight = item.highlight && item.highlight.length 
            ? `<div class="result-highlight"><strong>é«˜äº®ï¼š</strong>${item.highlight.join('<br/>')}</div>` 
            : '';
          return `
            <div class="result-item">
              <div class="result-title">${idx + 1}. ${escapeHtml(item.title || 'æ— æ ‡é¢˜')} <span class="badge badge-info">${item.state || ''}</span></div>
              <div class="result-meta">ğŸ“… ${item.publish_date || 'æœªçŸ¥æ—¥æœŸ'} Â· ğŸ” æ¨¡å¼ï¼š${item.mode || 'æœªçŸ¥'}</div>
              <div class="result-summary">${escapeHtml(item.summary || item.text?.slice(0, 200) || 'æš‚æ— æ‘˜è¦')}${item.text && item.text.length > 200 ? '...' : ''}</div>
              ${highlight}
            </div>
          `;
        }).join('');
        const summary = `<div style="margin-bottom: 16px; padding: 12px; background: #f1f5f9; border-radius: 6px;">
          <strong>æŸ¥è¯¢ï¼š</strong><code>${escapeHtml(data.query)}</code> Â· 
          <strong>æ¨¡å¼ï¼š</strong><span class="badge badge-info">${data.rank}</span> Â· 
          <strong>è¿”å›ï¼š</strong><span class="badge badge-success">${data.results.length} æ¡</span>
        </div>`;
        container.innerHTML = summary + items;
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function renderMarketResults(data) {
        const container = document.getElementById('market-output');
        container.className = 'card';
        if (!data || !Array.isArray(data.series) || !data.series.length) {
          container.innerHTML = '<div class="empty-state">æš‚æ— å¸‚åœºæ•°æ®ï¼Œè¯·å…ˆæŠ“å–æˆ–æ‹“å±•æ•°æ®æº</div>';
          return;
        }
        const rows = data.series.map((row) => {
          const ticketPrice = row.ticket_price == null ? '-' : formatNumber(row.ticket_price);
          const sourceLabel = row.source_name || (row.source_uri ? 'æ¥æº' : '-');
          const sourceCell = row.source_uri
            ? `<a href="${escapeHtml(row.source_uri)}" target="_blank" rel="noopener" class="link">${escapeHtml(sourceLabel)}</a>`
            : escapeHtml(sourceLabel);
          return `
            <tr>
              <td>${escapeHtml(row.date || '-')}</td>
              <td>${formatNumber(row.revenue)}</td>
              <td>${formatNumber(row.sales_volume)}</td>
              <td>${formatNumber(row.jackpot)}</td>
              <td>${ticketPrice}</td>
              <td>${sourceCell}</td>
            </tr>
          `;
        }).join('');
        const summary = `<div style="margin-bottom: 16px; padding: 12px; background: #f1f5f9; border-radius: 6px;">
          <strong>å·ï¼š</strong><span class="badge badge-info">${escapeHtml(data.state)}</span> Â· 
          <strong>å‘¨æœŸï¼š</strong><span class="badge badge-info">${escapeHtml(data.period)}</span> Â· 
          <strong>è®°å½•æ•°ï¼š</strong><span class="badge badge-success">${data.series.length}</span>
        </div>`;
        container.innerHTML = summary + `
          <div style="overflow-x: auto;">
            <table>
              <thead><tr><th>æ—¥æœŸ</th><th>é”€å”®é¢</th><th>é”€é‡</th><th>å¥–æ± </th><th>ç¥¨ä»·</th><th>æ¥æº</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
      }

      function formatNumber(value) {
        if (value == null || value === '-') return '-';
        if (typeof value === 'number') {
          return value.toLocaleString('zh-CN');
        }
        return escapeHtml(String(value));
      }

      function renderIngestResult(data, type) {
        const container = document.getElementById('ingest-output');
        container.className = 'card';
        if (data.error) {
          setError('ingest-output', `${type} è°ƒç”¨å¤±è´¥ï¼š${data.error}`);
          return;
        }
        if (data.detail) {
          setError('ingest-output', `${type} è°ƒç”¨å¤±è´¥ï¼š${data.detail}`);
          return;
        }

        if (data.async) {
          container.className = 'card success';
          container.innerHTML = `
            <div style="margin-bottom: 8px;">
              <span class="badge badge-success">ä»»åŠ¡å·²æäº¤</span>
              <span class="badge badge-info">${escapeHtml(type)}</span>
            </div>
            <div><strong>ä»»åŠ¡IDï¼š</strong><code>${escapeHtml(data.task_id)}</code></div>
            <div style="margin-top: 8px; color: #64748b; font-size: 13px;">ä»»åŠ¡æ­£åœ¨åå°æ‰§è¡Œï¼Œè¯·æŸ¥çœ‹å†å²è®°å½•äº†è§£è¿›åº¦ã€‚</div>
          `;
        } else {
          container.className = 'card success';
          container.innerHTML = `
            <div style="margin-bottom: 12px;">
              <span class="badge badge-success">æ‰§è¡Œå®Œæˆ</span>
              <span class="badge badge-info">${escapeHtml(type)}</span>
            </div>
            <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 8px;">
              <div><strong>æ–°å¢ï¼š</strong><span class="badge badge-success">${data.inserted ?? 0}</span></div>
              <div><strong>æ›´æ–°ï¼š</strong><span class="badge badge-info">${data.updated ?? 0}</span></div>
              <div><strong>è·³è¿‡ï¼š</strong><span class="badge badge-warning">${data.skipped ?? 0}</span></div>
            </div>
            ${data.document_ids ? `<div style="margin-top: 8px;"><strong>æ–‡æ¡£IDï¼š</strong><code style="word-break: break-all;">${data.document_ids.join(', ')}</code></div>` : ''}
            ${data.state ? `<div style="margin-top: 8px;"><strong>å·ï¼š</strong><span class="badge badge-info">${escapeHtml(data.state)}</span></div>` : ''}
          `;
        }
      }

      function renderHistory(data) {
        const container = document.getElementById('history-output');
        container.className = 'card';
        if (!Array.isArray(data) || !data.length) {
          container.innerHTML = '<div class="empty-state">æš‚æ— å†å²è®°å½•ï¼Œå¯æ‰§è¡Œé‡‡é›†ä»»åŠ¡åæŸ¥çœ‹</div>';
          return;
        }
        const rows = data.map((job) => {
          let statusBadge = '';
          if (job.status === 'completed') {
            statusBadge = '<span class="badge badge-success">å·²å®Œæˆ</span>';
          } else if (job.status === 'failed') {
            statusBadge = '<span class="badge badge-error">å¤±è´¥</span>';
          } else if (job.status === 'running') {
            statusBadge = '<span class="badge badge-warning">è¿è¡Œä¸­</span>';
          } else {
            statusBadge = `<span class="badge badge-info">${escapeHtml(job.status)}</span>`;
          }
          const paramsText = job.params ? JSON.stringify(job.params, null, 2).slice(0, 100) : '-';
          return `
          <tr>
            <td><code>${escapeHtml(String(job.id))}</code></td>
            <td><span class="badge badge-info">${escapeHtml(job.job_type || '-')}</span></td>
            <td>${statusBadge}</td>
            <td>${job.started_at ? new Date(job.started_at).toLocaleString('zh-CN') : '-'}</td>
            <td>${job.finished_at ? new Date(job.finished_at).toLocaleString('zh-CN') : '-'}</td>
            <td style="max-width: 200px; word-break: break-all; font-size: 12px;"><code>${escapeHtml(paramsText)}</code></td>
            <td style="max-width: 200px; word-break: break-all; color: #dc2626;">${job.error ? escapeHtml(job.error).slice(0, 100) : ''}</td>
          </tr>
        `;}).join('');
        container.innerHTML = `
          <div style="margin-bottom: 12px; padding: 12px; background: #f1f5f9; border-radius: 6px;">
            <strong>å†å²è®°å½•ï¼š</strong><span class="badge badge-success">${data.length} æ¡</span>
          </div>
          <div style="overflow-x: auto;">
            <table>
              <thead><tr><th>ID</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th>å¼€å§‹æ—¶é—´</th><th>å®Œæˆæ—¶é—´</th><th>å‚æ•°/ç»“æœ</th><th>é”™è¯¯</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
        if (historyTimer && !data.some(job => job.status === 'running')) {
          clearInterval(historyTimer);
          historyTimer = null;
        }
      }

      window.addEventListener('DOMContentLoaded', loadIngestHistory);

      async function runDiscovery() {
        const topic = document.getElementById('discovery-topic').value.trim();
        const lang = document.getElementById('discovery-language').value;
        const provider = document.getElementById('discovery-provider').value;
        if (!topic) {
          setError('discovery-output', 'è¯·è¾“å…¥æœç´¢ä¸»é¢˜', 'discovery-btn');
          return;
        }
        setLoading('discovery-output', 'discovery-btn');
        try {
          const res = await fetch('/api/v1/discovery/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic, language: lang, max_results: 12, provider: provider }),
          });
          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(errorText || `HTTP ${res.status}`);
          }
          const data = await res.json();
          const container = document.getElementById('discovery-output');
          container.className = 'card';
          if (!Array.isArray(data.results) || !data.results.length) {
            const providerName = {
              'auto': 'è‡ªåŠ¨é€‰æ‹©',
              'ddg': 'DuckDuckGo',
              'serpstack': 'Serpstack',
              'bing': 'Bing Search API',
              'serpapi': 'SerpAPI'
            }[provider] || provider;
            container.innerHTML = `<div class="empty-state">æœªæ‰¾åˆ°ç›¸å…³ç»“æœï¼ˆä½¿ç”¨æœåŠ¡ï¼š${providerName}ï¼‰<br/>å¯å°è¯•æ›´æ¢ä¸»é¢˜æˆ–é€‰æ‹©å…¶ä»–æœç´¢æœåŠ¡</div>`;
            document.getElementById('discovery-btn').disabled = false;
            return;
          }
          const items = data.results.map((item) => `
            <div class="result-item">
              <div class="result-title">${escapeHtml(item.title || 'æ— æ ‡é¢˜')}</div>
              <div class="result-meta">
                å…³é”®è¯ï¼š<span class="badge badge-info">${escapeHtml(item.keyword)}</span> Â· 
                æ¥æºï¼š<span class="badge badge-success">${escapeHtml(item.source || '-')}</span> Â· 
                <a href="${escapeHtml(item.link)}" target="_blank" rel="noopener" class="link">ğŸ”— è®¿é—®</a>
              </div>
              <div class="result-summary">${escapeHtml(item.snippet || '')}</div>
            </div>
          `).join('');
          const providerName = {
            'auto': 'è‡ªåŠ¨é€‰æ‹©',
            'ddg': 'DuckDuckGo',
            'serpstack': 'Serpstack',
            'bing': 'Bing Search API',
            'serpapi': 'SerpAPI'
          }[provider] || provider;
          const providerUsed = data.provider_used || 'unknown';
          container.innerHTML = `<div style="margin-bottom: 16px; padding: 12px; background: #f1f5f9; border-radius: 6px;">
            <strong>ä¸»é¢˜ï¼š</strong><code>${escapeHtml(topic)}</code> Â· 
            <strong>ç»“æœæ•°ï¼š</strong><span class="badge badge-success">${data.results.length}</span> Â· 
            <strong>æœåŠ¡ï¼š</strong><span class="badge badge-info">${providerName}</span>
            ${provider === 'auto' && providerUsed !== 'none' ? ` Â· <strong>å®é™…ä½¿ç”¨ï¼š</strong><span class="badge badge-success">${providerUsed}</span>` : ''}
          </div>${items}`;
          document.getElementById('discovery-btn').disabled = false;
        } catch (err) {
          setError('discovery-output', err.message, 'discovery-btn');
        }
      }

      document.getElementById('discovery-topic').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') runDiscovery();
      });

      async function generateReport() {
        const states = Array.from(document.querySelectorAll('input[name="report-state"]:checked')).map(el => el.value);
        if (!states.length) {
          setError('report-output', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå·', 'report-btn');
          return;
        }
        const start = document.getElementById('report-start').value || null;
        const end = document.getElementById('report-end').value || null;
        const fmt = document.getElementById('report-format').value;
        setLoading('report-output', 'report-btn');
        try {
          if (fmt === 'html') {
            const res = await fetch('/api/v1/reports', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ states, start, end, format: 'html' }),
            });
            if (!res.ok) {
              const errorText = await res.text();
              throw new Error(errorText || `HTTP ${res.status}`);
            }
            const data = await res.json();
            const container = document.getElementById('report-output');
            container.className = 'card success';
            container.innerHTML = data.data || '<div class="empty-state">ç”Ÿæˆå¤±è´¥</div>';
            document.getElementById('report-btn').disabled = false;
          } else {
            const res = await fetch('/api/v1/reports', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ states, start, end, format: 'csv' }),
            });
            if (!res.ok) {
              const errorText = await res.text();
              throw new Error(errorText || `HTTP ${res.status}`);
            }
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lottery_report_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            const container = document.getElementById('report-output');
            container.className = 'card success';
            container.innerHTML = '<div class="empty-state">âœ… CSV æ–‡ä»¶å·²ä¸‹è½½</div>';
            document.getElementById('report-btn').disabled = false;
          }
        } catch (err) {
          setError('report-output', err.message, 'report-btn');
        }
      }
    </script>
  </body>
  </html>


