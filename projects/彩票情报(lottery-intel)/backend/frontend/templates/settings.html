<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç³»ç»Ÿè®¾ç½® - å½©ç¥¨æƒ…æŠ¥</title>
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        margin: 0;
        padding: 24px;
        background: #f8fafc;
        color: #1e293b;
        line-height: 1.6;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }
      header {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 24px;
      }
      h1 {
        margin: 0 0 8px 0;
        font-size: 28px;
        color: #0f172a;
      }
      header p {
        margin: 0;
        color: #64748b;
      }
      header a {
        color: #2563eb;
        text-decoration: none;
        font-weight: 500;
      }
      header a:hover {
        text-decoration: underline;
      }
      .warning {
        border-left: 4px solid #f97316;
        padding: 16px;
        background: #fff7ed;
        border-radius: 8px;
        margin: 24px 0;
      }
      .warning strong {
        color: #c2410c;
      }
      .card {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 24px;
        background: white;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .card h2 {
        margin: 0 0 20px 0;
        font-size: 20px;
        color: #0f172a;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 12px;
      }
      label {
        display: block;
        font-weight: 500;
        margin-top: 16px;
        color: #475569;
      }
      label:first-child {
        margin-top: 0;
      }
      input, select {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        margin-top: 8px;
        font-family: inherit;
        font-size: 14px;
        transition: all 0.2s;
        background: white;
      }
      input:focus, select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      input[type="password"] {
        font-family: monospace;
      }
      button {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        margin-right: 12px;
        margin-top: 16px;
      }
      button.primary {
        background: #2563eb;
        color: white;
      }
      button.primary:hover:not(:disabled) {
        background: #1d4ed8;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      button.secondary {
        background: #64748b;
        color: white;
      }
      button.secondary:hover:not(:disabled) {
        background: #475569;
      }
      button:disabled {
        background: #94a3b8;
        cursor: not-allowed;
        transform: none;
      }
      button:active:not(:disabled) {
        transform: translateY(0);
      }
      code {
        background: #f1f5f9;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 13px;
        color: #6366f1;
        font-family: 'Monaco', 'Menlo', monospace;
      }
      pre {
        background: #f8fafc;
        padding: 16px;
        border-radius: 8px;
        overflow: auto;
        border: 1px solid #e2e8f0;
        font-size: 13px;
        line-height: 1.5;
      }
      pre code {
        background: none;
        padding: 0;
        color: inherit;
      }
      #status {
        margin-top: 16px;
        padding: 12px;
        border-radius: 8px;
        font-weight: 500;
        display: inline-block;
        min-width: 200px;
      }
      #status.success {
        background: #f0fdf4;
        color: #166534;
        border: 1px solid #bbf7d0;
      }
      #status.error {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }
      #status.loading {
        background: #f1f5f9;
        color: #475569;
        border: 1px solid #cbd5e1;
      }
      .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #cbd5e1;
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .field-group {
        margin-bottom: 24px;
      }
      .field-group:last-child {
        margin-bottom: 0;
      }
      .field-help {
        font-size: 12px;
        color: #64748b;
        margin-top: 4px;
        font-weight: normal;
      }
      @media (max-width: 768px) {
        body {
          padding: 12px;
        }
        .card {
          padding: 16px;
        }
        button {
          width: 100%;
          margin-right: 0;
          margin-bottom: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h1>
        <p><a href="index.html">â† è¿”å›ä»ªè¡¨ç›˜</a> | é…ç½®æ•°æ®åº“ã€æ£€ç´¢æœåŠ¡ä¸ LLM å‚æ•°</p>
      </header>

      <div class="warning">
        <p><strong>âš ï¸ é‡è¦æç¤ºï¼š</strong> ä¿®æ”¹æ•°æ®åº“/Elasticsearch/Redis åœ°å€åï¼Œå»ºè®®é‡å¯ç›¸å…³å®¹å™¨æˆ–æœåŠ¡ï¼›LLM é…ç½®æ›´æ–°åæ–°çš„è¯·æ±‚ä¼šå³æ—¶ç”Ÿæ•ˆã€‚</p>
      </div>

      <section class="card">
        <h2>ğŸ”Œ è¿æ¥ä¿¡æ¯</h2>
        <div class="field-group">
          <label>æ•°æ®åº“è¿æ¥ä¸²</label>
          <input id="DATABASE_URL" type="text" placeholder="postgresql+psycopg2://postgres:postgres@db:5432/postgres" />
          <div class="field-help">PostgreSQL æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²</div>
        </div>
        <div class="field-group">
          <label>Elasticsearch åœ°å€</label>
          <input id="ES_URL" type="text" placeholder="http://es:9200" />
          <div class="field-help">Elasticsearch æœåŠ¡çš„ HTTP åœ°å€</div>
        </div>
        <div class="field-group">
          <label>Redis åœ°å€</label>
          <input id="REDIS_URL" type="text" placeholder="redis://redis:6379/0" />
          <div class="field-help">Redis æœåŠ¡å™¨åœ°å€ï¼Œç”¨äº Celery ä»»åŠ¡é˜Ÿåˆ—</div>
        </div>
      </section>

      <section class="card">
        <h2>ğŸ¤– LLM ä¸åµŒå…¥é…ç½®</h2>
        <div class="field-group">
          <label>æä¾›å•†</label>
          <select id="LLM_PROVIDER">
            <option value="openai">OpenAI</option>
            <option value="azure">Azure OpenAI</option>
            <option value="ollama">Ollama</option>
          </select>
          <div class="field-help">é€‰æ‹© LLM æœåŠ¡æä¾›å•†</div>
        </div>
        <div class="field-group">
          <label>OpenAI API Key</label>
          <input id="OPENAI_API_KEY" type="password" placeholder="sk-***" />
          <div class="field-help">OpenAI API å¯†é’¥ï¼ˆè¾“å…¥æ—¶ä¼šéšè—ï¼‰</div>
        </div>
        <div class="field-group">
          <label>OpenAI Base URL</label>
          <input id="OPENAI_API_BASE" type="text" placeholder="å¯é€‰ä»£ç†åœ°å€" />
          <div class="field-help">å¯é€‰ï¼šç”¨äºä»£ç†æˆ–å…¼å®¹ API çš„åœ°å€</div>
        </div>
        <div class="field-group">
          <label>Azure API Key</label>
          <input id="AZURE_API_KEY" type="password" placeholder="Azure Key" />
          <div class="field-help">Azure OpenAI æœåŠ¡å¯†é’¥</div>
        </div>
        <div class="field-group">
          <label>Azure Endpoint</label>
          <input id="AZURE_API_BASE" type="text" placeholder="https://xxx.openai.azure.com" />
          <div class="field-help">Azure OpenAI æœåŠ¡ç«¯ç‚¹åœ°å€</div>
        </div>
        <div class="field-group">
          <label>Azure API Version</label>
          <input id="AZURE_API_VERSION" type="text" placeholder="2024-06-01" />
          <div class="field-help">Azure API ç‰ˆæœ¬å·</div>
        </div>
        <div class="field-group">
          <label>Azure Chat Deployment</label>
          <input id="AZURE_CHAT_DEPLOYMENT" type="text" placeholder="gpt-4o-mini" />
          <div class="field-help">Azure èŠå¤©æ¨¡å‹éƒ¨ç½²åç§°</div>
        </div>
        <div class="field-group">
          <label>Azure Embedding Deployment</label>
          <input id="AZURE_EMBEDDING_DEPLOYMENT" type="text" placeholder="text-embedding-3-large" />
          <div class="field-help">Azure åµŒå…¥æ¨¡å‹éƒ¨ç½²åç§°</div>
        </div>
        <div class="field-group">
          <label>Ollama Base URL</label>
          <input id="OLLAMA_BASE_URL" type="text" placeholder="http://localhost:11434" />
          <div class="field-help">Ollama æœåŠ¡åœ°å€</div>
        </div>
        <div class="field-group">
          <label>SerpAPI Key</label>
          <input id="SERPAPI_KEY" type="password" placeholder="å¯é€‰ï¼šä½œä¸º DDG é™æµå›é€€" />
          <div class="field-help">å¯é€‰ï¼šç”¨äºå¤–éƒ¨æœç´¢çš„å›é€€ APIï¼ˆä»˜è´¹æœåŠ¡ï¼‰</div>
        </div>
      </section>

      <section class="card">
        <h2>ğŸ” å…è´¹æœç´¢ API é…ç½®</h2>
        <div class="field-group">
          <label>Serpstack Key</label>
          <input id="SERPSTACK_KEY" type="password" placeholder="å¯é€‰ï¼šæ¯æœˆ100æ¬¡å…è´¹" />
          <div class="field-help">
            å¯é€‰ï¼š<a href="https://serpstack.com/" target="_blank">Serpstack</a> API Key - æ¯æœˆ100æ¬¡å…è´¹è¯·æ±‚
          </div>
        </div>
        <div class="field-group">
          <label>Azure AI Search Endpoint</label>
          <input id="AZURE_SEARCH_ENDPOINT" type="text" placeholder="https://lotto.search.windows.net" />
          <div class="field-help">
            Azure AI Search æœåŠ¡ç«¯ç‚¹ï¼ˆä¾‹å¦‚ï¼šhttps://lotto.search.windows.netï¼‰
          </div>
        </div>
        <div class="field-group">
          <label>Azure AI Search API Key</label>
          <input id="AZURE_SEARCH_KEY" type="password" placeholder="Azure Search API å¯†é’¥" />
          <div class="field-help">
            Azure AI Search API å¯†é’¥ï¼Œå¯åœ¨ Azure é—¨æˆ·ä¸­è·å–
          </div>
        </div>
        <div style="padding: 12px; background: #f1f5f9; border-radius: 6px; margin-top: 16px;">
          <strong>ğŸ’¡ æç¤ºï¼š</strong>
          <ul style="margin: 8px 0 0 20px; padding: 0;">
            <li>æœç´¢å¤±è´¥æ—¶ä¼šæŒ‰ä¼˜å…ˆçº§è‡ªåŠ¨é™çº§ï¼šDDG â†’ Serpstack â†’ Azure Search â†’ SerpAPI</li>
            <li>Azure AI Search æä¾›å¼ºå¤§çš„å…¨æ–‡æœç´¢åŠŸèƒ½</li>
            <li>è¯¦ç»†é…ç½®è¯´æ˜è¯·æŸ¥çœ‹ <code>backend/SEARCH_API_SETUP.md</code></li>
          </ul>
        </div>
      </section>

      <div class="card">
        <button class="primary" onclick="saveSettings()" id="save-btn">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
        <button class="secondary" onclick="loadSettings()" id="load-btn">ğŸ”„ é‡æ–°åŠ è½½</button>
        <div id="status"></div>
      </div>

      <section class="card">
        <h2>ğŸ“š å¸¸ç”¨å‘½ä»¤å‚è€ƒ</h2>
        <pre><code># å®‰è£…ä¾èµ–
pip install -r projects/å½©ç¥¨æƒ…æŠ¥(lottery-intel)/backend/requirements.txt

# å¯åŠ¨ Docker æœåŠ¡
docker compose -f projects/å½©ç¥¨æƒ…æŠ¥(lottery-intel)/ops/docker-compose.yml up -d --build

# å¯åŠ¨ Celery Worker
cd projects/å½©ç¥¨æƒ…æŠ¥(lottery-intel)/backend
celery -A app.celery_app.celery_app worker -l info

# å¯åŠ¨ FastAPI æœåŠ¡
uvicorn app.main:app --reload --port 8000</code></pre>
      </section>
    </div>

    <script>
      const FIELD_KEYS = [
        'DATABASE_URL', 'ES_URL', 'REDIS_URL', 'LLM_PROVIDER',
        'OPENAI_API_KEY', 'OPENAI_API_BASE', 'AZURE_API_KEY', 'AZURE_API_BASE',
        'AZURE_API_VERSION', 'AZURE_CHAT_DEPLOYMENT', 'AZURE_EMBEDDING_DEPLOYMENT', 'OLLAMA_BASE_URL',
        'SERPAPI_KEY', 'SERPSTACK_KEY', 'AZURE_SEARCH_ENDPOINT', 'AZURE_SEARCH_KEY'
      ];

      function updateStatus(message, type = 'loading') {
        const status = document.getElementById('status');
        status.className = type;
        if (type === 'loading') {
          status.innerHTML = '<span class="spinner"></span>' + message;
        } else {
          status.textContent = message;
        }
      }

      async function loadSettings() {
        const loadBtn = document.getElementById('load-btn');
        loadBtn.disabled = true;
        updateStatus('æ­£åœ¨åŠ è½½é…ç½®...', 'loading');
        try {
          const res = await fetch('/api/v1/config/env');
          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(errorText || `HTTP ${res.status}`);
          }
          const data = await res.json();
          FIELD_KEYS.forEach((key) => {
            const el = document.getElementById(key);
            if (!el) return;
            const value = data[key] ?? '';
            if (el.tagName === 'SELECT') {
              el.value = value || el.options[0].value;
            } else {
              el.value = value;
              // å¦‚æœæ˜¯å¯†ç å­—æ®µä¸”æœ‰å€¼ï¼Œæ˜¾ç¤ºå ä½ç¬¦æç¤º
              if (el.type === 'password' && value) {
                el.placeholder = 'å·²è®¾ç½®ï¼ˆè¾“å…¥æ–°å€¼ä»¥æ›´æ–°ï¼‰';
              }
            }
          });
          updateStatus('âœ… è®¾ç½®å·²æˆåŠŸåŠ è½½', 'success');
        } catch (err) {
          updateStatus('âŒ åŠ è½½å¤±è´¥ï¼š' + err.message, 'error');
        } finally {
          loadBtn.disabled = false;
        }
      }

      async function saveSettings() {
        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true;
        updateStatus('æ­£åœ¨ä¿å­˜é…ç½®...', 'loading');
        const payload = {};
        FIELD_KEYS.forEach((key) => {
          const el = document.getElementById(key);
          if (!el) return;
          payload[key] = el.value.trim();
        });
        try {
          const res = await fetch('/api/v1/config/env', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(errorText || `HTTP ${res.status}`);
          }
          await res.json();
          updateStatus('âœ… ä¿å­˜æˆåŠŸï¼éƒ¨åˆ†æ”¹åŠ¨éœ€è¦æ‰‹åŠ¨é‡å¯ç›¸å…³æœåŠ¡åç”Ÿæ•ˆã€‚', 'success');
        } catch (err) {
          updateStatus('âŒ ä¿å­˜å¤±è´¥ï¼š' + err.message, 'error');
        } finally {
          saveBtn.disabled = false;
        }
      }

      window.addEventListener('DOMContentLoaded', loadSettings);
    </script>
  </body>
</html>
