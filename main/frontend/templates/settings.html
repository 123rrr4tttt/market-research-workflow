<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>系统设置</title>
    <link rel="stylesheet" href="/static/css/app-theme.css" />
    <style>
      body { padding: 0; }
      .page { padding: 24px; max-width: 1200px; margin: 0 auto; }
      .llm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
      .llm-grid .full { grid-column: 1 / -1; }
      .llm-grid textarea { min-height: 92px; width: 100%; }
      .llm-grid input[type="number"], .llm-grid input[type="text"] { width: 100%; }
      .llm-meta { color: #64748b; font-size: 13px; margin-top: 4px; }
    </style>
    <script src="/static/js/app-shell.js"></script>
    <script src="/static/js/ui-core.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div class="page">
      <section class="hero">
        <h1><i data-lucide="settings" style="vertical-align: middle; margin-right: 8px;"></i>系统设置</h1>
        <p>连接配置、LLM配置、搜索配置统一管理。当前项目上下文：<span id="projectText" class="badge info">default</span></p>
      </section>

      <section class="card" style="margin-bottom: 12px;">
        <h2 class="section-title"><i data-lucide="link-2"></i> 连接配置</h2>
        <div class="grid-2">
          <div class="card"><label>DATABASE_URL</label><input id="DATABASE_URL" /></div>
          <div class="card"><label>ES_URL</label><input id="ES_URL" /></div>
          <div class="card"><label>REDIS_URL</label><input id="REDIS_URL" /></div>
          <div class="card"><label>LLM_PROVIDER</label>
            <select id="LLM_PROVIDER"><option value="openai">openai</option><option value="azure">azure</option><option value="ollama">ollama</option></select>
          </div>
        </div>
      </section>

      <section class="card" style="margin-bottom: 12px;">
        <h2 class="section-title"><i data-lucide="bot"></i> LLM 配置</h2>
        <div class="grid-2">
          <div class="card"><label>OPENAI_API_KEY</label><input id="OPENAI_API_KEY" type="password" /></div>
          <div class="card"><label>OPENAI_API_BASE</label><input id="OPENAI_API_BASE" /></div>
          <div class="card"><label>AZURE_API_KEY</label><input id="AZURE_API_KEY" type="password" /></div>
          <div class="card"><label>AZURE_API_BASE</label><input id="AZURE_API_BASE" /></div>
          <div class="card"><label>AZURE_API_VERSION</label><input id="AZURE_API_VERSION" /></div>
          <div class="card"><label>AZURE_CHAT_DEPLOYMENT</label><input id="AZURE_CHAT_DEPLOYMENT" /></div>
          <div class="card"><label>AZURE_EMBEDDING_DEPLOYMENT</label><input id="AZURE_EMBEDDING_DEPLOYMENT" /></div>
          <div class="card"><label>OLLAMA_BASE_URL</label><input id="OLLAMA_BASE_URL" /></div>
        </div>
      </section>

      <section class="card" style="margin-bottom: 12px;">
        <h2 class="section-title"><i data-lucide="search"></i> 搜索配置</h2>
        <div class="grid-2">
          <div class="card"><label>GOOGLE_SEARCH_API_KEY</label><input id="GOOGLE_SEARCH_API_KEY" type="password" /></div>
          <div class="card"><label>GOOGLE_SEARCH_CSE_ID</label><input id="GOOGLE_SEARCH_CSE_ID" /></div>
          <div class="card"><label>SERPSTACK_KEY</label><input id="SERPSTACK_KEY" type="password" /></div>
          <div class="card"><label>SERPAPI_KEY</label><input id="SERPAPI_KEY" type="password" /></div>
        </div>
      </section>

      <section class="card" style="margin-bottom: 12px;" id="llm-config">
        <h2 class="section-title"><i data-lucide="layout-template"></i> LLM 服务模板配置</h2>
        <div class="toolbar">
          <button id="refreshLlmConfig"><i data-lucide="refresh-cw"></i> 刷新模板</button>
          <select id="copySourceProject" style="min-width: 220px;">
            <option value="">选择源项目（复制模板）</option>
          </select>
          <button id="copyLlmConfig" class="secondary"><i data-lucide="copy"></i> 从源项目复制</button>
        </div>
        <div id="llmConfigWrap"></div>
      </section>

      <section class="card">
        <div class="toolbar">
          <button id="saveEnv"><i data-lucide="save"></i> 保存环境配置</button>
          <button id="reloadEnv" class="secondary"><i data-lucide="rotate-ccw"></i> 重新加载</button>
          <button id="goHome" class="secondary"><i data-lucide="home"></i> 返回主页</button>
        </div>
        <div id="statusMsg" class="status">等待操作</div>
      </section>
    </div>

    <script>
      const { qs, setLoading, setError, setSuccess, setEmpty, escapeHtml } = window.UICore;
      const FIELD_KEYS = [
        "DATABASE_URL", "ES_URL", "REDIS_URL", "LLM_PROVIDER",
        "OPENAI_API_KEY", "OPENAI_API_BASE", "AZURE_API_KEY", "AZURE_API_BASE",
        "AZURE_API_VERSION", "AZURE_CHAT_DEPLOYMENT", "AZURE_EMBEDDING_DEPLOYMENT", "OLLAMA_BASE_URL",
        "SERPAPI_KEY", "SERPSTACK_KEY", "GOOGLE_SEARCH_API_KEY", "GOOGLE_SEARCH_CSE_ID"
      ];

      function collectEnvPayload() {
        const payload = {};
        FIELD_KEYS.forEach((k) => {
          const el = qs(k);
          payload[k] = el ? (el.value || "").trim() : "";
        });
        return payload;
      }

      function fillEnv(data) {
        FIELD_KEYS.forEach((k) => {
          if (!qs(k)) return;
          qs(k).value = data?.[k] ?? "";
        });
      }

      function sanitizeId(raw) {
        return String(raw || "").replace(/[^a-zA-Z0-9_-]/g, "_");
      }

      function toNumberOrNull(value, isInt = false) {
        if (value === null || value === undefined) return null;
        const text = String(value).trim();
        if (!text) return null;
        const num = isInt ? parseInt(text, 10) : parseFloat(text);
        return Number.isFinite(num) ? num : null;
      }

      async function loadEnv() {
        setLoading("statusMsg", "加载配置中...");
        try {
          const data = await window.MarketApp.api.get("/api/v1/config/env");
          fillEnv(data || {});
          setSuccess("statusMsg", "配置加载成功");
        } catch (error) {
          setError("statusMsg", `加载失败: ${error.message}`);
        }
      }

      async function saveEnv() {
        setLoading("statusMsg", "保存配置中...");
        try {
          await window.MarketApp.api.post("/api/v1/config/env", collectEnvPayload());
          setSuccess("statusMsg", "配置保存成功");
        } catch (error) {
          setError("statusMsg", `保存失败: ${error.message}`);
        }
      }

      async function loadProjectOptions() {
        const currentProject = window.MarketApp.getProjectKey();
        try {
          const data = await window.MarketApp.api.get("/api/v1/projects");
          const items = Array.isArray(data?.items) ? data.items : [];
          const options = ['<option value="">选择源项目（复制模板）</option>']
            .concat(
              items
                .filter((item) => item && item.project_key && item.project_key !== currentProject)
                .map((item) => `<option value="${escapeHtml(item.project_key)}">${escapeHtml(item.name || item.project_key)} (${escapeHtml(item.project_key)})</option>`)
            )
            .join("");
          qs("copySourceProject").innerHTML = options;
        } catch (_) {
          qs("copySourceProject").innerHTML = '<option value="">加载项目失败</option>';
        }
      }

      async function loadLlmConfigs() {
        setLoading("llmConfigWrap", "加载LLM模板...");
        try {
          const projectKey = window.MarketApp.getProjectKey();
          const data = await window.MarketApp.api.get(`/api/v1/llm-config/projects/${encodeURIComponent(projectKey)}`);
          const list = Array.isArray(data?.items) ? data.items : [];
          if (!Array.isArray(list) || !list.length) {
            setEmpty("llmConfigWrap", "暂无LLM模板配置");
            return;
          }
          const html = list
            .map((item) => {
              const id = escapeHtml(item.service_name || "-");
              const sid = sanitizeId(item.service_name || "");
              return `
                <article class="card" style="margin-bottom: 10px;">
                  <div class="toolbar">
                    <strong>${id}</strong>
                    ${item.enabled ? '<span class="badge success">启用</span>' : '<span class="badge warning">停用</span>'}
                    <button class="secondary" onclick="saveLlmConfig('${escapeHtml(item.service_name || "")}', '${sid}')">
                      <i data-lucide="save"></i>保存
                    </button>
                  </div>
                  <div class="llm-meta">service: <code>${id}</code></div>
                  <div class="llm-grid">
                    <div>
                      <label>model</label>
                      <input id="llm_${sid}_model" type="text" value="${escapeHtml(item.model || "")}" />
                    </div>
                    <div>
                      <label>enabled</label>
                      <select id="llm_${sid}_enabled">
                        <option value="true" ${item.enabled ? "selected" : ""}>true</option>
                        <option value="false" ${!item.enabled ? "selected" : ""}>false</option>
                      </select>
                    </div>
                    <div>
                      <label>temperature</label>
                      <input id="llm_${sid}_temperature" type="number" step="0.01" value="${escapeHtml(item.temperature ?? "")}" />
                    </div>
                    <div>
                      <label>max_tokens</label>
                      <input id="llm_${sid}_max_tokens" type="number" step="1" value="${escapeHtml(item.max_tokens ?? "")}" />
                    </div>
                    <div>
                      <label>top_p</label>
                      <input id="llm_${sid}_top_p" type="number" step="0.0001" value="${escapeHtml(item.top_p ?? "")}" />
                    </div>
                    <div>
                      <label>presence_penalty</label>
                      <input id="llm_${sid}_presence_penalty" type="number" step="0.0001" value="${escapeHtml(item.presence_penalty ?? "")}" />
                    </div>
                    <div class="full">
                      <label>frequency_penalty</label>
                      <input id="llm_${sid}_frequency_penalty" type="number" step="0.0001" value="${escapeHtml(item.frequency_penalty ?? "")}" />
                    </div>
                    <div class="full">
                      <label>system_prompt</label>
                      <textarea id="llm_${sid}_system_prompt">${escapeHtml(item.system_prompt || "")}</textarea>
                    </div>
                    <div class="full">
                      <label>user_prompt_template</label>
                      <textarea id="llm_${sid}_user_prompt_template">${escapeHtml(item.user_prompt_template || "")}</textarea>
                    </div>
                  </div>
                </article>
              `;
            })
            .join("");
          qs("llmConfigWrap").innerHTML = html;
          if (window.lucide) window.lucide.createIcons();
        } catch (error) {
          setError("llmConfigWrap", `加载失败: ${error.message}`);
        }
      }

      async function saveLlmConfig(serviceName, sid) {
        const projectKey = window.MarketApp.getProjectKey();
        const payload = {
          model: qs(`llm_${sid}_model`)?.value?.trim() || null,
          enabled: qs(`llm_${sid}_enabled`)?.value === "true",
          temperature: toNumberOrNull(qs(`llm_${sid}_temperature`)?.value, false),
          max_tokens: toNumberOrNull(qs(`llm_${sid}_max_tokens`)?.value, true),
          top_p: toNumberOrNull(qs(`llm_${sid}_top_p`)?.value, false),
          presence_penalty: toNumberOrNull(qs(`llm_${sid}_presence_penalty`)?.value, false),
          frequency_penalty: toNumberOrNull(qs(`llm_${sid}_frequency_penalty`)?.value, false),
          system_prompt: qs(`llm_${sid}_system_prompt`)?.value ?? null,
          user_prompt_template: qs(`llm_${sid}_user_prompt_template`)?.value ?? null,
        };
        setLoading("statusMsg", `保存模板中: ${serviceName}`);
        try {
          await window.MarketApp.api.put(
            `/api/v1/llm-config/projects/${encodeURIComponent(projectKey)}/${encodeURIComponent(serviceName)}`,
            payload
          );
          setSuccess("statusMsg", `已保存: ${serviceName}`);
          await loadLlmConfigs();
        } catch (error) {
          setError("statusMsg", `保存失败(${serviceName}): ${error.message}`);
        }
      }

      async function copyLlmConfigs() {
        const projectKey = window.MarketApp.getProjectKey();
        const sourceProject = String(qs("copySourceProject")?.value || "").trim();
        if (!sourceProject) {
          setError("statusMsg", "请先选择源项目");
          return;
        }
        setLoading("statusMsg", "复制模板中...");
        try {
          const result = await window.MarketApp.api.post(
            `/api/v1/llm-config/projects/${encodeURIComponent(projectKey)}/copy-from`,
            { source_project_key: sourceProject, overwrite: false }
          );
          const copied = result?.copied ?? 0;
          const skipped = result?.skipped ?? 0;
          setSuccess("statusMsg", `复制完成：copied=${copied}, skipped=${skipped}`);
          await loadLlmConfigs();
        } catch (error) {
          setError("statusMsg", `复制失败: ${error.message}`);
        }
      }

      qs("saveEnv").addEventListener("click", saveEnv);
      qs("reloadEnv").addEventListener("click", loadEnv);
      qs("refreshLlmConfig").addEventListener("click", loadLlmConfigs);
      qs("copyLlmConfig").addEventListener("click", copyLlmConfigs);
      qs("goHome").addEventListener("click", () => window.MarketApp.navigateInShell("ingest.html"));
      window.saveLlmConfig = saveLlmConfig;

      window.addEventListener("DOMContentLoaded", async () => {
        lucide.createIcons();
        qs("projectText").textContent = window.MarketApp.getProjectKey();
        await Promise.all([loadEnv(), loadProjectOptions(), loadLlmConfigs()]);
        if (window.location.hash === "#llm-config") {
          qs("llm-config").scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    </script>
  </body>
</html>
