<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>数据管理</title>
    <link rel="stylesheet" href="/static/css/app-theme.css" />
    <style>
      body { padding: 0; }
      .page { padding: 24px; max-width: 1200px; margin: 0 auto; }
      .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
      .modal.active { display: flex; }
      .modal-content { background: white; border-radius: 8px; padding: 24px; max-width: 800px; max-height: 90vh; overflow-y: auto; width: 90%; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
      .modal-header h2 { margin: 0; }
      .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
      .content-preview { max-height: 400px; overflow-y: auto; padding: 12px; background: #f9fafb; border-radius: 6px; white-space: pre-wrap; font-size: 12px; }
      .extracted-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-top: 12px; }
      .extracted-section { margin-bottom: 16px; }
      .extracted-section { margin-bottom: 20px; }
      .extracted-section:last-child { margin-bottom: 0; }
      .extracted-section h3 { margin: 0 0 12px 0; font-size: 16px; color: #1f2937; border-bottom: 2px solid #2563eb; padding-bottom: 6px; }
      .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px; }
      .info-item { background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb; }
      .info-item label { display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px; font-weight: 500; }
      .info-item .value { font-size: 14px; color: #1f2937; font-weight: 500; }
      .tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
      .tag-item { background: white; padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; border: 1px solid #e5e7eb; }
      .relation-list { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
      .relation-item { background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 13px; }
      .badge.positive { background: #dcfce7; color: #166534; }
      .badge.negative { background: #fee2e2; color: #991b1b; }
      .badge.neutral { background: #f1f5f9; color: #475569; }
      .doc-row { cursor: pointer; transition: background 0.15s; }
      .doc-row:hover { background: #f8fafc; }
    </style>
    <script src="/static/js/app-shell.js"></script>
    <script src="/static/js/ui-core.js"></script>
    <script src="/static/js/doc-card.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div class="page">
      <section class="hero">
        <h1><i data-lucide="database" style="vertical-align: middle; margin-right: 8px;"></i>数据管理</h1>
        <p>按管理职责组织：文档、结构化结果、图谱导出、搜索历史。</p>
      </section>

      <section class="card" style="margin-bottom: 12px;">
        <div class="toolbar">
          <button class="secondary tab-btn" data-tab="docs"><i data-lucide="file-text"></i> 文档</button>
          <button class="secondary tab-btn" data-tab="extracted"><i data-lucide="puzzle"></i> 结构化结果</button>
          <button class="secondary tab-btn" data-tab="graph"><i data-lucide="share-2"></i> 图谱导出</button>
          <button class="secondary tab-btn" data-tab="history"><i data-lucide="history"></i> 搜索历史</button>
          <button id="refreshTab"><i data-lucide="refresh-cw"></i> 刷新当前页签</button>
        </div>
      </section>

      <section class="card" id="tab-docs">
        <h2 class="section-title">文档管理</h2>
        <div class="toolbar">
          <label>搜索</label><input id="docSearch" placeholder="标题/摘要/URL" />
          <label>类型</label>
          <select id="docType">
            <option value="">全部</option>
            <option value="policy">policy</option>
            <option value="market">market</option>
            <option value="social_sentiment">social_sentiment</option>
            <option value="news">news</option>
          </select>
          <button id="searchDocs">查询</button>
        </div>
        <div id="docsWrap" class="table-wrap"></div>
      </section>

      <section class="card" id="tab-extracted" style="display:none;">
        <h2 class="section-title">结构化结果</h2>
        <div class="toolbar">
          <button id="reloadExtracted">刷新</button>
          <span class="badge info">仅展示带 extracted_data 的文档</span>
        </div>
        <div id="extractedWrap" class="table-wrap"></div>
      </section>

      <section class="card" id="tab-graph" style="display:none;">
        <h2 class="section-title">图谱导出</h2>
        <div class="toolbar">
          <label>文档ID列表（逗号分隔）</label>
          <input id="graphDocIds" placeholder="例如: 101,102,103" style="min-width: 320px;" />
          <button id="exportGraph">导出图谱 JSON</button>
        </div>
        <div id="graphStatus" class="status">输入文档ID后执行导出</div>
      </section>

      <section class="card" id="tab-history" style="display:none;">
        <h2 class="section-title">搜索历史</h2>
        <div id="historyWrap" class="table-wrap"></div>
      </section>
    </div>

    <div id="doc-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="doc-modal-title">文档详情</h2>
          <button class="close-btn" onclick="closeDocModal()">&times;</button>
        </div>
        <div id="doc-modal-body"></div>
      </div>
    </div>

    <script>
      const { qs, setLoading, setError, setEmpty, setSuccess, escapeHtml, toDateTime } = window.UICore;
      let currentTab = "docs";

      function switchTab(tab) {
        currentTab = tab;
        ["docs", "extracted", "graph", "history"].forEach((name) => {
          qs(`tab-${name}`).style.display = name === tab ? "block" : "none";
        });
      }

      async function listDocuments() {
        setLoading("docsWrap", "加载文档中...");
        try {
          const payload = {
            page: 1,
            page_size: 30,
            search: qs("docSearch").value || null,
            doc_type: qs("docType").value || null,
            sort_by: "created_at",
            sort_order: "desc",
          };
          const data = await window.MarketApp.fetchJSON("/api/v1/admin/documents/list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const items = Array.isArray(data?.items) ? data.items : [];
          if (!items.length) {
            setEmpty("docsWrap", "暂无文档");
            return;
          }
          const rows = items.map((d) =>
            `<tr class="doc-row" data-doc-id="${d.id}">
              <td>${d.id}</td>
              <td>${escapeHtml(d.title || "-")}</td>
              <td>${escapeHtml(d.doc_type || "-")}</td>
              <td>${escapeHtml(d.state || "-")}</td>
              <td>${toDateTime(d.publish_date)}</td>
              <td>${d.has_extracted_data ? '<span class="badge success">已提取</span>' : '<span class="badge warning">未提取</span>'}</td>
            </tr>`
          );
          qs("docsWrap").innerHTML = `<table><thead><tr><th>ID</th><th>标题</th><th>类型</th><th>区域</th><th>发布时间</th><th>提取状态</th></tr></thead><tbody>${rows.join("")}</tbody></table>`;
        } catch (error) {
          setError("docsWrap", `加载失败: ${error.message}`);
        }
      }

      async function listExtracted() {
        setLoading("extractedWrap", "加载结构化结果...");
        try {
          const data = await window.MarketApp.fetchJSON("/api/v1/admin/documents/list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ page: 1, page_size: 100, sort_by: "created_at", sort_order: "desc" }),
          });
          const items = (Array.isArray(data?.items) ? data.items : []).filter((x) => x.has_extracted_data);
          if (!items.length) {
            setEmpty("extractedWrap", "暂无已提取文档");
            return;
          }
          const rows = items.slice(0, 50).map((d) =>
            `<tr class="doc-row" data-doc-id="${d.id}">
              <td>${d.id}</td>
              <td>${escapeHtml(d.title || "-")}</td>
              <td>${escapeHtml(d.doc_type || "-")}</td>
              <td>${toDateTime(d.updated_at || d.created_at)}</td>
            </tr>`
          );
          qs("extractedWrap").innerHTML = `<table><thead><tr><th>ID</th><th>标题</th><th>类型</th><th>最近更新时间</th></tr></thead><tbody>${rows.join("")}</tbody></table>`;
        } catch (error) {
          setError("extractedWrap", `加载失败: ${error.message}`);
        }
      }

      async function loadSearchHistory() {
        setLoading("historyWrap", "加载搜索历史...");
        try {
          const data = await window.MarketApp.fetchJSON("/api/v1/admin/search-history?limit=100");
          const items = Array.isArray(data?.items) ? data.items : [];
          if (!items.length) {
            setEmpty("historyWrap", "暂无搜索历史");
            return;
          }
          const rows = items
            .map(
              (h) => `<tr>
                <td>${h.id}</td>
                <td>${escapeHtml(h.topic || "-")}</td>
                <td>${toDateTime(h.last_search_time)}</td>
                <td>${toDateTime(h.created_at)}</td>
              </tr>`
            )
            .join("");
          qs("historyWrap").innerHTML = `<table><thead><tr><th>ID</th><th>主题</th><th>最后搜索</th><th>创建时间</th></tr></thead><tbody>${rows}</tbody></table>`;
        } catch (error) {
          setError("historyWrap", `加载失败: ${error.message}`);
        }
      }

      async function exportGraph() {
        const raw = qs("graphDocIds").value.trim();
        if (!raw) {
          setError("graphStatus", "请先输入文档ID");
          return;
        }
        setLoading("graphStatus", "正在导出图谱...");
        try {
          const url = `/api/v1/admin/export-graph?doc_ids=${encodeURIComponent(raw)}`;
          const data = await window.MarketApp.fetchJSON(url);
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `content-graph-${Date.now()}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setSuccess("graphStatus", `导出成功，节点 ${data?.nodes?.length || 0}，边 ${data?.edges?.length || 0}`);
        } catch (error) {
          setError("graphStatus", `导出失败: ${error.message}`);
        }
      }

      async function refreshCurrentTab() {
        if (currentTab === "docs") return listDocuments();
        if (currentTab === "extracted") return listExtracted();
        if (currentTab === "history") return loadSearchHistory();
        return Promise.resolve();
      }

      async function showDocument(id) {
        qs("doc-modal-body").innerHTML = "<div class='status'>加载中...</div>";
        qs("doc-modal-title").textContent = `文档详情 #${id}`;
        qs("doc-modal").classList.add("active");
        try {
          const doc = await window.MarketApp.fetchJSON(`/api/v1/admin/documents/${id}`);
          let extractedData = doc.extracted_data;
          if (typeof extractedData === "string") {
            try { extractedData = JSON.parse(extractedData); } catch { extractedData = null; }
          }
          const bodyHtml = `
            <div><strong>标题:</strong> ${escapeHtml(doc.title || "(无)")}</div>
            <div style="margin-top: 12px;"><strong>类型:</strong> <span class="badge">${escapeHtml(doc.doc_type || "-")}</span></div>
            <div style="margin-top: 12px;"><strong>区域:</strong> ${escapeHtml(doc.state || "-")}</div>
            <div style="margin-top: 12px;"><strong>URL:</strong> <a href="${escapeHtml(doc.uri || "#")}" target="_blank" class="link">${escapeHtml(doc.uri || "-")}</a></div>
            <div style="margin-top: 12px;"><strong>摘要:</strong> ${escapeHtml((doc.summary || "").substring(0, 500))}${(doc.summary || "").length > 500 ? "..." : ""}</div>
            ${doc.content ? `<div style="margin-top: 12px;"><strong>内容:</strong><div class="content-preview">${escapeHtml(doc.content.substring(0, 3000))}${doc.content.length > 3000 ? "..." : ""}</div></div>` : ""}
            ${window.renderGraphExtractedCard ? window.renderGraphExtractedCard(extractedData || {}, escapeHtml) : ''}
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">
              <div><strong>发布时间:</strong> ${toDateTime(doc.publish_date)}</div>
              <div style="margin-top: 8px;"><strong>创建时间:</strong> ${toDateTime(doc.created_at)}</div>
              <div style="margin-top: 8px;"><strong>更新时间:</strong> ${toDateTime(doc.updated_at)}</div>
            </div>
          `;
          qs("doc-modal-body").innerHTML = bodyHtml;
        } catch (err) {
          qs("doc-modal-body").innerHTML = `<div class="error">加载失败: ${escapeHtml(err.message)}</div>`;
        }
      }

      function closeDocModal() {
        qs("doc-modal").classList.remove("active");
      }
      qs("doc-modal").addEventListener("click", (e) => { if (e.target.id === "doc-modal") closeDocModal(); });

      [qs("docsWrap"), qs("extractedWrap")].forEach((wrap) => {
        if (!wrap) return;
        wrap.addEventListener("click", (e) => {
          const row = e.target.closest(".doc-row");
          if (!row) return;
          e.preventDefault();
          const docId = row.dataset.docId;
          if (docId) showDocument(docId);
        });
      });

      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          switchTab(btn.dataset.tab);
          await refreshCurrentTab();
        });
      });
      qs("refreshTab").addEventListener("click", refreshCurrentTab);
      qs("searchDocs").addEventListener("click", listDocuments);
      qs("reloadExtracted").addEventListener("click", listExtracted);
      qs("exportGraph").addEventListener("click", exportGraph);

      window.addEventListener("DOMContentLoaded", async () => {
        lucide.createIcons();
        const hash = (window.location.hash || "").replace("#", "");
        if (hash === "extracted") switchTab("extracted");
        await refreshCurrentTab();
      });
    </script>
  </body>
</html>
