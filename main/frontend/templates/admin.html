<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>数据管理</title>
    <link rel="stylesheet" href="/static/css/app-theme.css" />
    <style>
      body { padding: 0; }
      .page { padding: 24px; max-width: 1200px; margin: 0 auto; }
      .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
      .modal.active { display: flex; }
      .modal-content { background: white; border-radius: 8px; padding: 24px; max-width: 800px; max-height: 90vh; overflow-y: auto; width: 90%; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
      .modal-header h2 { margin: 0; }
      .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
      .content-preview { max-height: 400px; overflow-y: auto; padding: 12px; background: #f9fafb; border-radius: 6px; white-space: pre-wrap; font-size: 12px; }
      .extracted-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-top: 12px; }
      .extracted-section { margin-bottom: 16px; }
      .extracted-section { margin-bottom: 20px; }
      .extracted-section:last-child { margin-bottom: 0; }
      .extracted-section h3 { margin: 0 0 12px 0; font-size: 16px; color: #1f2937; border-bottom: 2px solid #2563eb; padding-bottom: 6px; }
      .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px; }
      .info-item { background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb; }
      .info-item label { display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px; font-weight: 500; }
      .info-item .value { font-size: 14px; color: #1f2937; font-weight: 500; }
      .tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
      .tag-item { background: white; padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; border: 1px solid #e5e7eb; }
      .relation-list { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
      .relation-item { background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 13px; }
      .badge.positive { background: #dcfce7; color: #166534; }
      .badge.negative { background: #fee2e2; color: #991b1b; }
      .badge.neutral { background: #f1f5f9; color: #475569; }
      .doc-row { cursor: pointer; transition: background 0.15s; }
      .doc-row:hover { background: #f8fafc; }
      .manual-json { width: 100%; min-height: 220px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
      .manual-status { margin-left: 8px; font-size: 12px; color: #6b7280; }
      .manual-status.ok { color: #166534; }
      .manual-status.err { color: #991b1b; }
    </style>
    <script src="/static/js/app-shell.js"></script>
    <script src="/static/js/ui-core.js"></script>
    <script src="/static/js/ui-cards.js"></script>
    <script src="/static/js/doc-card.js?v=20260226"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div class="page">
      <section class="hero">
        <h1><i data-lucide="database" style="vertical-align: middle; margin-right: 8px;"></i>数据管理</h1>
        <p>按管理职责组织：文档、结构化结果、图谱导出、搜索历史。</p>
      </section>

      <section class="card" style="margin-bottom: 12px;">
        <div class="toolbar">
          <button class="secondary tab-btn" data-tab="docs"><i data-lucide="file-text"></i> 文档</button>
          <button class="secondary tab-btn" data-tab="extracted"><i data-lucide="puzzle"></i> 结构化结果</button>
          <button class="secondary tab-btn" data-tab="graph"><i data-lucide="share-2"></i> 图谱导出</button>
          <button class="secondary tab-btn" data-tab="history"><i data-lucide="history"></i> 搜索历史</button>
          <button id="refreshTab"><i data-lucide="refresh-cw"></i> 刷新当前页签</button>
        </div>
      </section>

      <section class="card" id="tab-docs">
        <h2 class="section-title">文档管理</h2>
        <div class="toolbar">
          <label>搜索</label><input id="docSearch" placeholder="标题/摘要/URL" />
          <label>类型</label>
          <select id="docType">
            <option value="">全部</option>
            <option value="policy">policy</option>
            <option value="market">market</option>
            <option value="social_sentiment">social_sentiment</option>
            <option value="news">news</option>
          </select>
          <button id="searchDocs">查询</button>
        </div>
        <div id="docsWrap" class="table-wrap"></div>
      </section>

      <section class="card" id="tab-extracted" style="display:none;">
        <h2 class="section-title">结构化结果</h2>
        <div class="toolbar">
          <button id="reloadExtracted">刷新</button>
          <button id="reextractStructuredFill" class="secondary"><i data-lucide="sparkles"></i>重提取结构化信息（补齐）</button>
          <button id="reextractStructuredForce" class="secondary"><i data-lucide="wand-2"></i>重提取结构化信息（强制）</button>
          <button id="topicExtractFill" class="secondary"><i data-lucide="network"></i>专题析取（补齐）</button>
          <button id="topicExtractForce" class="secondary"><i data-lucide="zap"></i>专题析取（强制）</button>
          <span class="badge info">仅展示带 extracted_data 的文档</span>
        </div>
        <div id="reextractStatus" class="status" style="margin-bottom: 8px;">当前项目文档结构化信息重提取（主干统一结构化提取）</div>
        <div id="topicExtractStatus" class="status" style="margin-bottom: 8px;">专题析取（company / product / operation）</div>
        <div id="extractedWrap" class="table-wrap"></div>
        <div class="card" style="margin-top: 12px;">
          <h3 class="section-title">批量手动结构化</h3>
          <p class="muted">对多条文档写入/合并相同的 extracted_data。ID 逗号或空格分隔。</p>
          <div class="toolbar">
            <label for="bulkDocIds">文档ID</label>
            <input id="bulkDocIds" placeholder="如 101,102  或  101 102" style="min-width: 260px;" />
            <button id="btnBulkFormat" class="secondary">格式化 JSON</button>
            <button id="btnBulkValidate" class="secondary">校验 JSON</button>
          </div>
          <textarea id="bulkExtractedEditor" class="manual-json" placeholder='示例: { \"policy\": { \"state\": \"CA\" } }'></textarea>
          <div class="toolbar" style="margin-top: 8px;">
            <button id="btnBulkSaveReplace"><i data-lucide="save"></i>保存(替换)</button>
            <button id="btnBulkSaveMerge" class="secondary">保存(合并)</button>
            <button id="btnBulkClear" class="secondary">清空 extracted_data</button>
            <span id="bulkStatus" class="manual-status"></span>
          </div>
        </div>
      </section>

      <section class="card" id="tab-graph" style="display:none;">
        <h2 class="section-title">图谱导出</h2>
        <div class="toolbar">
          <label>文档ID列表（逗号分隔）</label>
          <input id="graphDocIds" placeholder="例如: 101,102,103" style="min-width: 320px;" />
          <button id="exportGraph">导出图谱 JSON</button>
        </div>
        <div id="graphStatus" class="status">输入文档ID后执行导出</div>
      </section>

      <section class="card" id="tab-history" style="display:none;">
        <h2 class="section-title">搜索历史</h2>
        <div id="historyWrap" class="table-wrap"></div>
      </section>
    </div>

    <div id="doc-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="doc-modal-title">文档详情</h2>
          <button class="close-btn" onclick="closeDocModal()">&times;</button>
        </div>
        <div id="doc-modal-body"></div>
      </div>
    </div>

    <script>
      const { qs, setLoading, setError, setEmpty, setSuccess, escapeHtml, toDateTime } = window.UICore;
      let currentTab = "docs";
      let docsPage = 1;
      let docsPageSize = 30;
      let docsTotal = 0;
      let docsTotalPages = 1;
      let extractedPage = 1;
      let extractedPageSize = 30;
      let extractedTotal = 0;
      let extractedTotalPages = 1;
      let historyPage = 1;
      let historyPageSize = 30;
      let historyTotal = 0;
      let historyTotalPages = 1;

      function switchTab(tab) {
        currentTab = tab;
        ["docs", "extracted", "graph", "history"].forEach((name) => {
          qs(`tab-${name}`).style.display = name === tab ? "block" : "none";
        });
      }

      async function listDocuments(page = docsPage) {
        docsPage = Math.max(1, Number(page) || 1);
        setLoading("docsWrap", "加载文档中...");
        try {
          const payload = {
            page: docsPage,
            page_size: docsPageSize,
            search: qs("docSearch").value || null,
            doc_type: qs("docType").value || null,
            sort_by: "created_at",
            sort_order: "desc",
          };
          const data = await window.MarketApp.fetchJSON("/api/v1/admin/documents/list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const items = Array.isArray(data?.items) ? data.items : [];
          docsTotal = Number(data?.total || 0);
          docsPageSize = Number(data?.page_size || docsPageSize || 30);
          docsTotalPages = Math.max(1, Math.ceil(docsTotal / docsPageSize));
          if (!items.length && docsTotal > 0 && docsPage > docsTotalPages) {
            docsPage = docsTotalPages;
            return listDocuments(docsPage);
          }
          if (!items.length) {
            setEmpty("docsWrap", "暂无文档");
            return;
          }
          const rows = items.map((d) =>
            `<tr class="doc-row" data-doc-id="${d.id}">
              <td>${d.id}</td>
              <td>${escapeHtml(d.title || "-")}</td>
              <td>${escapeHtml(d.doc_type || "-")}</td>
              <td>${escapeHtml(d.state || "-")}</td>
              <td>${toDateTime(d.publish_date)}</td>
              <td>${d.has_extracted_data ? '<span class="badge success">已提取</span>' : '<span class="badge warning">未提取</span>'}</td>
            </tr>`
          );
          qs("docsWrap").innerHTML = `
            <table>
              <thead><tr><th>ID</th><th>标题</th><th>类型</th><th>区域</th><th>发布时间</th><th>提取状态</th></tr></thead>
              <tbody>${rows.join("")}</tbody>
            </table>
            <div class="toolbar" style="margin-top: 10px; justify-content: space-between;">
              <span class="muted">第 ${docsPage}/${docsTotalPages} 页，共 ${docsTotal} 条</span>
              <div>
                <button id="docsPrevPage" class="secondary" ${docsPage <= 1 ? "disabled" : ""}>上一页</button>
                <button id="docsNextPage" class="secondary" ${docsPage >= docsTotalPages ? "disabled" : ""}>下一页</button>
              </div>
            </div>
          `;
          qs("docsPrevPage")?.addEventListener("click", () => listDocuments(docsPage - 1));
          qs("docsNextPage")?.addEventListener("click", () => listDocuments(docsPage + 1));
        } catch (error) {
          setError("docsWrap", `加载失败: ${error.message}`);
        }
      }

      async function listExtracted(page = extractedPage) {
        extractedPage = Math.max(1, Number(page) || 1);
        setLoading("extractedWrap", "加载结构化结果...");
        try {
          const data = await window.MarketApp.fetchJSON("/api/v1/admin/documents/list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              page: extractedPage,
              page_size: extractedPageSize,
              has_extracted_data: true,
              sort_by: "created_at",
              sort_order: "desc",
            }),
          });
          const items = Array.isArray(data?.items) ? data.items : [];
          extractedTotal = Number(data?.total || 0);
          extractedPageSize = Number(data?.page_size || extractedPageSize || 30);
          extractedTotalPages = Math.max(1, Math.ceil(extractedTotal / extractedPageSize));
          if (!items.length && extractedTotal > 0 && extractedPage > extractedTotalPages) {
            extractedPage = extractedTotalPages;
            return listExtracted(extractedPage);
          }
          if (!items.length) {
            setEmpty("extractedWrap", "暂无已提取文档");
            return;
          }
          const rows = items.map((d) =>
            `<tr class="doc-row" data-doc-id="${d.id}">
              <td>${d.id}</td>
              <td>${escapeHtml(d.title || "-")}</td>
              <td>${escapeHtml(d.doc_type || "-")}</td>
              <td>${toDateTime(d.updated_at || d.created_at)}</td>
            </tr>`
          );
          qs("extractedWrap").innerHTML = `
            <table>
              <thead><tr><th>ID</th><th>标题</th><th>类型</th><th>最近更新时间</th></tr></thead>
              <tbody>${rows.join("")}</tbody>
            </table>
            <div class="toolbar" style="margin-top: 10px; justify-content: space-between;">
              <span class="muted">第 ${extractedPage}/${extractedTotalPages} 页，共 ${extractedTotal} 条</span>
              <div>
                <button id="extractedPrevPage" class="secondary" ${extractedPage <= 1 ? "disabled" : ""}>上一页</button>
                <button id="extractedNextPage" class="secondary" ${extractedPage >= extractedTotalPages ? "disabled" : ""}>下一页</button>
              </div>
            </div>
          `;
          qs("extractedPrevPage")?.addEventListener("click", () => listExtracted(extractedPage - 1));
          qs("extractedNextPage")?.addEventListener("click", () => listExtracted(extractedPage + 1));
        } catch (error) {
          setError("extractedWrap", `加载失败: ${error.message}`);
        }
      }

      async function reextractStructuredDocuments(force = false) {
        const pk = window.MarketApp?.getProjectKey?.() || "";
        const url = pk
          ? `/api/v1/admin/documents/re-extract?project_key=${encodeURIComponent(pk)}`
          : "/api/v1/admin/documents/re-extract";
        const statusId = "reextractStatus";
        setLoading(statusId, force ? "正在强制重提取结构化信息..." : "正在补齐结构化信息...");
        try {
          const resp = await window.MarketApp.fetchJSON(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              force: !!force,
              fetch_missing_content: true,
              batch_size: 5,
              treat_empty_er_as_missing: true,
            }),
          });
          const r = resp?.data || resp || {};
          setSuccess(
            statusId,
            `完成：扫描 ${Number(r.total || 0)}，成功 ${Number(r.success || 0)}，跳过 ${Number(r.skipped || 0)}，错误 ${Number(r.error || 0)}`
          );
          await listExtracted();
        } catch (error) {
          setError(statusId, `重提取失败: ${error.message}`);
        }
      }

      async function topicExtractDocuments(force = false) {
        const pk = window.MarketApp?.getProjectKey?.() || "";
        const url = pk
          ? `/api/v1/admin/documents/topic-extract?project_key=${encodeURIComponent(pk)}`
          : "/api/v1/admin/documents/topic-extract";
        const statusId = "topicExtractStatus";
        setLoading(statusId, force ? "正在强制专题析取..." : "正在专题析取（补齐）...");
        try {
          const resp = await window.MarketApp.fetchJSON(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              topics: ["company", "product", "operation"],
              force: !!force,
              fetch_missing_content: true,
              batch_size: 5,
              limit: 100,
              candidate_mode: "rules_then_llm",
            }),
          });
          const r = resp?.data || resp || {};
          const hits = r.topic_hits || {};
          setSuccess(
            statusId,
            `完成：扫描 ${Number(r.total || 0)}，成功 ${Number(r.success || 0)}，跳过 ${Number(r.skipped || 0)}，错误 ${Number(r.error || 0)}；命中 company=${Number(hits.company || 0)} product=${Number(hits.product || 0)} operation=${Number(hits.operation || 0)}`
          );
          await listExtracted();
        } catch (error) {
          setError(statusId, `专题析取失败: ${error.message}`);
        }
      }

      function parseIds(raw) {
        return (raw || "")
          .split(/[^0-9]+/)
          .map((s) => Number(s))
          .filter((n) => Number.isInteger(n));
      }

      function setupBulkEditor() {
        const editor = qs("bulkExtractedEditor");
        const status = qs("bulkStatus");
        const idsInput = qs("bulkDocIds");
        if (!editor || !status || !idsInput) return;

        function setStatus(msg, kind) {
          status.textContent = msg || "";
          status.className = `manual-status ${kind || ""}`.trim();
        }

        function parseEditorJSON() {
          const raw = String(editor.value || "").trim();
          if (!raw) return null;
          return JSON.parse(raw);
        }

        function formatEditor(val) {
          editor.value = val == null ? "" : JSON.stringify(val, null, 2);
        }

        function setDisabled(disabled) {
          ["btnBulkFormat", "btnBulkValidate", "btnBulkSaveReplace", "btnBulkSaveMerge", "btnBulkClear"].forEach((id) => {
            const el = qs(id);
            if (el) el.disabled = !!disabled;
          });
        }

        qs("btnBulkFormat")?.addEventListener("click", () => {
          try {
            const val = parseEditorJSON();
            formatEditor(val);
            setStatus("JSON 格式化完成", "ok");
          } catch (e) {
            setStatus(`JSON 无法解析: ${e.message || e}`, "err");
          }
        });

        qs("btnBulkValidate")?.addEventListener("click", () => {
          try {
            parseEditorJSON();
            setStatus("JSON 校验通过", "ok");
          } catch (e) {
            setStatus(`JSON 无法解析: ${e.message || e}`, "err");
          }
        });

        async function save(mode, clearOnly = false) {
          const ids = parseIds(idsInput.value);
          if (!ids.length) {
            setStatus("请先输入文档ID", "err");
            return;
          }
          setDisabled(true);
          try {
            const val = clearOnly ? null : parseEditorJSON();
            if (mode === "merge" && val == null) {
              throw new Error("merge 模式需要非空 JSON 对象");
            }
            const res = await window.MarketApp.fetchJSON("/api/v1/admin/documents/bulk/extracted-data", {
              method: "POST",
              body: { doc_ids: ids, mode, extracted_data: val },
            });
            setStatus(`完成: 请求 ${res?.requested ?? ids.length}，更新 ${res?.updated ?? 0}，缺失 ${Array.isArray(res?.missing) ? res.missing.length : 0}`, "ok");
          } catch (e) {
            setStatus(`保存失败: ${e.message || e}`, "err");
          } finally {
            setDisabled(false);
          }
        }

        qs("btnBulkSaveReplace")?.addEventListener("click", () => save("replace"));
        qs("btnBulkSaveMerge")?.addEventListener("click", () => save("merge"));
        qs("btnBulkClear")?.addEventListener("click", () => save("replace", true));
      }

      async function loadSearchHistory(page = historyPage) {
        historyPage = Math.max(1, Number(page) || 1);
        setLoading("historyWrap", "加载搜索历史...");
        try {
          const params = new URLSearchParams({
            page: String(historyPage),
            page_size: String(historyPageSize),
          });
          const data = await window.MarketApp.fetchJSON(`/api/v1/admin/search-history?${params.toString()}`);
          const items = Array.isArray(data?.items) ? data.items : [];
          historyTotal = Number(data?.total || 0);
          historyPageSize = Number(data?.page_size || historyPageSize || 30);
          historyTotalPages = Math.max(1, Math.ceil(historyTotal / historyPageSize));
          if (!items.length && historyTotal > 0 && historyPage > historyTotalPages) {
            historyPage = historyTotalPages;
            return loadSearchHistory(historyPage);
          }
          if (!items.length) {
            setEmpty("historyWrap", "暂无搜索历史");
            return;
          }
          const rows = items
            .map(
              (h) => `<tr>
                <td>${h.id}</td>
                <td>${escapeHtml(h.topic || "-")}</td>
                <td>${toDateTime(h.last_search_time)}</td>
              </tr>`
            )
            .join("");
          qs("historyWrap").innerHTML = `
            <table><thead><tr><th>ID</th><th>主题</th><th>最后搜索</th></tr></thead><tbody>${rows}</tbody></table>
            <div class="toolbar" style="margin-top: 10px; justify-content: space-between;">
              <span class="muted">第 ${historyPage}/${historyTotalPages} 页，共 ${historyTotal} 条</span>
              <div>
                <button id="historyPrevPage" class="secondary" ${historyPage <= 1 ? "disabled" : ""}>上一页</button>
                <button id="historyNextPage" class="secondary" ${historyPage >= historyTotalPages ? "disabled" : ""}>下一页</button>
              </div>
            </div>
          `;
          qs("historyPrevPage")?.addEventListener("click", () => loadSearchHistory(historyPage - 1));
          qs("historyNextPage")?.addEventListener("click", () => loadSearchHistory(historyPage + 1));
        } catch (error) {
          setError("historyWrap", `加载失败: ${error.message}`);
        }
      }

      async function exportGraph() {
        const raw = qs("graphDocIds").value.trim();
        if (!raw) {
          setError("graphStatus", "请先输入文档ID");
          return;
        }
        setLoading("graphStatus", "正在导出图谱...");
        try {
          const url = `/api/v1/admin/export-graph?doc_ids=${encodeURIComponent(raw)}`;
          const data = await window.MarketApp.fetchJSON(url);
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `content-graph-${Date.now()}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setSuccess("graphStatus", `导出成功，节点 ${data?.nodes?.length || 0}，边 ${data?.edges?.length || 0}`);
        } catch (error) {
          setError("graphStatus", `导出失败: ${error.message}`);
        }
      }

      async function refreshCurrentTab() {
        if (currentTab === "docs") return listDocuments();
        if (currentTab === "extracted") return listExtracted();
        if (currentTab === "history") return loadSearchHistory();
        return Promise.resolve();
      }

      async function showDocument(id) {
        qs("doc-modal-body").innerHTML = "<div class='status'>加载中...</div>";
        qs("doc-modal-title").textContent = `文档详情 #${id}`;
        qs("doc-modal").classList.add("active");
        try {
          const doc = await window.MarketApp.fetchJSON(`/api/v1/admin/documents/${id}`);
          let extractedData = doc.extracted_data;
          if (typeof extractedData === "string") {
            try { extractedData = JSON.parse(extractedData); } catch { extractedData = null; }
          }
          const metaCardHtml = window.UICards?.renderSectionCard
            ? window.UICards.renderSectionCard({
                title: "文档基础信息",
                compact: true,
                metrics: [
                  { label: "标题", value: doc.title || "(无)" },
                  { label: "类型", html: `<span class=\"badge\">${escapeHtml(doc.doc_type || "-")}</span>` },
                  { label: "区域", value: doc.state || "-" },
                  { label: "URL", html: doc.uri ? `<a href=\"${escapeHtml(doc.uri)}\" target=\"_blank\" class=\"link\">${escapeHtml(doc.uri)}</a>` : "-" },
                ]
              })
            : "";
          const bodyHtml = `
            ${metaCardHtml || `
              <div><strong>标题:</strong> ${escapeHtml(doc.title || "(无)")}</div>
              <div style="margin-top: 12px;"><strong>类型:</strong> <span class="badge">${escapeHtml(doc.doc_type || "-")}</span></div>
              <div style="margin-top: 12px;"><strong>区域:</strong> ${escapeHtml(doc.state || "-")}</div>
              <div style="margin-top: 12px;"><strong>URL:</strong> <a href="${escapeHtml(doc.uri || "#")}" target="_blank" class="link">${escapeHtml(doc.uri || "-")}</a></div>
            `}
            <div style="margin-top: 12px;"><strong>摘要:</strong> ${escapeHtml((doc.summary || "").substring(0, 500))}${(doc.summary || "").length > 500 ? "..." : ""}</div>
            <div id="docExtractedPreview">
              ${
                window.renderGraphExtractedCard
                  ? (window.renderGraphExtractedCard(extractedData || {}, escapeHtml) || '<div class="empty">暂无结构化数据</div>')
                  : '<div class="empty">暂无结构化数据</div>'
              }
            </div>
            ${doc.content ? `<div style="margin-top: 12px;"><strong>内容:</strong><div class="content-preview">${escapeHtml(doc.content.substring(0, 3000))}${doc.content.length > 3000 ? "..." : ""}</div></div>` : ""}
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">
              <div><strong>发布时间:</strong> ${toDateTime(doc.publish_date)}</div>
              <div style="margin-top: 8px;"><strong>创建时间:</strong> ${toDateTime(doc.created_at)}</div>
              <div style="margin-top: 8px;"><strong>更新时间:</strong> ${toDateTime(doc.updated_at)}</div>
            </div>
          `;
          qs("doc-modal-body").innerHTML = bodyHtml;
          window.enhanceExtractedCardTabs?.(qs("doc-modal-body"));
          if (window.lucide) window.lucide.createIcons();
        } catch (err) {
          qs("doc-modal-body").innerHTML = `<div class="error">加载失败: ${escapeHtml(err.message)}</div>`;
        }
      }

      function closeDocModal() {
        qs("doc-modal").classList.remove("active");
      }
      qs("doc-modal").addEventListener("click", (e) => { if (e.target.id === "doc-modal") closeDocModal(); });

      [qs("docsWrap"), qs("extractedWrap")].forEach((wrap) => {
        if (!wrap) return;
        wrap.addEventListener("click", (e) => {
          const row = e.target.closest(".doc-row");
          if (!row) return;
          e.preventDefault();
          const docId = row.dataset.docId;
          if (docId) showDocument(docId);
        });
      });

      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          switchTab(btn.dataset.tab);
          await refreshCurrentTab();
        });
      });
      qs("refreshTab").addEventListener("click", refreshCurrentTab);
      qs("searchDocs").addEventListener("click", () => {
        docsPage = 1;
        listDocuments(1);
      });
      qs("docSearch")?.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;
        docsPage = 1;
        listDocuments(1);
      });
      qs("docType")?.addEventListener("change", () => {
        docsPage = 1;
        listDocuments(1);
      });
      qs("reloadExtracted").addEventListener("click", () => listExtracted(extractedPage));
      qs("reextractStructuredFill")?.addEventListener("click", () => reextractStructuredDocuments(false));
      qs("reextractStructuredForce")?.addEventListener("click", async () => {
        if (!confirm("确认强制重提取当前项目的可结构化文档？这会重新调用LLM，耗时较长。")) return;
        await reextractStructuredDocuments(true);
      });
      qs("topicExtractFill")?.addEventListener("click", () => topicExtractDocuments(false));
      qs("topicExtractForce")?.addEventListener("click", async () => {
        if (!confirm("确认强制专题析取当前项目文档？这会重新调用LLM，耗时较长。")) return;
        await topicExtractDocuments(true);
      });
      qs("exportGraph").addEventListener("click", exportGraph);

      window.addEventListener("DOMContentLoaded", async () => {
        lucide.createIcons();
        const hash = (window.location.hash || "").replace("#", "");
        if (hash === "extracted") switchTab("extracted");
        setupBulkEditor();
        await refreshCurrentTab();
      });
    </script>
  </body>
</html>
