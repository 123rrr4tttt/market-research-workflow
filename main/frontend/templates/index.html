<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>市场信息工作台首页</title>
    <link rel="stylesheet" href="/static/css/app-theme.css" />
    <style>
      /* 确保 iframe 内的 body 没有 padding，由 .page 控制 */
      body { padding: 0; }
      .page { padding: 24px; max-width: 1200px; margin: 0 auto; }
      .hint { color: var(--text-muted); font-size: 12px; margin-top: 6px; }
      .toolbar select[multiple] { min-width: 220px; min-height: 92px; }
      .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
      .modal-overlay.active { display: flex; }
      .modal-overlay .modal-content { background: var(--card-bg, #fff); border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
      .modal-overlay h3 { margin: 0 0 8px 0; }
      .ingest-partition { padding: 16px 0; border-bottom: 1px solid var(--border, #e2e8f0); }
      .ingest-partition:last-of-type { border-bottom: none; padding-bottom: 0; }
      .partition-title { margin: 0 0 12px 0; font-size: 15px; font-weight: 600; color: var(--text, #1e293b); }
      .multi-select { position: relative; display: inline-block; min-width: 96px; }
      .multi-select-btn {
        min-width: 96px;
        height: 32px;
        border: 1px solid var(--border, #d0d7de);
        border-radius: 6px;
        background: var(--card-bg, #fff);
        color: var(--text, #111827);
        padding: 0 10px;
        text-align: left;
        cursor: pointer;
      }
      .multi-select-panel {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        min-width: 120px;
        background: var(--card-bg, #fff);
        border: 1px solid var(--border, #d0d7de);
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        padding: 6px 8px;
        z-index: 100;
        display: none;
      }
      .multi-select.open .multi-select-panel { display: block; }
      .multi-select-panel label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        padding: 4px 2px;
        cursor: pointer;
      }
    </style>
    <script src="/static/js/app-shell.js"></script>
    <script src="/static/js/ui-core.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div class="page">
      <section class="hero">
        <h1><i data-lucide="layout" style="vertical-align: middle; margin-right: 8px;"></i>市场信息工作台</h1>
        <p>业务层覆盖宏观政策、行业公司、商品、电商价格、舆情；操作层覆盖采集、提取、分析、看板、管理。</p>
      </section>

      <section class="card" style="margin-bottom: 12px;">
        <h2 class="section-title">业务域总览</h2>
        <div class="grid-4">
          <article class="card">
            <div class="badge info"><i data-lucide="scroll-text" style="width: 14px; height: 14px; margin-right: 4px;"></i> 宏观政策</div>
            <p>政策动态、监管变动、区域法规跟踪</p>
          </article>
          <article class="card">
            <div class="badge info"><i data-lucide="factory" style="width: 14px; height: 14px; margin-right: 4px;"></i> 行业公司</div>
            <p>重点公司事件、行业新闻与主题聚合</p>
          </article>
          <article class="card">
            <div class="badge info"><i data-lucide="package" style="width: 14px; height: 14px; margin-right: 4px;"></i> 商品</div>
            <p>商品指标历史与趋势采集</p>
          </article>
          <article class="card">
            <div class="badge info"><i data-lucide="shopping-cart" style="width: 14px; height: 14px; margin-right: 4px;"></i> 电商价格与舆情</div>
            <p>电商价格观测与社交情绪变化</p>
          </article>
        </div>
      </section>

      <section class="card" style="margin-bottom: 12px;" id="ingest">
        <h2 class="section-title">采集快捷入口</h2>

        <div class="ingest-partition">
          <h3 class="partition-title"><i data-lucide="database" style="width: 16px; height: 16px; vertical-align: middle;"></i> 来源库查询</h3>
          <div class="toolbar">
            <label for="sourceLibraryItem">来源库项</label>
            <select id="sourceLibraryItem" style="min-width: 320px;"></select>
            <button id="btnSyncSourceLibrary" class="btn">同步来源库</button>
            <button id="btnRunSourceLibraryItem" class="btn btn-primary">运行来源库项</button>
            <button id="btnPolicy"><i data-lucide="download-cloud"></i> 政策采集</button>
          </div>
          <p class="hint">选择来源库项执行采集；政策采集依赖所选来源库项的 state 配置。</p>
        </div>

        <div class="ingest-partition">
          <h3 class="partition-title"><i data-lucide="search" style="width: 16px; height: 16px; vertical-align: middle;"></i> 一般查询</h3>
          <div class="toolbar">
            <label for="queryTerms">查询词</label>
            <input id="queryTerms" placeholder="输入查询词，逗号分隔" style="min-width: 280px;" />
            <button id="btnSuggestKeywords" class="secondary" title="调用子项目联想服务，获得联想词后确认搜索">获取联想词</button>
            <label for="maxItems">每查询词结果数</label>
            <input id="maxItems" type="number" min="1" max="100" value="20" style="width: 90px;" />
            <label for="startOffset">起始偏移</label>
            <input id="startOffset" type="number" min="1" max="91" placeholder="1" style="width: 70px;" title="1=第1条,11=第2页,留空从第1条" />
            <label for="daysBack">时间范围(天)</label>
            <input id="daysBack" type="number" min="1" max="365" placeholder="-" style="width: 70px;" title="仅搜最近N天,留空不限制" />
            <label for="searchLanguageBtn">语言</label>
            <div id="searchLanguageMulti" class="multi-select" aria-label="语言多选下拉">
              <button id="searchLanguageBtn" type="button" class="multi-select-btn">默认</button>
              <div id="searchLanguagePanel" class="multi-select-panel">
                <label><input type="checkbox" value="zh" /> zh</label>
                <label><input type="checkbox" value="en" /> en</label>
              </div>
            </div>
            <label for="searchProvider">搜索服务</label>
            <select id="searchProvider" style="width: 90px;">
              <option value="">默认</option>
              <option value="serper">serper</option>
              <option value="google">google</option>
              <option value="ddg">ddg</option>
              <option value="serpstack">serpstack</option>
              <option value="serpapi">serpapi</option>
              <option value="auto">auto</option>
            </select>
            <label for="commodityLimit">商品天数</label>
            <input id="commodityLimit" type="number" min="1" max="365" value="30" style="width: 90px;" title="每个指标抓取的历史天数" />
            <label for="ecomLimit">电商条数</label>
            <input id="ecomLimit" type="number" min="1" max="500" value="100" style="width: 90px;" title="最大商品数量" />
            <label for="asyncMode">异步</label>
            <input id="asyncMode" type="checkbox" />
          </div>
          <div class="toolbar">
            <label for="socialPlatformSelect">平台名称</label>
            <select id="socialPlatformSelect" style="min-width: 180px;"></select>
            <label for="baseSubredditsSelect">基础子论坛</label>
            <select id="baseSubredditsSelect" multiple></select>
            <label for="enableExtraction">结构化提取</label>
            <input id="enableExtraction" type="checkbox" checked />
            <label for="enableSubredditDiscovery">子论坛发现</label>
            <input id="enableSubredditDiscovery" type="checkbox" checked />
          </div>
          <div class="toolbar">
            <button id="btnPolicyRegulation"><i data-lucide="scroll-text"></i> 政策法规采集</button>
            <button id="btnMarket"><i data-lucide="bar-chart-3"></i> 市场采集</button>
            <button id="btnCommodity"><i data-lucide="box"></i> 商品采集</button>
            <button id="btnEcom"><i data-lucide="tag"></i> 电商价格采集</button>
            <button id="btnSocial"><i data-lucide="users"></i> 舆情采集</button>
          </div>
          <p class="hint">政策法规/市场/舆情共用查询词；起始偏移、时间范围、语言、搜索服务用于政策/市场采集；运行来源库项时可覆盖上述参数。</p>
        </div>

        <div id="actionStatus" class="status">等待触发采集任务</div>
      </section>

      <div id="keywordSuggestionModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 480px;">
          <h3>联想关键词确认</h3>
          <p class="hint">可编辑后确认，将用于政策/市场/舆情采集</p>
          <textarea id="suggestedKeywordsText" rows="6" style="width:100%; margin:8px 0;" placeholder="联想关键词，逗号分隔"></textarea>
          <div class="toolbar" style="justify-content:flex-end; gap:8px;">
            <button id="btnCancelSuggestion" class="secondary">取消</button>
            <button id="btnConfirmSuggestion" class="btn-primary">确认并使用</button>
          </div>
        </div>
      </div>

      <section class="card">
        <h2 class="section-title">最近任务状态</h2>
        <div class="toolbar">
          <button id="refreshHistory" class="secondary">刷新</button>
          <button id="gotoProcess">进入任务管理</button>
        </div>
        <div id="historyContainer" class="table-wrap"></div>
      </section>
    </div>

    <script>
      const { qs, setLoading, setError, setSuccess, setEmpty, formatNumber, toDateTime, escapeHtml, toggleDisabled } = window.UICore;

      function getAsyncMode() {
        return !!qs("asyncMode").checked;
      }

      const SOURCE_ITEMS = [];

      function getQueryTerms() {
        const raw = (qs("queryTerms").value || "").trim();
        if (!raw) return [];
        return raw.split(",").map((v) => v.trim()).filter(Boolean);
      }

      function getOptionalText(id) {
        const value = String(qs(id).value || "").trim();
        return value || null;
      }

      function getOptionalInt(id, min, max) {
        const raw = String(qs(id).value || "").trim();
        if (!raw) return null;
        const value = Number.parseInt(raw, 10);
        if (!Number.isFinite(value)) return null;
        return Math.min(max, Math.max(min, value));
      }

      function getCommodityLimit() {
        return getOptionalInt("commodityLimit", 1, 365) ?? 30;
      }

      function getEcomLimit() {
        return getOptionalInt("ecomLimit", 1, 500) ?? 100;
      }

      function normalizeTextList(value) {
        if (Array.isArray(value)) {
          return value.map((v) => String(v || "").trim()).filter(Boolean);
        }
        if (typeof value === "string") {
          return value.split(",").map((v) => v.trim()).filter(Boolean);
        }
        return [];
      }

      function getSocialPlatforms() {
        const select = qs("socialPlatformSelect");
        const value = String(select?.value || "").trim();
        return value ? [value] : ["reddit"];
      }

      function getSocialLimit() {
        const value = Number.parseInt(String(qs("maxItems").value || "20"), 10);
        if (!Number.isFinite(value)) return 20;
        return Math.min(100, Math.max(1, value));
      }

      function getStartOffset() {
        const raw = String(qs("startOffset").value || "").trim();
        if (!raw) return null;
        const v = Number.parseInt(raw, 10);
        return Number.isFinite(v) && v >= 1 && v <= 91 ? v : null;
      }

      function getDaysBack() {
        const raw = String(qs("daysBack").value || "").trim();
        if (!raw) return null;
        const v = Number.parseInt(raw, 10);
        return Number.isFinite(v) && v >= 1 && v <= 365 ? v : null;
      }

      function getSearchLanguage() {
        const box = qs("searchLanguageMulti");
        const values = Array.from(box?.querySelectorAll('input[type="checkbox"]:checked') || [])
          .map((el) => String(el.value || "").trim())
          .filter(Boolean);
        if (!values.length) return null;
        const uniq = Array.from(new Set(values));
        if (uniq.length >= 2 && uniq.includes("zh") && uniq.includes("en")) return "zh-en";
        return uniq[0] || null;
      }

      function updateSearchLanguageButtonLabel() {
        const box = qs("searchLanguageMulti");
        const btn = qs("searchLanguageBtn");
        if (!box || !btn) return;
        const values = Array.from(box.querySelectorAll('input[type="checkbox"]:checked'))
          .map((el) => String(el.value || "").trim())
          .filter(Boolean);
        const uniq = Array.from(new Set(values));
        if (!uniq.length) {
          btn.textContent = "默认";
          return;
        }
        if (uniq.length >= 2 && uniq.includes("zh") && uniq.includes("en")) {
          btn.textContent = "zh + en";
          return;
        }
        btn.textContent = uniq[0];
      }

      function getSearchProvider() {
        const v = String(qs("searchProvider").value || "").trim();
        return v || null;
      }

      function getEnableExtraction() {
        return !!qs("enableExtraction").checked;
      }

      function getEnableSubredditDiscovery() {
        return !!qs("enableSubredditDiscovery").checked;
      }

      function getBaseSubreddits() {
        const select = qs("baseSubredditsSelect");
        const values = Array.from(select?.selectedOptions || []).map((o) => String(o.value || "").trim()).filter(Boolean);
        return values.length ? values : null;
      }

      function getSelectedSourceItem() {
        const selected = String(qs("sourceLibraryItem").value || "").trim();
        return SOURCE_ITEMS.find((x) => x.item_key === selected) || null;
      }

      function getSelectedSourceParams() {
        const item = getSelectedSourceItem();
        return item && item.params && typeof item.params === "object" ? item.params : {};
      }

      function setSelectOptions(selectId, values, preferred = "") {
        const select = qs(selectId);
        const options = Array.from(new Set((values || []).map((v) => String(v || "").trim()).filter(Boolean)));
        if (!options.length) {
          select.innerHTML = '<option value="">(无可用选项)</option>';
          return;
        }
        select.innerHTML = options.map((v) => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
        if (preferred && options.includes(preferred)) {
          select.value = preferred;
        }
      }

      function setMultiSelectOptions(selectId, values, selectedValues = []) {
        const select = qs(selectId);
        const options = Array.from(new Set((values || []).map((v) => String(v || "").trim()).filter(Boolean)));
        if (!options.length) {
          select.innerHTML = "";
          return;
        }
        const selected = new Set((selectedValues || []).map((x) => String(x || "").trim()));
        select.innerHTML = options.map((v) => `<option value="${escapeHtml(v)}"${selected.has(v) ? " selected" : ""}>${escapeHtml(v)}</option>`).join("");
      }

      function refreshDropdownsFromSourceConfig() {
        const selectedParams = getSelectedSourceParams();
        const allParams = SOURCE_ITEMS.map((it) => (it && it.params && typeof it.params === "object" ? it.params : {}));
        const allPlatforms = allParams.flatMap((p) => normalizeTextList(p.platforms || p.platform));
        const allSubreddits = allParams.flatMap((p) => normalizeTextList(p.base_subreddits || p.subreddits));
        const preferredPlatform = normalizeTextList(selectedParams.platforms || selectedParams.platform)[0] || "reddit";
        const preferredSubreddits = normalizeTextList(selectedParams.base_subreddits || selectedParams.subreddits);
        setSelectOptions("socialPlatformSelect", allPlatforms.length ? allPlatforms : ["reddit"], preferredPlatform);
        setMultiSelectOptions(
          "baseSubredditsSelect",
          allSubreddits.length ? allSubreddits : ["MachineLearning", "robotics", "ArtificialInteligence", "singularity"],
          preferredSubreddits
        );
      }

      async function loadSourceLibraryItems() {
        const projectKey = window.MarketApp.getProjectKey();
        const data = await window.MarketApp.fetchJSON(`/api/v1/source_library/items?scope=effective&project_key=${encodeURIComponent(projectKey)}`);
        const items = Array.isArray(data?.items) ? data.items.filter((x) => x && x.enabled !== false) : [];
        SOURCE_ITEMS.length = 0;
        SOURCE_ITEMS.push(...items);
        const select = qs("sourceLibraryItem");
        if (!SOURCE_ITEMS.length) {
          select.innerHTML = '<option value="">(暂无来源库项)</option>';
          refreshDropdownsFromSourceConfig();
          return;
        }
        select.innerHTML = SOURCE_ITEMS.map((it) => `<option value="${escapeHtml(it.item_key)}">${escapeHtml(it.name || it.item_key)} (${escapeHtml(it.item_key)})</option>`).join("");
        refreshDropdownsFromSourceConfig();
      }

      async function fetchSuggestedKeywords(rawTerms, platform = null) {
        const cleaned = Array.isArray(rawTerms) ? rawTerms.map((x) => String(x || "").trim()).filter(Boolean) : [];
        if (!cleaned.length) return [];
        const topic = cleaned.join(" ");
        const payload = {
          topic,
          language: (getSearchLanguage() || "zh").trim() || "zh",
          platform,
          base_keywords: cleaned,
        };
        const data = await window.MarketApp.fetchJSON("/api/v1/discovery/generate-keywords", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const searchKw = Array.isArray(data?.search_keywords) && data.search_keywords.length
          ? data.search_keywords
          : (Array.isArray(data?.keywords) ? data.keywords : []);
        return Array.from(new Set([...cleaned, ...searchKw.map((x) => String(x || "").trim()).filter(Boolean)]));
      }

      function showKeywordSuggestionModal(keywords) {
        qs("suggestedKeywordsText").value = keywords.join(", ");
        qs("keywordSuggestionModal").classList.add("active");
      }

      function hideKeywordSuggestionModal() {
        qs("keywordSuggestionModal").classList.remove("active");
      }

      function getConfirmedKeywordsFromModal() {
        const raw = String(qs("suggestedKeywordsText").value || "").trim();
        if (!raw) return [];
        return raw.split(",").map((v) => v.trim()).filter(Boolean);
      }

      function getActionSummaryCounts(data) {
        const root = (data && typeof data === "object") ? data : {};
        const nested = (root.result && typeof root.result === "object") ? root.result : null;
        const carrier = nested || root;
        return {
          inserted: Number(carrier.inserted || 0),
          updated: Number(carrier.updated || 0),
          skipped: Number(carrier.skipped || 0),
          errors: Array.isArray(carrier.errors) ? carrier.errors.length : 0,
        };
      }

      async function runAction(actionName, req) {
        toggleDisabled(["btnPolicy", "btnPolicyRegulation", "btnMarket", "btnCommodity", "btnEcom", "btnSocial", "btnSyncSourceLibrary", "btnRunSourceLibraryItem"], true);
        setLoading("actionStatus", `${actionName}执行中...`);
        try {
          const data = await req();
          if (data.task_id) {
            setSuccess("actionStatus", `${actionName}已提交，任务ID: ${data.task_id}`);
          } else {
            const counts = getActionSummaryCounts(data);
            const errorSuffix = counts.errors ? `，错误 ${formatNumber(counts.errors)}` : "";
            setSuccess(
              "actionStatus",
              `${actionName}完成，新增 ${formatNumber(counts.inserted)}，更新 ${formatNumber(counts.updated)}，跳过 ${formatNumber(counts.skipped)}${errorSuffix}`
            );
          }
          await loadHistory();
        } catch (error) {
          setError("actionStatus", `${actionName}失败: ${error.message}`);
        } finally {
          toggleDisabled(["btnPolicy", "btnPolicyRegulation", "btnMarket", "btnCommodity", "btnEcom", "btnSocial", "btnSyncSourceLibrary", "btnRunSourceLibraryItem"], false);
        }
      }

      async function syncSourceLibraryFromFiles() {
        const projectKey = window.MarketApp.getProjectKey();
        return await window.MarketApp.fetchJSON("/api/v1/ingest/source-library/sync", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ project_key: projectKey || "" }),
        });
      }

      function buildOverrideParamsFromForm() {
        const overrides = {};
        const limit = getSocialLimit();
        if (limit != null) {
          overrides.limit = limit;
          overrides.max_items = limit;
        }
        const terms = getQueryTerms();
        if (terms.length) {
          overrides.query_terms = terms;
          overrides.keywords = terms;
        }
        const so = getStartOffset();
        if (so != null) overrides.start_offset = so;
        const db = getDaysBack();
        if (db != null) overrides.days_back = db;
        const lang = getSearchLanguage();
        if (lang) overrides.language = lang;
        const prov = getSearchProvider();
        if (prov) overrides.provider = prov;
        overrides.enable_extraction = getEnableExtraction();
        const baseSubs = getBaseSubreddits();
        if (baseSubs && baseSubs.length) overrides.base_subreddits = baseSubs;
        const platforms = getSocialPlatforms();
        if (platforms && platforms.length) overrides.platforms = platforms;
        overrides.enable_subreddit_discovery = getEnableSubredditDiscovery();
        return overrides;
      }

      async function runSelectedSourceLibraryItem() {
        const projectKey = window.MarketApp.getProjectKey();
        const itemKey = String(qs("sourceLibraryItem").value || "").trim();
        if (!itemKey) throw new Error("请先选择一个来源库项");
        if (!projectKey) throw new Error("请先选择项目（project_key）");
        const payload = {
          item_key: itemKey,
          project_key: projectKey,
          async_mode: !!qs("asyncMode").checked,
          override_params: buildOverrideParamsFromForm(),
        };
        return await window.MarketApp.fetchJSON("/api/v1/ingest/source-library/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      }

      async function loadHistory() {
        setLoading("historyContainer", "加载任务历史...");
        try {
          const data = await window.MarketApp.fetchJSON("/api/v1/ingest/history?limit=8");
          if (!Array.isArray(data) || !data.length) {
            setEmpty("historyContainer", "暂无任务历史");
            return;
          }
          const rows = data
            .map((job) => {
              const statusClass = job.status === "completed" ? "success" : job.status === "failed" ? "danger" : "warning";
              return `
                <tr>
                  <td><code>${escapeHtml(String(job.id))}</code></td>
                  <td>${escapeHtml(job.job_type || "-")}</td>
                  <td><span class="badge ${statusClass}">${escapeHtml(job.status || "-")}</span></td>
                  <td>${toDateTime(job.started_at)}</td>
                  <td>${toDateTime(job.finished_at)}</td>
                </tr>
              `;
            })
            .join("");
          qs("historyContainer").innerHTML = `
            <table>
              <thead><tr><th>ID</th><th>任务类型</th><th>状态</th><th>开始时间</th><th>结束时间</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          `;
        } catch (error) {
          setError("historyContainer", `加载失败: ${error.message}`);
        }
      }

      qs("btnPolicy").addEventListener("click", () =>
        runAction("政策采集", () => {
          const sourceParams = getSelectedSourceParams();
          const state = String(sourceParams.state || "").trim();
          if (!state) {
            throw new Error("所选来源库项缺少 state 配置，无法执行政策采集。");
          }
          return window.MarketApp.fetchJSON("/api/v1/ingest/policy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              state,
              async_mode: getAsyncMode(),
              source_hint: String(sourceParams.source_hint || "").trim() || null,
              project_key: window.MarketApp.getProjectKey(),
            }),
          });
        })
      );

      qs("btnSuggestKeywords").addEventListener("click", async () => {
        const rawTerms = getQueryTerms();
        if (!rawTerms.length) {
          setError("actionStatus", "请先输入查询词，再获取联想词");
          return;
        }
        setLoading("actionStatus", "正在获取联想词...");
        try {
          const platform = getSocialPlatforms()[0] || null;
          const suggested = await fetchSuggestedKeywords(rawTerms, platform);
          if (!suggested.length) {
            setError("actionStatus", "联想服务未返回关键词");
            return;
          }
          setSuccess("actionStatus", `已获取 ${suggested.length} 个联想词，请确认后执行采集`);
          showKeywordSuggestionModal(suggested);
        } catch (err) {
          setError("actionStatus", `获取联想词失败: ${err.message}`);
        }
      });

      qs("btnCancelSuggestion").addEventListener("click", hideKeywordSuggestionModal);
      qs("btnConfirmSuggestion").addEventListener("click", () => {
        const confirmed = getConfirmedKeywordsFromModal();
        if (confirmed.length) {
          qs("queryTerms").value = confirmed.join(", ");
          setSuccess("actionStatus", `已确认 ${confirmed.length} 个查询词，可执行采集`);
        }
        hideKeywordSuggestionModal();
      });
      qs("keywordSuggestionModal").addEventListener("click", (e) => {
        if (e.target.id === "keywordSuggestionModal") hideKeywordSuggestionModal();
      });

      qs("searchLanguageBtn")?.addEventListener("click", (e) => {
        e.stopPropagation();
        qs("searchLanguageMulti")?.classList.toggle("open");
      });
      qs("searchLanguagePanel")?.addEventListener("click", (e) => {
        e.stopPropagation();
      });
      qs("searchLanguagePanel")?.querySelectorAll('input[type="checkbox"]').forEach((el) => {
        el.addEventListener("change", updateSearchLanguageButtonLabel);
      });
      document.addEventListener("click", () => {
        qs("searchLanguageMulti")?.classList.remove("open");
      });
      updateSearchLanguageButtonLabel();

      qs("btnMarket").addEventListener("click", () => {
        const rawTerms = getQueryTerms();
        if (!rawTerms.length) {
          setError("actionStatus", "请先输入查询词（逗号分隔）");
          return;
        }
        runAction("市场采集", async () => {
          const queryTerms = rawTerms;
          const body = {
            query_terms: queryTerms,
            keywords: queryTerms,
            max_items: getSocialLimit(),
            limit: getSocialLimit(),
            async_mode: getAsyncMode(),
            enable_extraction: getEnableExtraction(),
            project_key: window.MarketApp.getProjectKey(),
          };
          const so = getStartOffset(); if (so != null) body.start_offset = so;
          const db = getDaysBack(); if (db != null) body.days_back = db;
          const lang = getSearchLanguage(); if (lang) body.language = lang;
          const prov = getSearchProvider(); if (prov) body.provider = prov;
          return window.MarketApp.fetchJSON("/api/v1/ingest/market", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
        });
      });

      qs("btnPolicyRegulation").addEventListener("click", () => {
        const rawTerms = getQueryTerms();
        if (!rawTerms.length) {
          setError("actionStatus", "请先输入查询词（逗号分隔）");
          return;
        }
        runAction("政策法规采集", async () => {
          const queryTerms = rawTerms;
          const body = {
            query_terms: queryTerms,
            keywords: queryTerms,
            max_items: getSocialLimit(),
            limit: getSocialLimit(),
            async_mode: getAsyncMode(),
            enable_extraction: getEnableExtraction(),
            project_key: window.MarketApp.getProjectKey(),
          };
          const so = getStartOffset(); if (so != null) body.start_offset = so;
          const db = getDaysBack(); if (db != null) body.days_back = db;
          const lang = getSearchLanguage(); if (lang) body.language = lang;
          const prov = getSearchProvider(); if (prov) body.provider = prov;
          return window.MarketApp.fetchJSON("/api/v1/ingest/policy/regulation", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
        });
      });

      qs("btnCommodity").addEventListener("click", () =>
        runAction("商品采集", () =>
          window.MarketApp.fetchJSON("/api/v1/ingest/commodity/metrics", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              limit: getCommodityLimit(),
              async_mode: getAsyncMode(),
              project_key: window.MarketApp.getProjectKey(),
            }),
          })
        )
      );

      qs("btnEcom").addEventListener("click", () =>
        runAction("电商价格采集", () =>
          window.MarketApp.fetchJSON("/api/v1/ingest/ecom/prices", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              limit: getEcomLimit(),
              async_mode: getAsyncMode(),
              project_key: window.MarketApp.getProjectKey(),
            }),
          })
        )
      );

      qs("btnSocial").addEventListener("click", () => {
        const rawTerms = getQueryTerms();
        if (!rawTerms.length) {
          setError("actionStatus", "请先输入查询词（逗号分隔）");
          return;
        }
        runAction("舆情采集", async () => {
          const queryTerms = rawTerms;
          return window.MarketApp.fetchJSON("/api/v1/ingest/social/sentiment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              query_terms: queryTerms,
              keywords: queryTerms,
              platforms: getSocialPlatforms(),
              max_items: getSocialLimit(),
              limit: getSocialLimit(),
              async_mode: getAsyncMode(),
              enable_extraction: getEnableExtraction(),
              enable_subreddit_discovery: getEnableSubredditDiscovery(),
              base_subreddits: getBaseSubreddits(),
              project_key: window.MarketApp.getProjectKey(),
            }),
          });
        });
      });

      qs("refreshHistory").addEventListener("click", loadHistory);
      qs("gotoProcess").addEventListener("click", () => window.MarketApp.navigateInShell("process-management.html"));
      qs("sourceLibraryItem").addEventListener("change", refreshDropdownsFromSourceConfig);
      qs("btnSyncSourceLibrary").addEventListener("click", () =>
        runAction("同步来源库", async () => {
          const res = await syncSourceLibraryFromFiles();
          await loadSourceLibraryItems();
          return res;
        })
      );
      qs("btnRunSourceLibraryItem").addEventListener("click", () =>
        runAction("运行来源库项", runSelectedSourceLibraryItem)
      );

      window.addEventListener("DOMContentLoaded", async () => {
        lucide.createIcons();
        try {
          await loadSourceLibraryItems();
        } catch (error) {
          setError("actionStatus", `来源库加载失败: ${error.message}`);
        }
        loadHistory();
      });
    </script>
  </body>
</html>
