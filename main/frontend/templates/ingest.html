<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>采集 - 市场信息工作台</title>
    <link rel="stylesheet" href="/static/css/app-theme.css" />
    <style>
      /* 确保 iframe 内的 body 没有 padding，由 .page 控制 */
      body { padding: 0; }
      .page { padding: 24px; max-width: 1200px; margin: 0 auto; }
      .hint { color: var(--text-muted); font-size: 12px; margin-top: 6px; }
      .toolbar select[multiple] { min-width: 220px; min-height: 92px; }
      .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
      .modal-overlay.active { display: flex; }
      .modal-overlay .modal-content { background: var(--card-bg, #fff); border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
      .modal-overlay h3 { margin: 0 0 8px 0; }
      .ingest-partition { padding: 16px 0; border-bottom: 1px solid var(--border, #e2e8f0); }
      .ingest-partition:last-of-type { border-bottom: none; padding-bottom: 0; }
      .hidden { display: none !important; }
      .partition-title { margin: 0 0 12px 0; font-size: 15px; font-weight: 600; color: var(--text, #1e293b); }
      .multi-select { position: relative; display: inline-block; min-width: 96px; }
      .multi-select-btn {
        min-width: 96px;
        height: 32px;
        border: 1px solid var(--border, #d0d7de);
        border-radius: 6px;
        background: var(--card-bg, #fff);
        color: var(--text, #111827);
        padding: 0 10px;
        text-align: left;
        cursor: pointer;
      }
      .multi-select-panel {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        min-width: 120px;
        background: var(--card-bg, #fff);
        border: 1px solid var(--border, #d0d7de);
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        padding: 6px 8px;
        z-index: 100;
        display: none;
      }
      .multi-select.open .multi-select-panel { display: block; }
      .multi-select-panel label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        padding: 4px 2px;
        cursor: pointer;
      }
    </style>
    <script src="/static/js/app-shell.js"></script>
    <script src="/static/js/ui-core.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div class="page">
      <section class="hero">
        <h1><i data-lucide="layout" style="vertical-align: middle; margin-right: 8px;"></i>市场信息工作台</h1>
        <p>业务层覆盖宏观政策、行业公司、商品、电商/经营、舆情；操作层覆盖采集、提取、分析、看板、管理。</p>
      </section>

      <section class="card" style="margin-bottom: 12px;">
        <h2 class="section-title">业务域总览</h2>
        <div class="grid-4">
          <article class="card">
            <div class="badge info"><i data-lucide="scroll-text" style="width: 14px; height: 14px; margin-right: 4px;"></i> 宏观政策</div>
            <p>政策动态、监管变动、区域法规跟踪</p>
          </article>
          <article class="card">
            <div class="badge info"><i data-lucide="factory" style="width: 14px; height: 14px; margin-right: 4px;"></i> 行业公司</div>
            <p>重点公司事件、行业新闻与主题聚合</p>
          </article>
          <article class="card">
            <div class="badge info"><i data-lucide="package" style="width: 14px; height: 14px; margin-right: 4px;"></i> 商品</div>
            <p>商品指标历史与趋势采集</p>
          </article>
          <article class="card">
            <div class="badge info"><i data-lucide="shopping-cart" style="width: 14px; height: 14px; margin-right: 4px;"></i> 电商/经营与舆情</div>
            <p>电商/经营观测与社交情绪变化</p>
          </article>
        </div>
      </section>

      <section class="card" style="margin-bottom: 12px;" id="ingest">
        <h2 class="section-title">采集快捷入口</h2>

        <div class="ingest-partition" id="partitionCommon">
          <h3 class="partition-title"><i data-lucide="sliders-horizontal" style="width: 16px; height: 16px; vertical-align: middle;"></i> 通用检索设置</h3>
          <div class="toolbar">
            <label for="queryTerms">查询词</label>
            <input id="queryTerms" placeholder="输入查询词，逗号分隔" style="min-width: 280px;" />
            <button id="btnSuggestKeywords" class="secondary" title="调用子项目联想服务，获得联想词后确认搜索">获取联想词</button>
            <label for="topicFocus">专题联想</label>
            <select id="topicFocus" style="width: 120px;">
              <option value="">默认</option>
              <option value="company">公司</option>
              <option value="product">商品</option>
              <option value="operation">电商/经营</option>
            </select>
            <label for="searchLanguageBtn">语言</label>
            <div id="searchLanguageMulti" class="multi-select" aria-label="语言多选下拉">
              <button id="searchLanguageBtn" type="button" class="multi-select-btn">默认</button>
              <div id="searchLanguagePanel" class="multi-select-panel">
                <label><input type="checkbox" value="zh" /> zh</label>
                <label><input type="checkbox" value="en" /> en</label>
              </div>
            </div>
            <label for="searchProvider">搜索服务</label>
            <select id="searchProvider" style="width: 90px;">
              <option value="">默认</option>
              <option value="serper">serper</option>
              <option value="google">google</option>
              <option value="ddg">ddg</option>
              <option value="serpstack">serpstack</option>
              <option value="serpapi">serpapi</option>
              <option value="auto">auto</option>
            </select>
            <label for="asyncMode">异步</label>
            <input id="asyncMode" type="checkbox" />
          </div>
          <div class="toolbar">
            <label for="maxItems">每查询词结果数</label>
            <input id="maxItems" type="number" min="1" max="100" value="20" style="width: 90px;" />
            <label for="startOffset">起始偏移</label>
            <input id="startOffset" type="number" min="1" max="91" placeholder="1" style="width: 70px;" title="1=第1条,11=第2页,留空从第1条" />
            <label for="daysBack">时间范围(天)</label>
            <input id="daysBack" type="number" min="1" max="365" placeholder="-" style="width: 70px;" title="仅搜最近N天,留空不限制" />
            <label for="enableExtraction">结构化提取</label>
            <input id="enableExtraction" type="checkbox" checked />
          </div>
          <p class="hint">通用查询词/语言/联想词与检索参数会被政策法规、市场、舆情采集复用；运行来源库项时也会作为覆盖参数传入。</p>
        </div>

        <div class="ingest-partition" id="partitionSourceLibrary">
          <h3 class="partition-title"><i data-lucide="database" style="width: 16px; height: 16px; vertical-align: middle;"></i> 来源库项运行</h3>
          <div class="toolbar">
            <label for="sourceLibraryItem">来源库项</label>
            <select id="sourceLibraryItem" style="min-width: 320px;"></select>
            <label for="sourceLibraryHandlerSelect">Handler 聚类（entry_type）</label>
            <select id="sourceLibraryHandlerSelect" style="min-width: 220px;">
              <option value="">(选择 Handler 聚类)</option>
            </select>
            <span id="sourceLibraryHandlerDebug" class="hint" style="margin-left: 6px;"></span>
            <button id="btnSyncSourceLibrary" class="btn">同步来源库</button>
            <button id="btnRunSourceLibraryItem" class="btn btn-primary">运行来源库项</button>
            <button id="btnRunSourceLibraryHandler" class="btn">运行 Handler 聚类</button>
          </div>
          <p class="hint">可传 `item_key` 或 `handler_key`（二选一，`handler_key` 为来源库 item 的 entry_type 聚类，如 `rss` / `sitemap` / `search_template`）。使用上方通用检索设置作为 `override_params`；查询词会透传到执行任务。</p>
        </div>

        <div class="ingest-partition" id="partitionPolicy">
          <h3 class="partition-title"><i data-lucide="scroll-text" style="width: 16px; height: 16px; vertical-align: middle;"></i> 政策类采集</h3>
          <div class="toolbar">
            <button id="btnPolicyRegulation"><i data-lucide="scroll-text"></i> 政策法规采集</button>
            <button id="btnPolicy"><i data-lucide="download-cloud"></i> 政策采集（按来源项州）</button>
          </div>
          <p class="hint">政策法规采集使用上方通用查询词、语言、搜索服务、结果数、偏移和时间范围；“政策采集（按来源项州）”依赖所选来源库项中的 `state`。</p>
        </div>

        <div class="ingest-partition" id="partitionMarket">
          <h3 class="partition-title"><i data-lucide="bar-chart-3" style="width: 16px; height: 16px; vertical-align: middle;"></i> 市场采集</h3>
          <div class="toolbar">
            <button id="btnMarket"><i data-lucide="bar-chart-3"></i> 市场采集</button>
          </div>
          <p class="hint">市场采集复用上方通用查询词 / 语言 / 搜索服务 / 结果数 / 偏移 / 时间范围 / 结构化提取设置。</p>
        </div>

        <div class="ingest-partition" id="partitionSocial">
          <h3 class="partition-title"><i data-lucide="users" style="width: 16px; height: 16px; vertical-align: middle;"></i> 舆情采集</h3>
          <div class="toolbar">
            <label for="socialPlatformSelect">平台名称</label>
            <select id="socialPlatformSelect" style="min-width: 180px;"></select>
            <label for="baseSubredditsSelect">基础子论坛</label>
            <select id="baseSubredditsSelect" multiple></select>
            <label for="enableSubredditDiscovery">子论坛发现</label>
            <input id="enableSubredditDiscovery" type="checkbox" checked />
            <button id="btnSocial"><i data-lucide="users"></i> 舆情采集</button>
          </div>
          <p class="hint">舆情采集复用上方通用查询词、结果数与结构化提取设置；此处分组配置平台、基础子论坛与子论坛发现。</p>
        </div>

        <div class="ingest-partition" id="partitionCommodityEcom">
          <h3 class="partition-title"><i data-lucide="box" style="width: 16px; height: 16px; vertical-align: middle;"></i> 商品与电商采集</h3>
          <div class="toolbar">
            <label for="commodityLimit">商品天数</label>
            <input id="commodityLimit" type="number" min="1" max="365" value="30" style="width: 90px;" title="每个指标抓取的历史天数" />
            <button id="btnCommodity"><i data-lucide="box"></i> 商品采集</button>
            <label for="ecomLimit" style="margin-left: 12px;">电商条数</label>
            <input id="ecomLimit" type="number" min="1" max="500" value="100" style="width: 90px;" title="最大商品数量" />
            <button id="btnEcom"><i data-lucide="tag"></i> 电商/经营采集</button>
          </div>
          <p class="hint">商品与电商采集不依赖查询词，分别使用本分组的条数/天数参数。</p>
        </div>

        <div class="ingest-partition hidden" id="partitionSpecializedGuide">
          <h3 class="partition-title"><i data-lucide="sparkles" style="width: 16px; height: 16px; vertical-align: middle;"></i> 特化采集入口（三分区）</h3>
          <div class="toolbar">
            <button id="btnRunSpecializedIngest" class="btn btn-primary">开始采集</button>
          </div>
          <p class="hint">专题由上方“获取联想词”旁的“专题联想”下拉决定。点击“开始采集”后统一走主干采集流程。</p>
        </div>

        <div class="ingest-partition hidden" id="partitionSpecializedSourceSearch">
          <h3 class="partition-title"><i data-lucide="search" style="width: 16px; height: 16px; vertical-align: middle;"></i> 信息源库搜索（特化）</h3>
          <div class="toolbar">
            <label for="specializedSourceSearch">关键词</label>
            <input id="specializedSourceSearch" placeholder="按名称 / item_key / tags / 描述筛选来源库项" style="min-width: 320px;" />
            <button id="btnSpecializedSourceSearch" class="secondary">搜索</button>
            <label for="specializedSourceResult">结果</label>
            <select id="specializedSourceResult" style="min-width: 360px;">
              <option value="">(请输入关键词搜索)</option>
            </select>
            <button id="btnSpecializedUseSource" class="btn">选中为当前来源项</button>
            <button id="btnSpecializedRunSource" class="btn btn-primary">运行选中来源项</button>
          </div>
          <p class="hint">使用已同步来源库做快速筛选。选中后会同步到“来源库项”并沿用通用检索设置作为覆盖参数执行。</p>
        </div>

        <div id="actionStatus" class="status">等待触发采集任务</div>
      </section>

      <div id="keywordSuggestionModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 480px;">
          <h3>联想关键词确认</h3>
          <p class="hint">可编辑后确认，将用于政策/市场/舆情采集</p>
          <textarea id="suggestedKeywordsText" rows="6" style="width:100%; margin:8px 0;" placeholder="联想关键词，逗号分隔"></textarea>
          <div class="toolbar" style="justify-content:flex-end; gap:8px;">
            <button id="btnCancelSuggestion" class="secondary">取消</button>
            <button id="btnConfirmSuggestion" class="btn-primary">确认并使用</button>
          </div>
        </div>
      </div>

      <section class="card">
        <h2 class="section-title">最近任务状态</h2>
        <div class="toolbar">
          <button id="refreshHistory" class="secondary">刷新</button>
          <button id="gotoProcess">进入任务管理</button>
        </div>
        <div id="historyContainer" class="table-wrap"></div>
      </section>
    </div>

    <script>
      const { qs, setLoading, setError, setSuccess, setEmpty, formatNumber, toDateTime, escapeHtml, toggleDisabled } = window.UICore;
      const INGEST_PAGE_MODE = new URLSearchParams(window.location.search).get("mode") || "default";
      const INGEST_PAGE_PARAMS = new URLSearchParams(window.location.search);
      let suggestKeywordsInFlight = false;
      let suggestKeywordsAutoTriggered = false;

      function applyIngestPageMode() {
        const heroTitle = document.querySelector(".hero h1");
        const heroDesc = document.querySelector(".hero p");
        const overviewCard = document.querySelectorAll(".page > section.card")[0];
        const pageTitleMap = {
          default: "市场信息工作台",
          specialized: "特化采集工作台",
        };
        if (heroTitle) {
          heroTitle.innerHTML = `<i data-lucide="layout" style="vertical-align: middle; margin-right: 8px;"></i>${pageTitleMap[INGEST_PAGE_MODE] || pageTitleMap.default}`;
        }
        if (INGEST_PAGE_MODE === "specialized") {
          if (heroDesc) heroDesc.textContent = "公司 / 商品 / 电商经营 三分区特化采集入口；保留通用查询词与原有采集按钮布局。";
          if (overviewCard) overviewCard.classList.add("hidden");
          qs("partitionSourceLibrary")?.classList.add("hidden");
          qs("partitionPolicy")?.classList.add("hidden");
          qs("partitionMarket")?.classList.add("hidden");
          qs("partitionSocial")?.classList.add("hidden");
          qs("partitionCommodityEcom")?.classList.add("hidden");
          qs("partitionSpecializedGuide")?.classList.remove("hidden");
          qs("partitionSpecializedSourceSearch")?.classList.remove("hidden");
        } else {
          qs("partitionSpecializedGuide")?.classList.add("hidden");
          qs("partitionSpecializedSourceSearch")?.classList.add("hidden");
          qs("partitionPolicy")?.classList.remove("hidden");
          qs("partitionSourceLibrary")?.classList.remove("hidden");
          qs("partitionMarket")?.classList.remove("hidden");
          qs("partitionSocial")?.classList.remove("hidden");
          qs("partitionCommodityEcom")?.classList.remove("hidden");
        }
      }

      function setTopicFocusPreset(value, message) {
        const el = qs("topicFocus");
        if (el) el.value = value;
        setSuccess("actionStatus", message);
      }

      function getAsyncMode() {
        return !!qs("asyncMode").checked;
      }

      const SOURCE_ITEMS = [];

      function getQueryTerms() {
        const raw = (qs("queryTerms").value || "").trim();
        if (!raw) return [];
        return raw.split(",").map((v) => v.trim()).filter(Boolean);
      }

      function parsePrefillTermsFromSearch() {
        const params = new URLSearchParams(window.location.search);
        const direct = String(params.get("prefill_terms") || "").trim();
        if (direct) {
          return direct.split(",").map((v) => v.trim()).filter(Boolean);
        }
        const prefillKey = String(params.get("prefill_key") || "").trim();
        if (!prefillKey) return [];
        try {
          const raw = localStorage.getItem(prefillKey);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed?.terms)) {
            return parsed.terms.map((v) => String(v || "").trim()).filter(Boolean);
          }
        } catch (_) {}
        finally {
          try { localStorage.removeItem(prefillKey); } catch (_) {}
        }
        return [];
      }

      function applyGraphSelectionPrefill() {
        const terms = parsePrefillTermsFromSearch();
        if (!terms.length) return [];
        const uniq = Array.from(new Set(terms)).slice(0, 80);
        const queryInput = qs("queryTerms");
        if (!queryInput) return [];
        queryInput.value = uniq.join(", ");
        queryInput.dataset.sourceAutofill = queryInput.value;
        setSuccess("actionStatus", `已从图谱导入 ${uniq.length} 个查询词，可直接获取联想词或执行采集。`);
        return uniq;
      }

      function shouldAutoSuggestFromGraph() {
        return String(INGEST_PAGE_PARAMS.get("prefill_source") || "").trim() === "graph"
          && String(INGEST_PAGE_PARAMS.get("auto_suggest") || "").trim() === "1";
      }

      async function triggerSuggestKeywordsFlow(options = {}) {
        const { auto = false } = options;
        if (suggestKeywordsInFlight) return;
        const rawTerms = getQueryTerms();
        if (!rawTerms.length) {
          if (auto) {
            setError("actionStatus", "图谱预填充查询词为空，已跳过自动联想；可手动点击“获取联想词”。");
            return;
          }
          setError("actionStatus", "请先输入查询词，再获取联想词");
          return;
        }
        suggestKeywordsInFlight = true;
        setLoading("actionStatus", auto ? "已接收图谱查询词，正在自动获取联想词..." : "正在获取联想词...");
        try {
          const platform = getSocialPlatforms()[0] || null;
          const suggested = await fetchSuggestedKeywords(rawTerms, platform);
          if (!suggested.length) {
            if (auto) {
              setError("actionStatus", "自动联想未返回关键词；可手动点击“获取联想词”重试。");
              return;
            }
            setError("actionStatus", "联想服务未返回关键词");
            return;
          }
          setSuccess("actionStatus", `已获取 ${suggested.length} 个联想词，请确认后执行采集`);
          showKeywordSuggestionModal(suggested);
        } catch (err) {
          if (auto) {
            setError("actionStatus", `自动获取联想词失败: ${err.message}；已降级为手动触发。`);
            return;
          }
          setError("actionStatus", `获取联想词失败: ${err.message}`);
        } finally {
          suggestKeywordsInFlight = false;
        }
      }

      function maybeAutoSuggestFromGraph(prefilledTerms) {
        if (!shouldAutoSuggestFromGraph()) return;
        if (suggestKeywordsAutoTriggered) return;
        suggestKeywordsAutoTriggered = true;
        if (!Array.isArray(prefilledTerms) || !prefilledTerms.length) {
          setError("actionStatus", "未检测到图谱预填充查询词，已跳过自动联想；可手动点击“获取联想词”。");
          return;
        }
        triggerSuggestKeywordsFlow({ auto: true });
      }

      function getOptionalText(id) {
        const value = String(qs(id).value || "").trim();
        return value || null;
      }

      function getOptionalInt(id, min, max) {
        const raw = String(qs(id).value || "").trim();
        if (!raw) return null;
        const value = Number.parseInt(raw, 10);
        if (!Number.isFinite(value)) return null;
        return Math.min(max, Math.max(min, value));
      }

      function getCommodityLimit() {
        return getOptionalInt("commodityLimit", 1, 365) ?? 30;
      }

      function getEcomLimit() {
        return getOptionalInt("ecomLimit", 1, 500) ?? 100;
      }

      function normalizeTextList(value) {
        if (Array.isArray(value)) {
          return value.map((v) => String(v || "").trim()).filter(Boolean);
        }
        if (typeof value === "string") {
          return value.split(",").map((v) => v.trim()).filter(Boolean);
        }
        return [];
      }

      function getSocialPlatforms() {
        const select = qs("socialPlatformSelect");
        const value = String(select?.value || "").trim();
        return value ? [value] : ["reddit"];
      }

      function getSocialLimit() {
        const value = Number.parseInt(String(qs("maxItems").value || "20"), 10);
        if (!Number.isFinite(value)) return 20;
        return Math.min(100, Math.max(1, value));
      }

      function getStartOffset() {
        const raw = String(qs("startOffset").value || "").trim();
        if (!raw) return null;
        const v = Number.parseInt(raw, 10);
        return Number.isFinite(v) && v >= 1 && v <= 91 ? v : null;
      }

      function getDaysBack() {
        const raw = String(qs("daysBack").value || "").trim();
        if (!raw) return null;
        const v = Number.parseInt(raw, 10);
        return Number.isFinite(v) && v >= 1 && v <= 365 ? v : null;
      }

      function getSearchLanguage() {
        const box = qs("searchLanguageMulti");
        const values = Array.from(box?.querySelectorAll('input[type="checkbox"]:checked') || [])
          .map((el) => String(el.value || "").trim())
          .filter(Boolean);
        if (!values.length) return null;
        const uniq = Array.from(new Set(values));
        if (uniq.length >= 2 && uniq.includes("zh") && uniq.includes("en")) return "zh-en";
        return uniq[0] || null;
      }

      function updateSearchLanguageButtonLabel() {
        const box = qs("searchLanguageMulti");
        const btn = qs("searchLanguageBtn");
        if (!box || !btn) return;
        const values = Array.from(box.querySelectorAll('input[type="checkbox"]:checked'))
          .map((el) => String(el.value || "").trim())
          .filter(Boolean);
        const uniq = Array.from(new Set(values));
        if (!uniq.length) {
          btn.textContent = "默认";
          return;
        }
        if (uniq.length >= 2 && uniq.includes("zh") && uniq.includes("en")) {
          btn.textContent = "zh + en";
          return;
        }
        btn.textContent = uniq[0];
      }

      function getSearchProvider() {
        const v = String(qs("searchProvider").value || "").trim();
        return v || null;
      }

      function getTopicFocus() {
        const v = String(qs("topicFocus")?.value || "").trim();
        return v || null;
      }

      function getEnableExtraction() {
        return !!qs("enableExtraction").checked;
      }

      function getEnableSubredditDiscovery() {
        return !!qs("enableSubredditDiscovery").checked;
      }

      function getBaseSubreddits() {
        const select = qs("baseSubredditsSelect");
        const values = Array.from(select?.selectedOptions || []).map((o) => String(o.value || "").trim()).filter(Boolean);
        return values.length ? values : null;
      }

      function getSelectedSourceItem() {
        const selected = String(qs("sourceLibraryItem").value || "").trim();
        return SOURCE_ITEMS.find((x) => x.item_key === selected) || null;
      }

      function filterSourceItemsByKeyword(keyword) {
        const q = String(keyword || "").trim().toLowerCase();
        if (!q) return [];
        return SOURCE_ITEMS.filter((it) => {
          const name = String(it?.name || "").toLowerCase();
          const key = String(it?.item_key || "").toLowerCase();
          const desc = String(it?.description || "").toLowerCase();
          const tags = Array.isArray(it?.tags) ? it.tags.map((x) => String(x || "").toLowerCase()).join(" ") : "";
          return name.includes(q) || key.includes(q) || desc.includes(q) || tags.includes(q);
        });
      }

      function renderSpecializedSourceResults(items) {
        const sel = qs("specializedSourceResult");
        if (!sel) return;
        const rows = Array.isArray(items) ? items : [];
        if (!rows.length) {
          sel.innerHTML = '<option value="">(未找到匹配来源库项)</option>';
          return;
        }
        sel.innerHTML = rows
          .map((it) => `<option value="${escapeHtml(it.item_key)}">${escapeHtml(it.name || it.item_key)} (${escapeHtml(it.item_key)})</option>`)
          .join("");
      }

      function getSelectedSourceParams() {
        const item = getSelectedSourceItem();
        return item && item.params && typeof item.params === "object" ? item.params : {};
      }

      function getSourceItemKeywords(params) {
        const p = params && typeof params === "object" ? params : {};
        const candidates = [
          p.query_terms,
          p.keywords,
          p.search_keywords,
          p.base_keywords,
          p.topic_keywords,
        ];
        for (const raw of candidates) {
          const list = normalizeTextList(raw);
          if (list.length) return list;
        }
        return [];
      }

      function setSelectOptions(selectId, values, preferred = "") {
        const select = qs(selectId);
        const options = Array.from(new Set((values || []).map((v) => String(v || "").trim()).filter(Boolean)));
        if (!options.length) {
          select.innerHTML = '<option value="">(无可用选项)</option>';
          return;
        }
        select.innerHTML = options.map((v) => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
        if (preferred && options.includes(preferred)) {
          select.value = preferred;
        }
      }

      function setMultiSelectOptions(selectId, values, selectedValues = []) {
        const select = qs(selectId);
        const options = Array.from(new Set((values || []).map((v) => String(v || "").trim()).filter(Boolean)));
        if (!options.length) {
          select.innerHTML = "";
          return;
        }
        const selected = new Set((selectedValues || []).map((x) => String(x || "").trim()));
        select.innerHTML = options.map((v) => `<option value="${escapeHtml(v)}"${selected.has(v) ? " selected" : ""}>${escapeHtml(v)}</option>`).join("");
      }

      function refreshDropdownsFromSourceConfig() {
        const selectedParams = getSelectedSourceParams();
        const allParams = SOURCE_ITEMS.map((it) => (it && it.params && typeof it.params === "object" ? it.params : {}));
        const allPlatforms = allParams.flatMap((p) => normalizeTextList(p.platforms || p.platform));
        const allSubreddits = allParams.flatMap((p) => normalizeTextList(p.base_subreddits || p.subreddits));
        const preferredPlatform = normalizeTextList(selectedParams.platforms || selectedParams.platform)[0] || "reddit";
        const preferredSubreddits = normalizeTextList(selectedParams.base_subreddits || selectedParams.subreddits);
        setSelectOptions("socialPlatformSelect", allPlatforms.length ? allPlatforms : ["reddit"], preferredPlatform);
        setMultiSelectOptions(
          "baseSubredditsSelect",
          allSubreddits.length ? allSubreddits : ["MachineLearning", "robotics", "ArtificialInteligence", "singularity"],
          preferredSubreddits
        );

        // Prefer source-item keywords when the query box is empty (or still matches previous auto-fill).
        const queryInput = qs("queryTerms");
        if (queryInput) {
          const selectedKeywords = getSourceItemKeywords(selectedParams);
          const previousAuto = String(queryInput.dataset.sourceAutofill || "").trim();
          const currentValue = String(queryInput.value || "").trim();
          const canAutofill = !currentValue || (previousAuto && currentValue === previousAuto);
          if (selectedKeywords.length && canAutofill) {
            const nextValue = selectedKeywords.join(", ");
            queryInput.value = nextValue;
            queryInput.dataset.sourceAutofill = nextValue;
          } else if (!selectedKeywords.length && previousAuto && currentValue === previousAuto) {
            queryInput.value = "";
            queryInput.dataset.sourceAutofill = "";
          }
        }
      }

      async function loadSourceLibraryItems() {
        const projectKey = window.MarketApp.getProjectKey();
        const [itemsData, itemHandlerGroupedData, siteEntryGroupedData] = await Promise.all([
          window.MarketApp.fetchJSON(`/api/v1/source_library/items?scope=effective&project_key=${encodeURIComponent(projectKey)}`),
          window.MarketApp.fetchJSON(`/api/v1/source_library/items/grouped?scope=effective&project_key=${encodeURIComponent(projectKey)}`),
          window.MarketApp.fetchJSON(`/api/v1/resource_pool/site_entries/grouped?scope=effective&project_key=${encodeURIComponent(projectKey)}`),
        ]);
        const items = Array.isArray(itemsData?.items) ? itemsData.items.filter((x) => x && x.enabled !== false) : [];
        // For UI display, handler clusters are URL-entry clusters (resource_pool site_entries by entry_type).
        // Keep item-grouped handlers for compatibility/debug with ingest handler_batch behavior.
        const byHandlerForItems = (itemHandlerGroupedData && typeof itemHandlerGroupedData === "object" && itemHandlerGroupedData.by_handler && typeof itemHandlerGroupedData.by_handler === "object")
          ? itemHandlerGroupedData.by_handler
          : {};
        const byEntryType = (siteEntryGroupedData && typeof siteEntryGroupedData === "object" && siteEntryGroupedData.by_entry_type && typeof siteEntryGroupedData.by_entry_type === "object")
          ? siteEntryGroupedData.by_entry_type
          : {};
        SOURCE_ITEMS.length = 0;
        SOURCE_ITEMS.push(...items);
        const select = qs("sourceLibraryItem");
        const handlerSelect = qs("sourceLibraryHandlerSelect");
        const handlerDebug = qs("sourceLibraryHandlerDebug");
        const handlerKeys = Object.keys(byEntryType).sort();
        const fallbackHandlerCount = handlerKeys.filter((h) => h === "url_routing").length;
        if (handlerSelect) {
          handlerSelect.innerHTML = [
            '<option value="">(选择 Handler 聚类)</option>',
            ...handlerKeys.map((h) => {
              const count = Number(byEntryType?.[h]?.count || 0);
              return `<option value="${escapeHtml(h)}">${escapeHtml(h)} (${count})</option>`;
            }),
          ].join("");
        }
        if (handlerDebug) {
          const preview = handlerKeys.slice(0, 4).join(", ");
          const itemHandlerKinds = Object.keys(byHandlerForItems).length;
          handlerDebug.textContent = `URL聚类=${handlerKeys.length}, item映射分组=${itemHandlerKinds}${preview ? ` | ${preview}` : ""}`;
        }
        if (!SOURCE_ITEMS.length) {
          select.innerHTML = '<option value="">(暂无来源库项)</option>';
          renderSpecializedSourceResults([]);
          refreshDropdownsFromSourceConfig();
          return;
        }
        select.innerHTML = SOURCE_ITEMS.map((it) => `<option value="${escapeHtml(it.item_key)}">${escapeHtml(it.name || it.item_key)} (${escapeHtml(it.item_key)})</option>`).join("");
        if (INGEST_PAGE_MODE === "specialized") {
          renderSpecializedSourceResults(SOURCE_ITEMS.slice(0, 20));
        }
        refreshDropdownsFromSourceConfig();
      }

      async function fetchSuggestedKeywords(rawTerms, platform = null) {
        const cleaned = Array.isArray(rawTerms) ? rawTerms.map((x) => String(x || "").trim()).filter(Boolean) : [];
        if (!cleaned.length) return [];
        const topic = cleaned.join(" ");
        const topicFocus = getTopicFocus();
        const effectivePlatform = topicFocus ? null : platform;
        const payload = {
          topic,
          language: (getSearchLanguage() || "zh").trim() || "zh",
          platform: effectivePlatform,
          base_keywords: cleaned,
          ...(topicFocus ? { topic_focus: topicFocus } : {}),
        };
        const data = await window.MarketApp.fetchJSON("/api/v1/discovery/generate-keywords", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const searchKw = Array.isArray(data?.search_keywords) && data.search_keywords.length
          ? data.search_keywords
          : (Array.isArray(data?.keywords) ? data.keywords : []);
        return Array.from(new Set([...cleaned, ...searchKw.map((x) => String(x || "").trim()).filter(Boolean)]));
      }

      function showKeywordSuggestionModal(keywords) {
        qs("suggestedKeywordsText").value = keywords.join(", ");
        qs("keywordSuggestionModal").classList.add("active");
      }

      function hideKeywordSuggestionModal() {
        qs("keywordSuggestionModal").classList.remove("active");
      }

      function getConfirmedKeywordsFromModal() {
        const raw = String(qs("suggestedKeywordsText").value || "").trim();
        if (!raw) return [];
        return raw.split(",").map((v) => v.trim()).filter(Boolean);
      }

      function getActionSummaryCounts(data) {
        const root = (data && typeof data === "object") ? data : {};
        const nested = (root.result && typeof root.result === "object") ? root.result : null;
        const carrier = nested || root;
        return {
          inserted: Number(carrier.inserted || 0),
          updated: Number(carrier.updated || 0),
          skipped: Number(carrier.skipped || 0),
          errors: Array.isArray(carrier.errors) ? carrier.errors.length : 0,
        };
      }

      function getHandlerBatchSummary(data) {
        const root = (data && typeof data === "object") ? data : {};
        const payload = (root.result && typeof root.result === "object") ? root.result : root;
        if (!payload || payload.mode !== "handler_batch") return null;
        const itemKeys = Array.isArray(payload.item_keys) ? payload.item_keys : [];
        const tasks = Array.isArray(payload.tasks) ? payload.tasks : [];
        const results = Array.isArray(payload.results) ? payload.results : [];
        return {
          handlerKey: String(payload.handler_key || ""),
          itemCount: itemKeys.length,
          asyncCount: tasks.length,
          resultCount: results.length,
        };
      }

      async function runAction(actionName, req) {
        toggleDisabled(["btnPolicy", "btnPolicyRegulation", "btnMarket", "btnCommodity", "btnEcom", "btnSocial", "btnSyncSourceLibrary", "btnRunSourceLibraryItem", "btnRunSourceLibraryHandler"], true);
        setLoading("actionStatus", `${actionName}执行中...`);
        try {
          const data = await req();
          if (data.task_id) {
            setSuccess("actionStatus", `${actionName}已提交，任务ID: ${data.task_id}`);
          } else {
            const handlerBatch = getHandlerBatchSummary(data);
            if (handlerBatch) {
              const executed = handlerBatch.asyncCount || handlerBatch.resultCount || handlerBatch.itemCount;
              setSuccess(
                "actionStatus",
                `${actionName}完成（entry_type=${handlerBatch.handlerKey || "-"}，命中 ${formatNumber(handlerBatch.itemCount)} 个 item，执行 ${formatNumber(executed)} 项）`
              );
              await loadHistory();
              return;
            }
            const counts = getActionSummaryCounts(data);
            const errorSuffix = counts.errors ? `，错误 ${formatNumber(counts.errors)}` : "";
            setSuccess(
              "actionStatus",
              `${actionName}完成，新增 ${formatNumber(counts.inserted)}，更新 ${formatNumber(counts.updated)}，跳过 ${formatNumber(counts.skipped)}${errorSuffix}`
            );
          }
          await loadHistory();
        } catch (error) {
          setError("actionStatus", `${actionName}失败: ${error.message}`);
        } finally {
          toggleDisabled(["btnPolicy", "btnPolicyRegulation", "btnMarket", "btnCommodity", "btnEcom", "btnSocial", "btnSyncSourceLibrary", "btnRunSourceLibraryItem", "btnRunSourceLibraryHandler"], false);
        }
      }

      async function syncSourceLibraryFromFiles() {
        const projectKey = window.MarketApp.getProjectKey();
        return await window.MarketApp.fetchJSON("/api/v1/ingest/source-library/sync", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ project_key: projectKey || "" }),
        });
      }

      function buildOverrideParamsFromForm() {
        const overrides = {};
        const limit = getSocialLimit();
        if (limit != null) {
          overrides.limit = limit;
          overrides.max_items = limit;
        }
        let terms = getQueryTerms();
        if (!terms.length) {
          terms = getSourceItemKeywords(getSelectedSourceParams());
        }
        if (terms.length) {
          overrides.query_terms = terms;
          overrides.keywords = terms;
          // Keep keyword aliases in sync because different source-library channels/items
          // may read different field names.
          overrides.search_keywords = terms;
          overrides.base_keywords = terms;
          overrides.topic_keywords = terms;
        }
        const so = getStartOffset();
        if (so != null) overrides.start_offset = so;
        const db = getDaysBack();
        if (db != null) overrides.days_back = db;
        const lang = getSearchLanguage();
        if (lang) overrides.language = lang;
        const prov = getSearchProvider();
        if (prov) overrides.provider = prov;
        overrides.enable_extraction = getEnableExtraction();
        const baseSubs = getBaseSubreddits();
        if (baseSubs && baseSubs.length) overrides.base_subreddits = baseSubs;
        const platforms = getSocialPlatforms();
        if (platforms && platforms.length) overrides.platforms = platforms;
        overrides.enable_subreddit_discovery = getEnableSubredditDiscovery();
        return overrides;
      }

      async function runSelectedSourceLibraryItem() {
        const projectKey = window.MarketApp.getProjectKey();
        const itemKey = String(qs("sourceLibraryItem").value || "").trim();
        const handlerKey = String(qs("sourceLibraryHandlerSelect")?.value || "").trim();
        if (!itemKey && !handlerKey) throw new Error("请先选择一个来源库项或输入 handler_key");
        if (itemKey && handlerKey) throw new Error("来源库项与 handler_key 只能二选一");
        if (!projectKey) throw new Error("请先选择项目（project_key）");
        const payload = {
          item_key: itemKey || null,
          handler_key: handlerKey || null,
          project_key: projectKey,
          async_mode: !!qs("asyncMode").checked,
          override_params: buildOverrideParamsFromForm(),
        };
        return await window.MarketApp.fetchJSON("/api/v1/ingest/source-library/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      }

      async function runSelectedSourceLibraryHandler() {
        const projectKey = window.MarketApp.getProjectKey();
        const handlerKey = String(qs("sourceLibraryHandlerSelect")?.value || "").trim();
        if (!handlerKey) throw new Error("请先选择 Handler 聚类（entry_type）");
        if (!projectKey) throw new Error("请先选择项目（project_key）");
        const payload = {
          item_key: null,
          handler_key: handlerKey,
          project_key: projectKey,
          async_mode: !!qs("asyncMode").checked,
          override_params: buildOverrideParamsFromForm(),
        };
        return await window.MarketApp.fetchJSON("/api/v1/ingest/source-library/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      }

      async function requestMarketIngest(rawTerms) {
        const queryTerms = Array.isArray(rawTerms) ? rawTerms : getQueryTerms();
        if (!queryTerms.length) throw new Error("请先输入查询词（逗号分隔）");
        const body = {
          query_terms: queryTerms,
          keywords: queryTerms,
          max_items: getSocialLimit(),
          limit: getSocialLimit(),
          async_mode: getAsyncMode(),
          enable_extraction: getEnableExtraction(),
          project_key: window.MarketApp.getProjectKey(),
        };
        const so = getStartOffset(); if (so != null) body.start_offset = so;
        const db = getDaysBack(); if (db != null) body.days_back = db;
        const lang = getSearchLanguage(); if (lang) body.language = lang;
        const prov = getSearchProvider(); if (prov) body.provider = prov;
        return window.MarketApp.fetchJSON("/api/v1/ingest/market", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
      }

      async function requestSocialIngest(rawTerms) {
        const queryTerms = Array.isArray(rawTerms) ? rawTerms : getQueryTerms();
        if (!queryTerms.length) throw new Error("请先输入查询词（逗号分隔）");
        const body = {
          query_terms: queryTerms,
          keywords: queryTerms,
          platforms: getSocialPlatforms(),
          max_items: getSocialLimit(),
          limit: getSocialLimit(),
          async_mode: getAsyncMode(),
          enable_extraction: getEnableExtraction(),
          enable_subreddit_discovery: getEnableSubredditDiscovery(),
          base_subreddits: getBaseSubreddits(),
          project_key: window.MarketApp.getProjectKey(),
        };
        return window.MarketApp.fetchJSON("/api/v1/ingest/social/sentiment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
      }

      async function requestCommodityIngest() {
        return window.MarketApp.fetchJSON("/api/v1/ingest/commodity/metrics", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            limit: getCommodityLimit(),
            async_mode: getAsyncMode(),
            project_key: window.MarketApp.getProjectKey(),
          }),
        });
      }

      async function requestEcomIngest() {
        return window.MarketApp.fetchJSON("/api/v1/ingest/ecom/prices", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            limit: getEcomLimit(),
            async_mode: getAsyncMode(),
            project_key: window.MarketApp.getProjectKey(),
          }),
        });
      }

      async function loadHistory() {
        setLoading("historyContainer", "加载任务历史...");
        try {
          const data = await window.MarketApp.fetchJSON("/api/v1/ingest/history?limit=8");
          if (!Array.isArray(data) || !data.length) {
            setEmpty("historyContainer", "暂无任务历史");
            return;
          }
          const rows = data
            .map((job) => {
              const statusClass = job.status === "completed" ? "success" : job.status === "failed" ? "danger" : "warning";
              return `
                <tr>
                  <td><code>${escapeHtml(String(job.id))}</code></td>
                  <td>${escapeHtml(job.job_type || "-")}</td>
                  <td><span class="badge ${statusClass}">${escapeHtml(job.status || "-")}</span></td>
                  <td>${toDateTime(job.started_at)}</td>
                  <td>${toDateTime(job.finished_at)}</td>
                </tr>
              `;
            })
            .join("");
          qs("historyContainer").innerHTML = `
            <table>
              <thead><tr><th>ID</th><th>任务类型</th><th>状态</th><th>开始时间</th><th>结束时间</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          `;
        } catch (error) {
          setError("historyContainer", `加载失败: ${error.message}`);
        }
      }

      qs("btnPolicy").addEventListener("click", () =>
        runAction("政策采集", () => {
          const sourceParams = getSelectedSourceParams();
          const state = String(sourceParams.state || "").trim();
          if (!state) {
            throw new Error("所选来源库项缺少 state 配置，无法执行政策采集。");
          }
          return window.MarketApp.fetchJSON("/api/v1/ingest/policy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              state,
              async_mode: getAsyncMode(),
              source_hint: String(sourceParams.source_hint || "").trim() || null,
              project_key: window.MarketApp.getProjectKey(),
            }),
          });
        })
      );

      qs("btnSuggestKeywords").addEventListener("click", () => {
        triggerSuggestKeywordsFlow();
      });

      qs("btnCancelSuggestion").addEventListener("click", hideKeywordSuggestionModal);
      qs("btnConfirmSuggestion").addEventListener("click", () => {
        const confirmed = getConfirmedKeywordsFromModal();
        if (confirmed.length) {
          qs("queryTerms").value = confirmed.join(", ");
          setSuccess("actionStatus", `已确认 ${confirmed.length} 个查询词，可执行采集`);
        }
        hideKeywordSuggestionModal();
      });
      qs("keywordSuggestionModal").addEventListener("click", (e) => {
        if (e.target.id === "keywordSuggestionModal") hideKeywordSuggestionModal();
      });

      qs("searchLanguageBtn")?.addEventListener("click", (e) => {
        e.stopPropagation();
        qs("searchLanguageMulti")?.classList.toggle("open");
      });
      qs("searchLanguagePanel")?.addEventListener("click", (e) => {
        e.stopPropagation();
      });
      qs("searchLanguagePanel")?.querySelectorAll('input[type="checkbox"]').forEach((el) => {
        el.addEventListener("change", updateSearchLanguageButtonLabel);
      });
      document.addEventListener("click", () => {
        qs("searchLanguageMulti")?.classList.remove("open");
      });
      updateSearchLanguageButtonLabel();

      qs("btnMarket").addEventListener("click", () => {
        const rawTerms = getQueryTerms();
        if (!rawTerms.length) {
          setError("actionStatus", "请先输入查询词（逗号分隔）");
          return;
        }
        runAction("市场采集", () => requestMarketIngest(rawTerms));
      });

      qs("btnPolicyRegulation").addEventListener("click", () => {
        const rawTerms = getQueryTerms();
        if (!rawTerms.length) {
          setError("actionStatus", "请先输入查询词（逗号分隔）");
          return;
        }
        runAction("政策法规采集", async () => {
          const queryTerms = rawTerms;
          const body = {
            query_terms: queryTerms,
            keywords: queryTerms,
            max_items: getSocialLimit(),
            limit: getSocialLimit(),
            async_mode: getAsyncMode(),
            enable_extraction: getEnableExtraction(),
            project_key: window.MarketApp.getProjectKey(),
          };
          const so = getStartOffset(); if (so != null) body.start_offset = so;
          const db = getDaysBack(); if (db != null) body.days_back = db;
          const lang = getSearchLanguage(); if (lang) body.language = lang;
          const prov = getSearchProvider(); if (prov) body.provider = prov;
          return window.MarketApp.fetchJSON("/api/v1/ingest/policy/regulation", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
        });
      });

      qs("btnCommodity").addEventListener("click", () =>
        runAction("商品采集", () => requestCommodityIngest())
      );

      qs("btnEcom").addEventListener("click", () =>
        runAction("电商/经营采集", () => requestEcomIngest())
      );

      qs("btnSocial").addEventListener("click", () => {
        const rawTerms = getQueryTerms();
        if (!rawTerms.length) {
          setError("actionStatus", "请先输入查询词（逗号分隔）");
          return;
        }
        runAction("舆情采集", () => requestSocialIngest(rawTerms));
      });

      qs("refreshHistory").addEventListener("click", loadHistory);
      qs("gotoProcess").addEventListener("click", () => window.MarketApp.navigateInShell("process-management.html"));
      qs("sourceLibraryItem").addEventListener("change", refreshDropdownsFromSourceConfig);
      qs("sourceLibraryHandlerSelect")?.addEventListener("change", () => {
        const v = String(qs("sourceLibraryHandlerSelect")?.value || "").trim();
        if (!v) return;
        const itemSel = qs("sourceLibraryItem");
        if (itemSel) itemSel.value = "";
      });
      qs("btnSyncSourceLibrary").addEventListener("click", () =>
        runAction("同步来源库", async () => {
          const res = await syncSourceLibraryFromFiles();
          await loadSourceLibraryItems();
          return res;
        })
      );
      qs("btnRunSourceLibraryItem").addEventListener("click", () =>
        runAction("运行来源库项", runSelectedSourceLibraryItem)
      );
      qs("btnRunSourceLibraryHandler")?.addEventListener("click", () =>
        runAction("运行 Handler 聚类", runSelectedSourceLibraryHandler)
      );
      qs("queryTerms")?.addEventListener("input", () => {
        const el = qs("queryTerms");
        if (!el) return;
        const current = String(el.value || "").trim();
        const auto = String(el.dataset.sourceAutofill || "").trim();
        if (!auto) return;
        if (current !== auto) {
          el.dataset.sourceAutofill = "";
        }
      });

      window.addEventListener("DOMContentLoaded", async () => {
        applyIngestPageMode();
        const prefilledTerms = applyGraphSelectionPrefill();
        maybeAutoSuggestFromGraph(prefilledTerms);
        lucide.createIcons();
        qs("btnRunSpecializedIngest")?.addEventListener("click", () => {
          const selected = String(qs("topicFocus")?.value || "").trim();
          const label = selected === "product" ? "商品" : (selected === "operation" ? "电商/经营" : "默认");
          const specializedSourceKey = String(qs("specializedSourceResult")?.value || "").trim();
          if (specializedSourceKey) {
            const sourceSel = qs("sourceLibraryItem");
            if (sourceSel) sourceSel.value = specializedSourceKey;
            refreshDropdownsFromSourceConfig();
            setSuccess("actionStatus", `当前联想专题=${label}，优先执行来源库项...`);
            runAction("运行来源库项（特化）", runSelectedSourceLibraryItem);
            return;
          }
          setSuccess("actionStatus", `当前联想专题=${label}，开始统一采集...`);
          qs("btnMarket")?.click();
        });
        qs("btnSpecializedSourceSearch")?.addEventListener("click", () => {
          const kw = String(qs("specializedSourceSearch")?.value || "").trim();
          const baseRows = kw ? filterSourceItemsByKeyword(kw) : SOURCE_ITEMS.slice(0, 50);
          const rows = baseRows;
          renderSpecializedSourceResults(rows);
          if (!rows.length) setError("actionStatus", "未找到匹配的信息源库项");
          else setSuccess("actionStatus", `已匹配 ${rows.length} 个来源库项`);
        });
        qs("specializedSourceSearch")?.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            qs("btnSpecializedSourceSearch")?.click();
          }
        });
        qs("btnSpecializedUseSource")?.addEventListener("click", () => {
          const key = String(qs("specializedSourceResult")?.value || "").trim();
          if (!key) {
            setError("actionStatus", "请先选择一个来源库项");
            return;
          }
          const sourceSel = qs("sourceLibraryItem");
          if (sourceSel) sourceSel.value = key;
          refreshDropdownsFromSourceConfig();
          setSuccess("actionStatus", `已选中来源库项：${key}`);
        });
        qs("btnSpecializedRunSource")?.addEventListener("click", () => {
          const key = String(qs("specializedSourceResult")?.value || "").trim();
          if (!key) {
            setError("actionStatus", "请先选择一个来源库项");
            return;
          }
          const sourceSel = qs("sourceLibraryItem");
          if (sourceSel) sourceSel.value = key;
          refreshDropdownsFromSourceConfig();
          runAction("运行来源库项（特化）", runSelectedSourceLibraryItem);
        });
        try {
          await loadSourceLibraryItems();
        } catch (error) {
          setError("actionStatus", `来源库加载失败: ${error.message}`);
        }
        loadHistory();
      });
    </script>
  </body>
</html>
