# 修复脚本改进效果对比报告

## 执行时间
2025-11-06

## 一、改进前后对比

### 1.1 总体统计

| 指标 | 改进前 | 改进后 | 提升 |
|------|--------|--------|------|
| 检查文档数 | 81 | 81 | - |
| 可提取文档数 | 7 | 8 | +1 (+14.3%) |
| 可提取率 | 8.6% | 9.9% | +1.3% |
| 跳过文档数 | 74 | 73 | -1 |

### 1.2 提取来源对比

| 提取来源 | 改进前 | 改进后 | 变化 |
|----------|--------|--------|------|
| URL | 0 | 1 | +1 |
| HTML内容 | 7 | 7 | 持平 |
| extracted_data | 0 | 0 | 持平 |

## 二、改进内容

### 2.1 新增功能

1. **增强文本内容提取**
   - ✅ 新增 `extract_date_from_text()` 函数
   - ✅ 支持美式日期格式 (MM/DD/YYYY)
   - ✅ 支持英文月份格式 (January 15, 2024)
   - ✅ 支持英文月份缩写格式 (Jan 15, 2024)

2. **改进HTML解析**
   - ✅ 检查time标签的文本内容（不仅仅是datetime属性）
   - ✅ 检查常见的日期CSS类或ID
   - ✅ 从HTML文本内容中提取日期（提取所有文本后分析）
   - ✅ 如果HTML解析失败，回退到纯文本提取

3. **完善extracted_data检查**
   - ✅ 扩展日期字段列表（从6个增加到13个）
   - ✅ 扩展嵌套对象列表（从2个增加到5个）
   - ✅ 支持更多日期格式解析

### 2.2 新增支持的日期格式

**文本格式**:
- ISO格式: `2024-01-15`
- 斜杠格式: `2024/01/15`
- 美式格式: `01/15/2024` 或 `1/15/2024`
- 英文月份: `January 15, 2024`
- 英文月份缩写: `Jan 15, 2024`

**新增字段名**:
- `pub_date`, `pubDate`, `publishedAt`, `published_at`
- `created_at`, `updated_at`, `last_updated`
- `report_date`, `release_date`, `announcement_date`

**新增嵌套对象**:
- `article`, `metadata`, `info`

## 三、成功提取的文档示例

### 3.1 从URL提取

**文档7**: `Lone Star Crackdown...`
- URL: `https://www.regulatoryoversight.com/2025/04/lone-star-crackdown...`
- 提取日期: `2025-04-07`
- 提取方法: URL路径中的日期 (`/2025/04/`)

### 3.2 从HTML文本内容提取

**文档11**: `California State Lottery (CA Lottery)`
- URL: `https://www.ca.gov/departments/155/`
- 提取日期: `2025-10-07`
- 提取方法: 文本中的"Last updated 10/07/2025"

**文档6**: `Lottery jackpots could soon be easier...`
- URL: `https://www.cbsnews.com/sacramento/news/...`
- 提取日期: `2025-01-22`
- 提取方法: 文本中的"January 22, 2025"

**文档18**: `California's Luckiest Spots...`
- URL: `https://www.webpronews.com/californias-luckiest-spots...`
- 提取日期: `2025-10-24`
- 提取方法: HTML文本内容中的日期

**文档26**: `CA Lottery Official App`
- URL: `https://play.google.com/store/apps/details?...`
- 提取日期: `2020-01-23`
- 提取方法: HTML文本内容中的日期

**文档29**: `Powerball ticket worth $1.8 million...`
- URL: `https://www.foxla.com/news/powerball-ticket...`
- 提取日期: `2025-10-30`
- 提取方法: HTML文本内容中的日期

**文档35**: `Powerball | California State Lottery`
- URL: `https://www.calottery.com/en/draw-games/powerball`
- 提取日期: `2025-11-01`
- 提取方法: HTML文本内容中的日期

**文档148**: `Lottery Statistics and Revenue...`
- URL: `https://www.fool.com/money/research/lottery-statistics/`
- 提取日期: `2025-05-15`
- 提取方法: HTML文本内容中的日期

## 四、仍无法提取的文档分析

### 4.1 主要问题来源

1. **calottery.com 相关文档** (25个)
   - 这些文档通常是静态页面（FAQ、首页等）
   - 可能没有明确的发布日期
   - 建议: 使用 `created_at` 作为备选

2. **Reddit Social Sentiment** (11个)
   - Reddit帖子通常有时间戳，但当前数据中可能没有保存
   - 建议: 从Reddit API重新获取时间戳

3. **Google News Policy** (7个)
   - 新闻文章通常有发布日期，但可能不在保存的content中
   - 建议: 重新抓取页面或从搜索结果中提取

### 4.2 改进建议

1. **短期** (立即实施):
   - ✅ 已完成：改进文本提取逻辑
   - 🔄 待实施：对无法提取的文档使用 `created_at` 作为备选

2. **中期** (1周内):
   - 针对Reddit来源，从API获取时间戳
   - 针对calottery.com，分析其特定HTML结构
   - 对无法提取的文档启用重新抓取

3. **长期** (1个月内):
   - 改进数据摄取流程，在摄取时就提取发布日期
   - 建立日期提取规则库
   - 使用LLM辅助提取复杂格式

## 五、下一步行动

### 5.1 立即执行

1. **应用修复**:
   ```bash
   python scripts/fix_publish_dates.py --limit=81
   ```
   这将修复8个可以提取日期的文档

2. **备选方案**:
   对于剩余的73个文档，可以考虑：
   - 使用 `created_at` 日期作为 `publish_date`
   - 或者标记为需要人工审核

### 5.2 后续改进

1. **改进数据摄取流程** (`app/services/discovery/store.py`)
   - 应用相同的改进逻辑到 `_extract_publish_date` 函数
   - 确保新摄取的文档能够正确提取发布日期

2. **批量处理剩余文档**
   - 启用重新抓取功能
   - 针对特定来源定制提取逻辑

## 六、总结

改进后的脚本在以下方面有所提升：

✅ **功能增强**:
- 支持更多日期格式
- 更全面的HTML解析
- 更完善的extracted_data检查

✅ **提取能力提升**:
- 可提取率从8.6%提升到9.9%
- 新增从URL提取的能力
- 文本提取更加准确

⚠️ **仍需改进**:
- 仍有73个文档无法提取（90.1%）
- 需要针对特定来源定制提取逻辑
- 需要改进数据摄取流程

**建议**: 先应用当前改进，修复8个文档，然后继续改进数据摄取流程和针对特定来源的提取逻辑。

