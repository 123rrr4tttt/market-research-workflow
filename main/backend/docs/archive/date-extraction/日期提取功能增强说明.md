# 日期提取功能增强说明

## 更新日期
2025-11-07

## 概述

根据实际页面检查结果，已将能够获取直接发布日期的所有功能集成到数据摄取流程中，大幅提升了日期提取的准确性和覆盖率。

## 增强的功能

### 1. URL日期提取增强

**文件**: `app/services/discovery/store.py` - `_extract_date_from_url()`

**新增功能**:
- ✅ PDF文件名日期提取
  - 支持格式: `YYYY-MM-DD`, `YYYYMMDD`, `YYYY_MM_DD`
  - 支持格式: `MM-DD-YY` → 自动转换为 `20YY-MM-DD`
  - 支持格式: `MM-DD-YYYY`
- ✅ 财政年度格式提取
  - 格式: `FY 2023-24` → 转换为 `2023-07-01`（财政年度开始日期）

**示例**:
- `Lottery-Retailer-Policies--3-3-14.pdf` → `2014-03-03`
- `FY-2023-24-report.pdf` → `2023-07-01`

### 2. HTML日期提取增强

**文件**: `app/services/discovery/store.py` - `_extract_date_from_html()`

**改进**:
- ✅ **Meta标签优先级优化**
  - 按优先级排序: Open Graph > Schema.org > Dublin Core
  - 优先使用 `article:published_time` (Open Graph)
  - 其次使用 `itemprop="datePublished"` (Schema.org)
  
- ✅ **JSON-LD结构化数据增强**
  - 递归检查嵌套对象
  - 支持多种日期字段: `datePublished`, `publishedTime`, `dateCreated`, `dateModified`
  - 支持数组格式的JSON-LD数据
  
- ✅ **日期格式支持增强**
  - 支持时区格式: `2025-03-25T18:13:56+00:00`
  - 支持微秒格式: `2025-03-25T18:13:56.000Z`
  - 支持多种ISO 8601变体

- ✅ **Time标签增强**
  - 检查多个time标签（前5个）
  - 支持时区格式

**示例**:
- Meta标签: `<meta property="article:published_time" content="2025-03-25T18:13:56+00:00">` → `2025-03-25`
- JSON-LD: `{"datePublished": "2025-03-25T18:13:56+00:00"}` → `2025-03-25`

### 3. HTTP响应头日期提取（新增）

**文件**: `app/services/discovery/store.py` - `_extract_date_from_http_headers()`

**新增功能**:
- ✅ 提取HTTP响应头中的 `Last-Modified`
- ✅ 特别适用于PDF文件（PDF文件通常没有HTML meta标签）
- ✅ 使用HEAD请求获取响应头（不下载完整内容）

**示例**:
- PDF文件响应头: `Last-Modified: Mon, 13 Jan 2025 22:56:12 GMT` → `2025-01-13`

### 4. 文本内容日期提取增强

**文件**: `app/services/discovery/store.py` - `_extract_date_from_text()`

**新增功能**:
- ✅ **带上下文的日期提取**（优先级最高）
  - 支持关键词: "Published", "Last updated", "Effective", "Date", "发布日期", "最后更新", "生效日期"
  - 格式: `Published: 3/25/2025` → `2025-03-25`
  - 格式: `Last updated: 2025-03-25` → `2025-03-25`
  
- ✅ **更多日期格式支持**
  - ISO格式: `2024-01-15`
  - 美式格式: `01/15/2024`
  - 英文月份格式: `January 15, 2024`
  - 英文月份缩写: `Jan 15, 2024`

- ✅ **优先级排序**
  - 带上下文的日期优先
  - 其他格式按找到顺序返回

**示例**:
- `Published: Mar 25, 2025` → `2025-03-25`（高优先级）
- `Last updated: 3/25/2025` → `2025-03-25`（高优先级）

### 5. extracted_data日期提取增强

**文件**: `app/services/discovery/store.py` - `_extract_publish_date()`

**改进**:
- ✅ **递归检查嵌套对象**
  - 检查 `policy.publish_date`
  - 检查 `market.report_date`
  - 检查 `article.datePublished`
  - 检查 `metadata.date`
  
- ✅ **更多日期字段支持**
  - `publish_date`, `published_date`, `date`, `effective_date`
  - `publication_date`, `pub_date`, `pubDate`, `publishedAt`

### 6. 数据摄取流程集成

**文件**: `app/services/discovery/store.py` - `store_results()`

**改进**:
- ✅ `_fetch_content()` 现在返回HTTP响应头
- ✅ 新文档创建时使用增强的日期提取
- ✅ 现有文档更新时也使用增强的日期提取
- ✅ 所有日期提取方法按优先级顺序尝试

## 提取优先级顺序

1. **URL日期**（包括PDF文件名）
2. **HTML Meta标签和JSON-LD**（Open Graph > Schema.org > Dublin Core）
3. **HTTP响应头**（Last-Modified）
4. **extracted_data**（包括嵌套对象）
5. **文本内容**（带上下文的日期优先）

## 实际效果

基于实际页面检查结果：

### ✅ 成功提取的案例

1. **KTLA新闻文章**
   - URL: `https://ktla.com/news/california/...`
   - 提取方法: Meta标签 `article:published_time`
   - 结果: `2025-03-25` ✅

2. **PDF文件**
   - URL: `.../Lottery-Retailer-Policies--3-3-14.pdf`
   - 提取方法: 文件名日期 + HTTP Last-Modified
   - 结果: `2014-03-03` 或 `2025-01-13` ✅

### ⚠️ 需要备选方案的案例

1. **静态FAQ页面**
   - URL: `https://www.calottery.com/en/faqs`
   - 提取方法: 无可用日期信息
   - 备选: 使用 `created_at` ✅

2. **动态结果页面**
   - URL: `https://jackpocket.com/lottery-results/california`
   - 提取方法: 无可用日期信息
   - 备选: 使用 `created_at` ✅

## 代码变更总结

### 修改的文件
- `app/services/discovery/store.py`

### 新增函数
- `_extract_date_from_http_headers()` - HTTP响应头日期提取
- `_extract_date_from_text()` - 增强的文本日期提取

### 增强的函数
- `_extract_date_from_url()` - 支持PDF文件名和财政年度
- `_extract_date_from_html()` - 改进优先级和格式支持
- `_extract_publish_date()` - 集成所有提取方法
- `_fetch_content()` - 返回HTTP响应头

## 测试建议

1. **测试新闻网站**: 验证Open Graph和JSON-LD提取
2. **测试PDF文件**: 验证文件名和HTTP响应头提取
3. **测试静态页面**: 验证备选方案（created_at）
4. **测试文本内容**: 验证带上下文的日期提取

## 后续改进建议

1. **PDF元数据提取**: 集成PyPDF2/pypdf库提取PDF内部元数据
2. **Google News处理**: 访问重定向URL获取实际文章日期
3. **LLM辅助提取**: 对于复杂格式，使用LLM识别发布日期
4. **监控和告警**: 监控新摄取文档的日期提取率

## 参考文档

- `docs/剩余文档日期提取分析报告.md` - 详细的分析报告
- `scripts/actual_dates_check.json` - 实际页面检查结果
- `scripts/fix_publish_dates.py` - 批量修复脚本（已同步增强）

