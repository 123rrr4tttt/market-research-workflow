# 文档发布日期提取分析报告

## 执行时间
2025-11-06

## 一、问题概述

调查发现数据库中有 **81 个文档**缺少 `publish_date` 字段，占总文档的一定比例。这些文档无法在前端正确显示发布日期，影响用户体验。

## 二、调查结果

### 2.1 基本情况统计

- **缺失发布日期的文档总数**: 81 个
- **可提取率**: 8.6% (7/81)
- **数据可用性**:
  - 有 URL: 81 (100%)
  - 有 content: 55 (67.9%)
  - 有 extracted_data: 47 (58.0%)

### 2.2 按来源分布

| 来源 | 数量 | 占比 |
|------|------|------|
| static.www.calottery.com | 16 | 19.8% |
| Reddit Social Sentiment | 11 | 13.6% |
| www.calottery.com | 9 | 11.1% |
| Google News Policy | 7 | 8.6% |
| 其他来源 | 38 | 46.9% |

### 2.3 按文档类型分布

| 文档类型 | 数量 | 占比 |
|----------|------|------|
| market | 37 | 45.7% |
| policy | 29 | 35.8% |
| social_sentiment | 11 | 13.6% |
| external | 3 | 3.7% |
| market_report | 1 | 1.2% |

### 2.4 日期来源分析（30个样本）

| 日期来源 | 可提取数量 | 占比 |
|----------|-----------|------|
| URL | 1 | 3.3% |
| HTML meta标签 | 0 | 0% |
| 文本内容 | 5 | 16.7% |
| extracted_data | 0 | 0% |
| 无法找到 | 25 | 83.3% |

## 三、发布日期可能存在的位置

基于深度分析，发布日期可能存在于以下位置：

### 3.1 URL 中

**常见模式**:
- `/2024/01/15/article` - 路径中的日期
- `/2024-01-15/article` - 路径中的日期（连字符）
- `?date=2024-01-15` - 查询参数

**示例**:
- `https://example.com/2025/04/07/article-title`

**提取难度**: ⭐⭐ (中等)
- 优点: 格式相对固定，易于解析
- 缺点: 只有少数网站使用这种URL结构

### 3.2 HTML Meta 标签中

**常见标签**:
- `<meta property="article:published_time" content="2024-01-15T10:00:00Z">`
- `<meta property="og:published_time" content="2024-01-15T10:00:00Z">`
- `<meta name="publish-date" content="2024-01-15">`
- `<meta itemprop="datePublished" content="2024-01-15">`

**提取难度**: ⭐ (简单)
- 优点: 标准化的元数据，解析准确
- 缺点: 不是所有网站都提供

### 3.3 HTML 结构化数据中

**JSON-LD 格式**:
```json
{
  "@type": "Article",
  "datePublished": "2024-01-15T10:00:00Z"
}
```

**提取难度**: ⭐ (简单)
- 优点: 结构化数据，解析准确
- 缺点: 只有部分网站使用

### 3.4 HTML 文本内容中

**常见位置**:
- `<time datetime="2024-01-15">January 15, 2024</time>`
- `<span class="date">2024-01-15</span>`
- 正文中的日期文本: "Published on January 15, 2024"
- "Last updated 10/07/2025"

**常见格式**:
- ISO格式: `2024-01-15`
- 美式格式: `01/15/2024` 或 `1/15/2024`
- 英文格式: `January 15, 2024` 或 `Jan 15, 2024`

**提取难度**: ⭐⭐⭐ (困难)
- 优点: 大多数网站都有
- 缺点: 格式多样，需要复杂的正则表达式和上下文分析

### 3.5 extracted_data 中

**可能字段**:
- `publish_date`
- `published_date`
- `date`
- `effective_date`
- `policy.publish_date`
- `market.report_date`

**提取难度**: ⭐ (简单)
- 优点: 如果存在，格式通常标准化
- 缺点: 当前数据中很少包含这些字段

### 3.6 特殊来源

**Reddit**:
- 可以从 Reddit API 获取 `created_utc` 时间戳
- URL格式: `https://www.reddit.com/r/subreddit/comments/...`

**新闻网站**:
- 通常有明确的发布日期显示
- 可能在文章开头或结尾

**政府网站**:
- 可能有"最后更新"日期
- 可能有"生效日期"和"发布日期"

## 四、当前提取流程的问题

### 4.1 现有实现 (`app/services/discovery/store.py`)

当前 `_extract_publish_date` 函数的提取顺序：
1. ✅ 从URL中提取
2. ✅ 从HTML meta标签中提取
3. ✅ 从extracted_data中提取
4. ⚠️ 从内容文本中提取（实现不完整）

### 4.2 存在的问题

1. **文本内容提取不完整**
   - 只检查前2000字符
   - 正则表达式模式有限
   - 没有处理美式日期格式 (MM/DD/YYYY)
   - 没有处理"Last updated"等上下文

2. **HTML解析不充分**
   - 没有检查 `<time>` 标签的文本内容
   - 没有检查常见的日期CSS类
   - 没有提取HTML文本后再分析

3. **extracted_data 检查不全面**
   - 没有检查嵌套对象（如 `policy.effective_date`）
   - 字段列表不完整

4. **缺少备选方案**
   - 如果所有方法都失败，没有使用 `created_at` 作为备选

## 五、改进方案

### 5.1 短期改进（立即实施）

1. **增强文本内容提取**
   - 支持更多日期格式（美式、英文月份等）
   - 增加上下文分析（"Published on", "Last updated"等）
   - 检查HTML文本内容，而不仅仅是meta标签

2. **完善 extracted_data 检查**
   - 检查嵌套对象中的日期字段
   - 增加更多可能的字段名

3. **添加备选方案**
   - 如果无法提取，使用 `created_at` 日期作为 `publish_date`

### 5.2 中期改进（1-2周内）

1. **针对特定来源的定制提取**
   - Reddit: 从API获取时间戳
   - calottery.com: 分析其特定的HTML结构
   - Google News: 从搜索结果中提取日期

2. **改进数据摄取流程**
   - 在摄取时保存完整的HTML内容
   - 在摄取时提取并保存发布日期到 extracted_data

3. **批量修复现有数据**
   - 运行改进后的提取脚本
   - 对无法提取的文档使用 created_at

### 5.3 长期改进（1个月内）

1. **使用LLM辅助提取**
   - 对于复杂格式，使用LLM识别发布日期
   - 提高准确率

2. **建立日期提取规则库**
   - 为每个主要来源建立提取规则
   - 定期更新和维护

3. **监控和告警**
   - 监控新摄取文档的 publish_date 提取率
   - 如果提取率下降，及时告警

## 六、实施建议

### 6.1 优先级

1. **高优先级**（立即）:
   - 改进 `_extract_publish_date` 函数
   - 批量修复现有81个文档

2. **中优先级**（本周内）:
   - 针对主要来源定制提取逻辑
   - 改进数据摄取流程

3. **低优先级**（本月内）:
   - LLM辅助提取
   - 建立规则库

### 6.2 预期效果

- **短期**: 可提取率从 8.6% 提升到 40-50%
- **中期**: 可提取率提升到 70-80%
- **长期**: 可提取率达到 90%+

## 七、附录

### 7.1 分析脚本

- `scripts/investigate_missing_publish_dates.py` - 调查缺失发布日期的文档
- `scripts/analyze_date_sources.py` - 深度分析日期来源
- `scripts/fix_publish_dates.py` - 批量修复发布日期

### 7.2 相关文件

- `app/services/discovery/store.py` - 数据摄取和存储
- `app/models/entities.py` - 数据模型定义

### 7.3 参考资料

- [Schema.org Article](https://schema.org/Article) - 结构化数据标准
- [Open Graph Protocol](https://ogp.me/) - Open Graph元数据标准

