# 社交平台内容图谱规范（精简版）

本规范仅聚焦“内容图谱（内容子图）”，围绕文本中的关键词、关键实体、主题与情感倾向构建可查询的图结构；不包含流程追溯、审计与运行治理等内容。

---

## 1. 最小输入字段参考（来自 extracted_data）

用于构图的最小字段集合（缺失可为空，但影响图谱稠密度与查询能力）：

```json
{
  "text": "<string>",
  "keywords": ["<string>", "..."],
  "entities": [
    { "text": "<string>", "type": "<PERSON|ORG|LOC|GAME|...>", "span": [0, 10], "kb_id": "<string?>", "canonical_name": "<string?>" }
  ],
  "sentiment": {
    "sentiment_orientation": "positive|negative|neutral",
    "sentiment_tags": ["<string>", "..."],
    "key_phrases": ["<string>", "..."],
    "emotion_words": ["<string>", "..."],
    "topic": "<string>"
  },
  "username": "<string?>",
  "subreddit": "<string?>"
}
```

---

## 2. 节点类型与主键

- Post（帖子/文档）
  - 主键：`doc_id`（= `documents.id`）
  - 属性：`uri`, `platform`, `publish_date?`, `created_at`, `sentiment_orientation?`, `state?`
- Keyword（关键词）
  - 主键：`keyword_hash`（如 `sha1(lower(text)+lang)`）
  - 属性：`text`, `lang?`
- Entity（实体）
  - 主键：`kb_id`（优先）或 `canonical_name+type`
  - 属性：`canonical_name`, `type`（如 `PERSON/ORG/LOC/GAME`）
- Topic（主题）
  - 主键：`label`
- SentimentTag（情感标签）
  - 主键：`label`
- User（用户）
  - 主键：`platform+username`
- Subreddit（子论坛）
  - 主键：`name`

---

## 3. 边类型与属性

- Post -[MENTIONS_KEYWORD]-> Keyword
  - 属性：`weight`（频次/TF-IDF），`positions?`（词在文本中的位置）
- Post -[MENTIONS_ENTITY]-> Entity
  - 属性：`positions?`, `confidence?`
- Post -[HAS_TOPIC]-> Topic
  - 属性：`score?`
- Post -[HAS_SENTIMENT]-> SentimentTag
  - 属性：`orientation`（positive/negative/neutral），`score?`
- Post -[AUTHORED_BY]-> User
- Post -[IN_SUBREDDIT]-> Subreddit
- Keyword -[CO_OCCURS]-> Keyword
  - 属性：`weight`（同文出现计数），`window`（时间窗）
- Post -[SIMILAR]-> Post（可选）
  - 属性：`similarity`（向量相似度）
- Entity -[RELATES_TO]-> Entity（可选，若抽取到关系）
  - 属性：`predicate`（如 `regulates/affects`），`evidence?`, `confidence?`

---

## 4. 映射规则（extracted_data → 图谱）

- `keywords[]` → Keyword 节点；Post→Keyword: MENTIONS_KEYWORD（`weight=1` 累加或 TF-IDF）
- `entities[]` → Entity 节点；Post→Entity: MENTIONS_ENTITY（带 `span/confidence?`）
- `sentiment.topic` → Topic 节点；Post→Topic: HAS_TOPIC（带 `score?`）
- `sentiment.sentiment_tags[]` → SentimentTag 节点；Post→Tag: HAS_SENTIMENT（`orientation=sentiment_orientation`）
- `sentiment.sentiment_orientation` → Post 节点属性（同时作为 HAS_SENTIMENT 的边属性）
- `username` → User 节点；Post→User: AUTHORED_BY
- `subreddit` → Subreddit 节点；Post→Subreddit: IN_SUBREDDIT
- 关键词共现：同一 Post 内任意两关键词生成无向或双向 CO_OCCURS，`weight+=1`

---

## 5. 子图构建策略

- 主题子图：按 `Topic=label` 聚合 `Post`、相关 `Keyword/Entity/SentimentTag` 与相应边。
- 时间窗子图：`[t-Δ, t+Δ]` 时间范围内的 `Post` 及其邻接节点/边，用于趋势与爆点分析。
- 区域子图：按 `state`（若有）聚合，用于地理维度对比。

---

## 6. 导出格式（JSON 最小建议）

```json
{
  "nodes": [
    {"type": "Post", "id": 229, "platform": "reddit", "sentiment_orientation": "neutral"},
    {"type": "Keyword", "id": "sha1:...", "text": "powerball"},
    {"type": "Entity", "id": "game:powerball", "canonical_name": "Powerball", "entity_type": "GAME"},
    {"type": "Topic", "id": "lottery strategy"},
    {"type": "SentimentTag", "id": "strategy"}
  ],
  "edges": [
    {"type": "MENTIONS_KEYWORD", "from": {"type":"Post","id":229}, "to": {"type":"Keyword","id":"sha1:..."}, "weight": 1},
    {"type": "MENTIONS_ENTITY", "from": {"type":"Post","id":229}, "to": {"type":"Entity","id":"game:powerball"}},
    {"type": "HAS_TOPIC", "from": {"type":"Post","id":229}, "to": {"type":"Topic","id":"lottery strategy"}},
    {"type": "HAS_SENTIMENT", "from": {"type":"Post","id":229}, "to": {"type":"SentimentTag","id":"strategy"}, "orientation": "neutral"}
  ]
}
```

---

## 7. 典型查询（面向内容）

- 热门主题：按时间窗统计 `HAS_TOPIC` 计数 Top-K。
- 主题内关键词共现：在 `Topic=label` 子图中对 `CO_OCCURS` 做社区/团簇分析。
- 实体-情感：按实体聚合 `HAS_SENTIMENT` 的 `orientation/score` 分布。
- 相似帖子：基于 `SIMILAR` 边或向量相似度检索相关帖子。

---

## 8. 附：列级映射示例（节选）

- `extracted_data.platform` ← 适配器常量（`"reddit"`）。
- `extracted_data.username` ← Reddit JSON `author`。
- `extracted_data.subreddit` ← Reddit JSON `subreddit`。
- `extracted_data.likes` ← Reddit JSON `score`（或 `ups`）。
- `extracted_data.comments` ← Reddit JSON `num_comments`。
- `extracted_data.text` ← Reddit JSON `selftext`（空时回退 `title`）。
- `extracted_data.sentiment.*` ← LLM 输出（`extract_structured_sentiment` 产物）。

> 说明：列级映射用于内容层建图的数据清洗与一致性校验，可与适配器/模型版本在外部清单中绑定管理。

---

## 9. 参考策略综述与反思（内容图谱）

以下策略面向“内容子图”的抽取、加权与演算法落地，结合业界通用做法做精炼（聚焦关键词/实体/主题/情感，不涉及运行审计）。

### 9.1 关键词（Keyword）

- 提取方法：
  - 无监督：TextRank、RAKE/YAKE；短文本可优先 KeyBERT（句向量+近邻）提升稳定性。
  - 多语言：分语种停用词、词形还原/简繁归一；Hash ID 使用 `sha1(lower(text)+lang)` 保证归一。
- 加权与去噪：
  - 边权建议用 TF-IDF 或 PMI/PPMI；短文本场景推荐在“滑动窗口共现”与“整帖共现”间对比评估。
  - 过滤 URL/表情/通用停用词/平台噪声 token（如“rt”“http”）。

### 9.2 实体（Entity）与链接（EL）

- NER：spaCy/Flair/Transformer（按语种选择）；实体类型建议统一枚举（PERSON/ORG/LOC/GAME/...）。
- 实体链接：优先映射到 Wikidata/内部 KB；未命中则生成 `canonical_name+type` 的稳定主键。
- 归一与拆分：
  - `Powerball`（GAME）与“PB”“强力球”做别名集合；
  - 同名异物（如“Apple”ORG/PRODUCT）需上下文判消歧，可用句向量最近邻+阈值。
- 边信息：保留 `span` 与 `confidence`，便于误差控制与前端高亮。

### 9.3 主题（Topic）与短文本

- 模型：BERTopic（c-TF-IDF）对短文本更稳；中文可用多语向量（mpnet-e5 类）+ UMAP/HDBSCAN；
- 映射：将主题 `label` 映射为 Topic 节点；为 Post→Topic 记 `score`（主题概率或相似度）。
- 更新：避免主题漂移，建议周期性重建+旧新映射表；或时间切片（按月/周）维护多版本主题集。

### 9.4 情感（Sentiment）

- 标签设计：主倾向（positive/negative/neutral）+ 辅助标签（sentiment_tags 如“hope”“risk”“scam”）；
- 提取：零样本/小样本（label set 明确）；中文/英文分模型或多语模型统一；
- 图建模：
  - Post 属性持久化 `sentiment_orientation`；
  - Post→SentimentTag 用 HAS_SENTIMENT；
  - 聚合时对 orientation 做时间加权（指数衰减）以反映舆情时效。

### 9.5 共现与时间权重

- 共现边：关键词/实体共现建议采用：
  - 文内窗口（例如窗口=5词），更细粒但耗时高；
  - 整帖共现（快速基线），配合 TF-IDF/PMI 抑制高频词；
  - 归一化：按帖子长度/总词数归一，避免长文偏置。
- 时间权重：边与计数支持 `decay = exp(-Δt/τ)`（τ 为时间尺度），便于“热度”与“常青”兼顾。

### 9.6 查询与分析范式

- 热点主题：按时间窗聚合 `HAS_TOPIC` 次数 Top-K；
- 主题子图内团簇：对 `CO_OCCURS` 运行 Louvain/Leiden 社区，产出关键词簇用于命名与导航；
- 实体-情感剖面：按实体聚合 `HAS_SENTIMENT` 的倾向分布与强度；
- 相似内容：基于向量相似度或 Post→Post `SIMILAR` 边的近邻检索；
- 影响力：节点中心性（PageRank/Betweenness）衡量关键关键词/实体。

### 9.7 存储与导出

- 轻量实现：以 JSON（nodes/edges）导出供可视化或离线分析；
- 图数据库：需要交互与复杂查询时采用 Neo4j/JanusGraph/ArangoDB；
- 批/流处理：先离线构图（微批），后视需要接入增量过程（基于 `doc_id` 幂等更新）。

### 9.8 风险与权衡

- 多语言与别名：统一归一策略（大小写、简繁、别名集）；
- 噪声与误报：对低置信抽取与短文本阈值化，必要时标记 `low_confidence`；
- 主题稳定性：定期重训与版本映射；
- 计算成本：窗口共现与实体链接开销大，可先基线（整帖共现+Top-N 实体）。


