# 政策数据结构说明文档

> 最后更新：2026-02 | 文档索引：`docs/README.md`

## 概述

本文档详细说明了市场情报系统中政策数据的完整数据结构，包括数据摄取阶段的结构、提取后的结构化数据、以及数据库存储格式。

**文档类型标识**: `policy` 或 `policy_regulation`  
**数据来源**: 政府网站、新闻媒体、法规数据库等  
**存储位置**: `documents` 表的 `extracted_data` 字段（JSONB类型）

---

## 1. 政策文档基础结构（PolicyDocument）

在数据摄取阶段，政策文档使用 `PolicyDocument` 数据类表示：

```python
@dataclass(slots=True)
class PolicyDocument:
    state: str                    # 州/地区代码（如：CA, NY）
    title: str                    # 文档标题
    status: str | None            # 文档状态（如：active, pending, expired）
    publish_date: date | None     # 发布日期
    summary: str | None           # 文档摘要
    content: str                  # 文档完整内容
    uri: str | None = None        # 文档URI/URL
    source_name: str | None = None # 数据源名称
```

### 字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `state` | str | 是 | 州/地区代码，使用标准两字母代码（如：CA, NY, TX） |
| `title` | str | 是 | 政策文档的标题 |
| `status` | str \| None | 否 | 文档状态，常见值：`active`（生效中）、`pending`（待生效）、`expired`（已过期）、`draft`（草案） |
| `publish_date` | date \| None | 否 | 发布日期，格式：YYYY-MM-DD |
| `summary` | str \| None | 否 | 文档摘要，简要描述政策内容 |
| `content` | str | 是 | 文档的完整文本内容 |
| `uri` | str \| None | 否 | 文档的原始URL或URI |
| `source_name` | str \| None | 否 | 数据源名称，标识数据来源 |

---

## 2. 政策提取结构（PolicyExtracted）

通过LLM提取后的政策结构化信息，使用 `PolicyExtracted` Pydantic模型表示：

```python
class PolicyExtracted(BaseModel):
    state: Optional[str] = None                    # 州代码
    effective_date: Optional[date] = None          # 生效日期
    policy_type: Optional[str] = None              # 政策类型
    key_points: List[str] = Field(default_factory=list)  # 关键要点列表
```

### 字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `state` | str \| None | 否 | 州代码（如：CA, NY），如果文档中未明确提及则为None |
| `effective_date` | date \| None | 否 | 政策生效日期，格式：YYYY-MM-DD。如果无法确定则为None |
| `policy_type` | str \| None | 否 | 政策类型，常见值见下表 |
| `key_points` | List[str] | 否 | 关键要点列表，最多5条，简要概括政策的核心内容 |

### 政策类型（policy_type）枚举值

| 值 | 说明 | 示例 |
|----|------|------|
| `regulation` | 法规/条例 | 州彩票委员会发布的正式法规 |
| `bill` | 法案 | 正在审议或已通过的法案 |
| `announcement` | 公告/通知 | 官方发布的公告或通知 |
| `guidance` | 指导文件 | 政策指导文件或操作指南 |
| `amendment` | 修正案 | 对现有政策的修正 |
| `executive_order` | 行政命令 | 州长或行政机构发布的命令 |

### 关键要点（key_points）规范

- **数量限制**: 最多5条
- **内容要求**: 
  - 每条要点应简洁明了，通常不超过50字
  - 应涵盖政策的核心影响和主要内容
  - 避免重复和冗余
- **示例**:
  ```json
  [
    "提高彩票销售税从5%到7%",
    "新增在线彩票销售渠道",
    "限制单次购买金额上限为$500"
  ]
  ```

---

## 3. 实体和关系结构

政策文档可能包含实体和关系的提取信息，用于知识图谱构建和关系分析。

### 3.1 实体结构（ExtractedEntity）

```python
class ExtractedEntity(BaseModel):
    text: str                    # 实体文本
    type: Literal["ORG", "LOC", "PERSON", "AGENCY", "LAW", "GAME"]  # 实体类型
    span: Optional[List[int]] = None  # 文本位置 [start, end]，可选
```

#### 实体类型说明

| 类型 | 说明 | 示例 |
|------|------|------|
| `ORG` | 组织机构 | "California Lottery Commission" |
| `LOC` | 地理位置 | "California", "Los Angeles" |
| `PERSON` | 人物 | "Governor Newsom" |
| `AGENCY` | 政府机构 | "Department of Consumer Affairs" |
| `LAW` | 法律/法规 | "Proposition 20", "AB 1234" |
| `GAME` | 彩票游戏 | "Powerball", "Mega Millions" |

#### 实体数量限制

- 最多提取 **5个实体**
- 优先提取与彩票政策直接相关的实体

### 3.2 关系结构（ExtractedRelation）

```python
class ExtractedRelation(BaseModel):
    subject: str                # 主体
    predicate: Literal["regulates", "affects", "announces", "changes_rule", "reports_sales"]  # 谓词
    object: str                 # 客体
    evidence: str = Field(default="")  # 证据文本
    confidence: float = Field(ge=0.0, le=1.0)  # 置信度（0.0-1.0）
    date: Optional[str] = None  # 关系日期（ISO格式），可选
```

#### 关系谓词（predicate）说明

| 谓词 | 说明 | 示例 |
|------|------|------|
| `regulates` | 监管/规范 | "California Lottery Commission regulates online sales" |
| `affects` | 影响 | "New regulation affects Powerball sales" |
| `announces` | 宣布 | "Agency announces new policy" |
| `changes_rule` | 改变规则 | "Amendment changes_rule ticket purchase limit" |
| `reports_sales` | 报告销售 | "Commission reports_sales quarterly revenue" |

#### 关系数量限制

- 最多提取 **3条关系**
- 优先提取与政策核心内容直接相关的关系

#### 置信度（confidence）说明

- **范围**: 0.0 到 1.0
- **含义**: 
  - 0.9-1.0: 高度确信，关系明确
  - 0.7-0.9: 较为确信，关系较明确
  - 0.5-0.7: 中等确信，关系可能成立
  - <0.5: 低确信，关系不确定

---

## 4. 数据库存储格式

政策文档在数据库中存储时，完整的数据结构如下：

### 4.1 documents 表字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | BigInteger | 主键ID |
| `source_id` | BigInteger | 关联的数据源ID |
| `state` | String(8) | 州/地区代码 |
| `doc_type` | String(16) | 文档类型，政策文档为 `"policy"` 或 `"policy_regulation"` |
| `title` | Text | 文档标题 |
| `status` | String(32) | 文档状态 |
| `publish_date` | Date | 发布日期 |
| `content` | Text | 文档完整内容 |
| `summary` | Text | 文档摘要 |
| `text_hash` | String(64) | 文本内容的哈希值（用于去重） |
| `uri` | Text | 文档URI/URL |
| `extracted_data` | JSONB | 提取的结构化数据（见下文） |
| `created_at` | DateTime(timezone) | 创建时间 |
| `updated_at` | DateTime(timezone) | 更新时间 |

### 4.2 extracted_data JSONB 字段结构

政策文档的 `extracted_data` 字段包含完整的结构化信息：

```json
{
  "platform": "google_news",
  "source": "新闻来源名称",
  "keyword": "搜索关键词",
  "policy": {
    "state": "CA",
    "effective_date": "2025-01-15",
    "policy_type": "regulation",
    "key_points": [
      "关键要点1",
      "关键要点2",
      "关键要点3"
    ]
  },
  "entities_relations": {
    "entities": [
      {
        "text": "California Lottery Commission",
        "type": "AGENCY",
        "span": [10, 35]
      },
      {
        "text": "Powerball",
        "type": "GAME",
        "span": [120, 128]
      }
    ],
    "relations": [
      {
        "subject": "California Lottery Commission",
        "predicate": "announces",
        "object": "new regulation",
        "evidence": "The California Lottery Commission announced a new regulation...",
        "confidence": 0.95,
        "date": "2025-01-15"
      }
    ]
  }
}
```

### 4.3 extracted_data 字段详细说明

#### 顶层字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `platform` | string | 否 | 数据来源平台（如：`google_news`, `reddit`, `official_website`） |
| `source` | string | 否 | 新闻来源名称或数据源名称 |
| `keyword` | string | 否 | 搜索时使用的关键词 |
| `policy` | object | 是 | 政策提取信息（见下文） |
| `entities_relations` | object | 否 | 实体和关系信息（见下文） |

#### policy 对象字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `state` | string | 否 | 州代码（如：CA, NY） |
| `effective_date` | string | 否 | 生效日期，格式：YYYY-MM-DD |
| `policy_type` | string | 否 | 政策类型（见政策类型枚举） |
| `key_points` | array[string] | 否 | 关键要点列表，最多5条 |

#### entities_relations 对象字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `entities` | array[object] | 否 | 实体列表，最多5个 |
| `relations` | array[object] | 否 | 关系列表，最多3条 |

#### entity 对象字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `text` | string | 是 | 实体文本 |
| `type` | string | 是 | 实体类型（见实体类型枚举） |
| `span` | array[number] | 否 | 文本位置 [start, end] |

#### relation 对象字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `subject` | string | 是 | 主体 |
| `predicate` | string | 是 | 谓词（见关系谓词枚举） |
| `object` | string | 是 | 客体 |
| `evidence` | string | 否 | 证据文本，支持关系的原文片段 |
| `confidence` | number | 否 | 置信度（0.0-1.0） |
| `date` | string | 否 | 关系日期，ISO格式（YYYY-MM-DD） |

---

## 5. 数据提取流程

### 5.1 提取步骤

1. **数据摄取阶段**
   - 从数据源（政府网站、新闻媒体等）获取原始政策文档
   - 创建 `PolicyDocument` 对象，填充基础字段

2. **结构化提取阶段**
   - 调用 `extract_policy_info()` 提取政策信息
     - 输入：文档的 `content` 文本
     - 输出：`PolicyExtracted` 对象
   - 调用 `extract_entities_relations()` 提取实体和关系（可选）
     - 输入：文档的 `content` 文本
     - 输出：`ERPayload` 对象

3. **数据合并阶段**
   - 将提取的结构化数据合并到 `extracted_data` JSONB 字段
   - 格式化为完整的JSON结构

4. **存储阶段**
   - 将文档和提取的数据存储到 `documents` 表
   - 使用 `text_hash` 进行去重检查

### 5.2 提取函数说明

#### extract_policy_info(text: str) -> Optional[Dict[str, Any]]

**功能**: 从文本中提取政策结构化信息

**参数**:
- `text`: 要分析的文本内容（至少50字符）

**返回**: 
- 成功：包含政策信息的字典
- 失败：`None`

**提取内容**:
- 州代码（state）
- 生效日期（effective_date）
- 政策类型（policy_type）
- 关键要点（key_points，最多5条）

**实现方式**:
- 优先使用LLM的 `with_structured_output` 功能
- Fallback到JSON模式解析

#### extract_entities_relations(text: str) -> Optional[Dict[str, Any]]

**功能**: 从文本中提取实体和关系

**参数**:
- `text`: 要分析的文本内容（至少50字符）

**返回**:
- 成功：包含实体和关系的字典
- 失败：`None`

**提取内容**:
- 实体列表（entities，最多5个）
- 关系列表（relations，最多3条）

---

## 6. 查询示例

### 6.1 基础查询

```sql
-- 查询所有政策文档
SELECT id, title, state, publish_date, extracted_data->'policy' as policy_info
FROM documents
WHERE doc_type IN ('policy', 'policy_regulation');

-- 查询特定州的政策
SELECT id, title, extracted_data->'policy'->>'state' as state
FROM documents
WHERE doc_type = 'policy'
  AND extracted_data->'policy'->>'state' = 'CA';

-- 查询特定类型的政策
SELECT id, title, extracted_data->'policy'->>'policy_type' as policy_type
FROM documents
WHERE doc_type = 'policy'
  AND extracted_data->'policy'->>'policy_type' = 'regulation';
```

### 6.2 高级查询

```sql
-- 查询包含特定关键要点的政策
SELECT id, title, extracted_data->'policy'->'key_points' as key_points
FROM documents
WHERE doc_type = 'policy'
  AND extracted_data->'policy'->'key_points' @> '["在线彩票"]'::jsonb;

-- 查询包含特定实体的政策
SELECT id, title, extracted_data->'entities_relations'->'entities' as entities
FROM documents
WHERE doc_type = 'policy'
  AND extracted_data->'entities_relations'->'entities' @> '[{"text": "California Lottery Commission"}]'::jsonb;

-- 查询特定生效日期的政策
SELECT id, title, extracted_data->'policy'->>'effective_date' as effective_date
FROM documents
WHERE doc_type = 'policy'
  AND extracted_data->'policy'->>'effective_date' >= '2025-01-01';
```

### 6.3 统计查询

```sql
-- 统计各州政策数量
SELECT 
  extracted_data->'policy'->>'state' as state,
  COUNT(*) as count
FROM documents
WHERE doc_type = 'policy'
  AND extracted_data->'policy'->>'state' IS NOT NULL
GROUP BY state
ORDER BY count DESC;

-- 统计各类型政策数量
SELECT 
  extracted_data->'policy'->>'policy_type' as policy_type,
  COUNT(*) as count
FROM documents
WHERE doc_type = 'policy'
  AND extracted_data->'policy'->>'policy_type' IS NOT NULL
GROUP BY policy_type
ORDER BY count DESC;
```

---

## 7. 数据验证规则

### 7.1 必填字段验证

- `doc_type` 必须为 `"policy"` 或 `"policy_regulation"`
- `extracted_data.policy` 对象必须存在（即使字段为null）

### 7.2 数据格式验证

- `effective_date` 格式：YYYY-MM-DD（ISO 8601日期格式）
- `key_points` 数组长度：最多5条
- `entities` 数组长度：最多5个
- `relations` 数组长度：最多3条
- `confidence` 范围：0.0 到 1.0

### 7.3 数据一致性验证

- `extracted_data.policy.state` 应与 `documents.state` 保持一致（如果两者都存在）
- `extracted_data.policy.effective_date` 不应早于 `documents.publish_date`（如果两者都存在）

---

## 8. 索引建议

为了优化政策数据的查询性能，建议创建以下索引：

```sql
-- 为 policy.state 创建索引
CREATE INDEX idx_documents_extracted_data_policy_state 
ON documents ((extracted_data->'policy'->>'state'))
WHERE doc_type IN ('policy', 'policy_regulation');

-- 为 policy.policy_type 创建索引
CREATE INDEX idx_documents_extracted_data_policy_type 
ON documents ((extracted_data->'policy'->>'policy_type'))
WHERE doc_type IN ('policy', 'policy_regulation');

-- 为 policy.effective_date 创建索引
CREATE INDEX idx_documents_extracted_data_policy_effective_date 
ON documents ((extracted_data->'policy'->>'effective_date'))
WHERE doc_type IN ('policy', 'policy_regulation');

-- 为 policy 对象创建 GIN 索引（支持全文搜索）
CREATE INDEX idx_documents_extracted_data_policy_gin 
ON documents USING GIN ((extracted_data->'policy'))
WHERE doc_type IN ('policy', 'policy_regulation');

-- 为 key_points 数组创建 GIN 索引
CREATE INDEX idx_documents_extracted_data_key_points_gin 
ON documents USING GIN ((extracted_data->'policy'->'key_points'))
WHERE doc_type IN ('policy', 'policy_regulation');
```

---

## 9. 数据示例

### 9.1 完整示例

```json
{
  "platform": "google_news",
  "source": "Los Angeles Times",
  "keyword": "California lottery regulation",
  "policy": {
    "state": "CA",
    "effective_date": "2025-03-01",
    "policy_type": "regulation",
    "key_points": [
      "允许在线购买彩票",
      "提高销售税从5%到7%",
      "限制单次购买金额上限为$500",
      "要求年龄验证系统",
      "新增负责任博彩措施"
    ]
  },
  "entities_relations": {
    "entities": [
      {
        "text": "California Lottery Commission",
        "type": "AGENCY",
        "span": [45, 72]
      },
      {
        "text": "Powerball",
        "type": "GAME",
        "span": [120, 128]
      },
      {
        "text": "Governor Newsom",
        "type": "PERSON",
        "span": [200, 215]
      }
    ],
    "relations": [
      {
        "subject": "California Lottery Commission",
        "predicate": "announces",
        "object": "new online lottery regulation",
        "evidence": "The California Lottery Commission announced a new regulation that will allow online lottery purchases starting March 1, 2025.",
        "confidence": 0.95,
        "date": "2025-01-15"
      },
      {
        "subject": "new regulation",
        "predicate": "affects",
        "object": "Powerball sales",
        "evidence": "The new regulation will significantly affect Powerball sales by expanding the purchasing channels.",
        "confidence": 0.88,
        "date": "2025-03-01"
      }
    ]
  }
}
```

---

## 10. 版本历史

- **2025-01-XX**: 初始版本，定义政策数据结构
- 待更新：根据实际使用情况持续优化

---

## 11. 相关文档

- [数据库说明文档](./数据库说明文档.md) - 完整的数据库结构说明
- [数据摄取内容](./数据摄取内容.md) - 数据摄取流程说明
- [结构化搜索管道](../STRUCTURED_SEARCH_PIPELINE.md) - 结构化数据搜索说明

---

*文档生成时间: 2025-01-XX*  
*系统版本: Lottery Intelligence System*

