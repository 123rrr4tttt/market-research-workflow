# 接口层调查文档

> 最后更新：2026-02 | 文档索引：`docs/README.md`

## 1. 调研范围与结论（摘要）

- 调研范围：`main/backend/app/main.py`、`main/backend/app/api/*.py`、`main/frontend/static/js/*.js`、主要前端模板中的接口调用、`main/backend/app/contracts`、`main/backend/app/services/*` 中的接口抽象（`ports`/`tasks`/`http client`/部分 adapters）。
- 后端 HTTP 接口总量：约 `90+` 个业务 API 路由（`/api/v1` 下，来自 `18` 个 `APIRouter` 模块）+ `main.py` 中 `24` 个应用级路由（含健康检查、地图资源、页面路由、监控指标）。
- 接口层整体形态：`FastAPI 路由层 -> services 应用/领域服务 -> models(SQLAlchemy)`，部分场景通过 `Celery` 异步任务执行；前端通过 `window.fetch` 改写和 `MarketApp.fetchJSON` 注入多租户项目上下文。
- 当前接口层是“可用但风格混合”的状态：响应包裹格式、错误处理策略、同步/异步调用约定在不同模块之间不完全一致。

## 2. 接口层分层图（代码视角）

1. 外部 HTTP 接口层（后端）

`main/backend/app/main.py` + `main/backend/app/api/*.py`

2. 前端调用封装层（浏览器侧）

`main/frontend/static/js/app-shell.js`、`main/frontend/static/js/policy-api.js`

3. 内部接口抽象层（服务边界）

`main/backend/app/contracts/*.py`、`main/backend/app/services/*/ports.py`、`main/backend/app/services/tasks.py`、`main/backend/app/services/http/client.py`

4. 外部系统适配层（Provider/Adapter）

示例：`main/backend/app/services/llm/adapters/langchain_provider.py`、`main/backend/app/services/discovery/adapters.py`、`main/backend/app/services/ingest/adapters/*`

## 3. 应用入口与全局接口行为（`main.py`）

### 3.1 全局接口行为（重要）

- 统一 API 前缀：业务 API 通过 `app.include_router(api_router, prefix="/api/v1")` 挂载。
- 多租户上下文注入：`metrics_middleware` 会从 `X-Project-Key` 或 query `project_key` 读取租户键，缺失时回退到“当前激活项目”。
- 监控暴露：Prometheus 指标通过 `/metrics` 暴露；请求数和延迟按路径打点。
- 前端模板与静态资源：`/static` 挂载静态资源，多个 `*.html` 页面由 `Jinja2Templates` 提供。

### 3.2 `main.py` 中的 HTTP 路由清单

| Method | Path | Handler | 文件定位 | 说明 |
| --- | --- | --- | --- | --- |
| GET | `/api/v1/health` | `health_check` | `main/backend/app/main.py:293` | 健康检查 |
| GET | `/api/v1/health/deep` | `deep_health_check` | `main/backend/app/main.py:303` | 健康检查 |
| GET | `/metrics` | `metrics` | `main/backend/app/main.py:327` | Prometheus 指标 |
| GET | `/` | `index` | `main/backend/app/main.py:332` | 应用页面路由 |
| GET | `/index.html` | `index_html` | `main/backend/app/main.py:337` | 应用页面路由 |
| GET | `/settings.html` | `settings_page` | `main/backend/app/main.py:343` | 应用页面路由 |
| GET | `/admin.html` | `admin_page` | `main/backend/app/main.py:348` | 应用页面路由 |
| GET | `/dashboard.html` | `dashboard_page` | `main/backend/app/main.py:353` | 应用页面路由 |
| GET | `/dashboard` | `dashboard_redirect` | `main/backend/app/main.py:365` | 应用页面路由 |
| GET | `/app.html` | `app_page` | `main/backend/app/main.py:371` | 应用页面路由 |
| GET | `/app` | `app_redirect` | `main/backend/app/main.py:377` | 应用页面路由 |
| GET | `/data-dashboard.html` | `data_dashboard_page` | `main/backend/app/main.py:383` | 应用页面路由 |
| GET | `/backend-dashboard.html` | `backend_dashboard_page` | `main/backend/app/main.py:389` | 应用页面路由 |
| GET | `/policy-dashboard.html` | `policy_dashboard_page` | `main/backend/app/main.py:395` | 应用页面路由 |
| GET | `/policy-state-detail.html` | `policy_state_detail_page` | `main/backend/app/main.py:401` | 应用页面路由 |
| GET | `/policy-tracking.html` | `policy_tracking_page` | `main/backend/app/main.py:407` | 应用页面路由 |
| GET | `/market-data-visualization.html` | `market_data_visualization_page` | `main/backend/app/main.py:413` | 应用页面路由 |
| GET | `/social-media-visualization.html` | `social_media_visualization_page` | `main/backend/app/main.py:425` | 应用页面路由 |
| GET | `/policy-visualization.html` | `policy_visualization_page` | `main/backend/app/main.py:437` | 应用页面路由 |
| GET | `/policy-graph.html` | `policy_graph_page` | `main/backend/app/main.py:449` | 应用页面路由 |
| GET | `/social-media-graph.html` | `social_media_graph_page` | `main/backend/app/main.py:461` | 应用页面路由 |
| GET | `/project-management.html` | `project_management_page` | `main/backend/app/main.py:466` | 应用页面路由 |
| GET | `/process-management.html` | `process_management_page` | `main/backend/app/main.py:472` | 应用页面路由 |
| GET | `/api/v1/maps/usa` | `get_usa_map` | `main/backend/app/main.py:478` | 地图资源接口 |

## 4. 后端业务接口层（`main/backend/app/api`）总览

- 模块数：`18`
- 路由数：约 `90+`
- 聚合入口：`main/backend/app/api/__init__.py` 统一注册 18 个子路由模块。

### 4.1 模块清单（职责与规模）

| 模块 | 前缀 | 路由数 | 核心职责 |
| --- | --- | ---: | --- |
| `admin.py` | `/admin` | 13 | 管理台查询、文档管理、图谱导出/查询、检索历史 |
| `config.py` | `/config` | 4 | 运行配置读取/更新/重载 |
| `dashboard.py` | `/dashboard` | 10 | 仪表盘统计与趋势聚合接口 |
| `discovery.py` | `/discovery` | 5 | 发现/搜索/深搜/关键词生成 |
| `governance.py` | `/governance` | 2 | 数据治理与聚合同步触发 |
| `indexer.py` | `/indexer` | 1 | 索引重建触发（政策文档） |
| `ingest.py` | `/ingest` | 13 | 数据采集入口（政策/市场/新闻/社媒/报告/商品/电商） |
| `llm_config.py` | `/llm-config` | 14 | LLM 服务配置 CRUD（含项目级配置） |
| `market.py` | `/market` | 2 | 市场统计与游戏列表查询 |
| `policies.py` | `/policies` | 4 | 政策列表/统计/州级详情/单条详情 |
| `process.py` | `/process` | 6 | 任务队列/任务历史/取消/日志查询 |
| `products.py` | `/products` | 4 | 商品管理 CRUD |
| `projects.py` | `/projects` | 7 | 项目（租户）管理与激活/归档/删除 |
| `reports.py` | `/reports` | 1 | 报表导出（HTML/CSV） |
| `search.py` | `/search` | 2 | 搜索查询与索引初始化 |
| `source_library.py` | `/source_library` | 5 | 信息源库频道/条目管理与执行 |
| `project_customization.py` | `/project_customization` | 6 | 项目定制（菜单/工作流/LLM 映射/图谱配置） |
| `topics.py` | `/topics` | 4 | 主题管理 CRUD |

### 4.2 各模块路由清单（按文件）

> 行号可能随代码变更漂移，以 `grep` 或 OpenAPI 为准。

#### `admin.py` (`/admin`)

- 主要依赖：`from models.base import SessionLocal`；`from models.entities import Document, Source, MarketStat, SearchHistory`；`from services.extraction.extract import extract_policy_info, extract_market_info, extract_entities_relations`；`from contracts import success_response`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/admin/stats` | `get_stats` | `main/backend/app/api/admin.py:72` |
| POST | `/api/v1/admin/documents/list` | `list_documents` | `main/backend/app/api/admin.py:128` |
| GET | `/api/v1/admin/documents/{doc_id}` | `get_document` | `main/backend/app/api/admin.py:273` |
| POST | `/api/v1/admin/documents/delete` | `delete_documents` | `main/backend/app/api/admin.py:301` |
| POST | `/api/v1/admin/documents/re-extract` | `re_extract_documents` | `main/backend/app/api/admin.py:318` |
| POST | `/api/v1/admin/sources/list` | `list_sources` | `main/backend/app/api/admin.py:399` |
| POST | `/api/v1/admin/market-stats/list` | `list_market_stats` | `main/backend/app/api/admin.py:489` |
| POST | `/api/v1/admin/social-data/list` | `list_social_data` | `main/backend/app/api/admin.py:587` |
| GET | `/api/v1/admin/export-graph` | `export_graph` | `main/backend/app/api/admin.py:692` |
| GET | `/api/v1/admin/content-graph` | `get_content_graph` | `main/backend/app/api/admin.py:754` |
| GET | `/api/v1/admin/market-graph` | `get_market_graph` | `main/backend/app/api/admin.py:901` |
| GET | `/api/v1/admin/policy-graph` | `get_policy_graph` | `main/backend/app/api/admin.py:1066` |
| GET | `/api/v1/admin/search-history` | `get_search_history` | `main/backend/app/api/admin.py:1231` |

#### `config.py` (`/config`)

- 主要依赖：`from services.settings_manager import load_env_settings, update_env_settings, ENV_KEY_MAPPING`；`from contracts import success_response`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/config` | `get_config` | `main/backend/app/api/config.py:14` |
| GET | `/api/v1/config/env` | `get_env_settings` | `main/backend/app/api/config.py:48` |
| POST | `/api/v1/config/env` | `update_env` | `main/backend/app/api/config.py:53` |
| POST | `/api/v1/config/reload` | `reload_env_settings` | `main/backend/app/api/config.py:67` |

#### `dashboard.py` (`/dashboard`)

- 主要依赖：`from models.base import SessionLocal`；`from models.entities import Document, Source, MarketStat, SearchHistory, EtlJobRun, MarketMetricPoint, Product, PriceObservation`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/dashboard/global/stats` | `get_global_stats` | `main/backend/app/api/dashboard.py:35` |
| GET | `/api/v1/dashboard/stats` | `get_dashboard_stats` | `main/backend/app/api/dashboard.py:61` |
| GET | `/api/v1/dashboard/market-trends` | `get_market_trends` | `main/backend/app/api/dashboard.py:172` |
| GET | `/api/v1/dashboard/document-analysis` | `get_document_analysis` | `main/backend/app/api/dashboard.py:306` |
| GET | `/api/v1/dashboard/sentiment-analysis` | `get_sentiment_analysis` | `main/backend/app/api/dashboard.py:415` |
| GET | `/api/v1/dashboard/sentiment-sources` | `get_sentiment_sources` | `main/backend/app/api/dashboard.py:559` |
| GET | `/api/v1/dashboard/task-monitoring` | `get_task_monitoring` | `main/backend/app/api/dashboard.py:655` |
| GET | `/api/v1/dashboard/search-analytics` | `get_search_analytics` | `main/backend/app/api/dashboard.py:717` |
| GET | `/api/v1/dashboard/commodity-trends` | `get_commodity_trends` | `main/backend/app/api/dashboard.py:760` |
| GET | `/api/v1/dashboard/ecom-price-trends` | `get_ecom_price_trends` | `main/backend/app/api/dashboard.py:836` |

#### `discovery.py` (`/discovery`)

- 主要依赖：`from services.search.web import generate_keywords`；`from services.discovery.application import DiscoveryApplicationService`；`from services.keyword_generation import generate_social_keywords, generate_subreddit_keywords`；`from services.job_logger import start_job, complete_job, fail_job`；`from contracts import success_response, error_response, map_exception_to_error`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| POST | `/api/v1/discovery/search` | `discovery_search` | `main/backend/app/api/discovery.py:28` |
| POST | `/api/v1/discovery/smart` | `discovery_smart` | `main/backend/app/api/discovery.py:84` |
| POST | `/api/v1/discovery/deep` | `discovery_deep` | `main/backend/app/api/discovery.py:138` |
| POST | `/api/v1/discovery/generate-keywords` | `generate_keywords_api` | `main/backend/app/api/discovery.py:187` |
| POST | `/api/v1/discovery/generate-subreddit-keywords` | `generate_subreddit_keywords_api` | `main/backend/app/api/discovery.py:261` |

#### `governance.py` (`/governance`)

- 主要依赖：`from services.governance import cleanup_old_data`；`from services.aggregator import sync_project_data_to_aggregator`；`from services.tasks import task_sync_aggregator`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| POST | `/api/v1/governance/cleanup` | `cleanup` | `main/backend/app/api/governance.py:23` |
| POST | `/api/v1/governance/aggregator/sync` | `sync_aggregator` | `main/backend/app/api/governance.py:29` |

#### `indexer.py` (`/indexer`)

- 主要依赖：`from services.indexer.policy import index_policy_documents`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| POST | `/api/v1/indexer/policy` | `reindex_policy` | `main/backend/app/api/indexer.py:19` |

#### `ingest.py` (`/ingest`)

- 主要依赖：`from services.ingest.policy import ingest_policy_documents`；`from services.ingest.market import ingest_market_data`；`from services.ingest.reports.california import collect_california_sales_reports`；`from services.ingest.news import collect_calottery_news, collect_calottery_retailer_updates, collect_reddit_discussions, collect_google_news`；`from services.ingest.social_application import SocialIngestApplicationService`；`from services.ingest.commodity import ingest_commodity_metrics`；...

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| POST | `/api/v1/ingest/policy` | `ingest_policy` | `main/backend/app/api/ingest.py:70` |
| POST | `/api/v1/ingest/market` | `ingest_market` | `main/backend/app/api/ingest.py:128` |
| GET | `/api/v1/ingest/history` | `ingest_history` | `main/backend/app/api/ingest.py:148` |
| POST | `/api/v1/ingest/reports/california` | `ingest_california_reports` | `main/backend/app/api/ingest.py:169` |
| POST | `/api/v1/ingest/news/calottery` | `ingest_calottery_news` | `main/backend/app/api/ingest.py:177` |
| POST | `/api/v1/ingest/news/calottery/retailer` | `ingest_calottery_retailer` | `main/backend/app/api/ingest.py:197` |
| POST | `/api/v1/ingest/social/reddit` | `ingest_reddit` | `main/backend/app/api/ingest.py:217` |
| POST | `/api/v1/ingest/reports/weekly` | `ingest_weekly_reports` | `main/backend/app/api/ingest.py:237` |
| POST | `/api/v1/ingest/reports/monthly` | `ingest_monthly_reports` | `main/backend/app/api/ingest.py:257` |
| POST | `/api/v1/ingest/social/sentiment` | `ingest_social_sentiment` | `main/backend/app/api/ingest.py:296` |
| POST | `/api/v1/ingest/policy/regulation` | `ingest_policy_regulation` | `main/backend/app/api/ingest.py:339` |
| POST | `/api/v1/ingest/commodity/metrics` | `ingest_commodity` | `main/backend/app/api/ingest.py:373` |
| POST | `/api/v1/ingest/ecom/prices` | `ingest_ecom_prices` | `main/backend/app/api/ingest.py:393` |

#### `llm_config.py` (`/llm-config`)

- 主要依赖：`from models.base import get_db`；`from models.entities import LlmServiceConfig`；`from services.llm.config_service import LlmConfigService`；`from contracts import success_response`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/llm-config` | `list_llm_configs` | `main/backend/app/api/llm_config.py:89` |
| GET | `/api/v1/llm-config/{service_name}` | `get_llm_config` | `main/backend/app/api/llm_config.py:96` |
| POST | `/api/v1/llm-config` | `create_llm_config` | `main/backend/app/api/llm_config.py:105` |
| PUT | `/api/v1/llm-config/{service_name}` | `update_llm_config` | `main/backend/app/api/llm_config.py:116` |
| DELETE | `/api/v1/llm-config/{service_name}` | `delete_llm_config` | `main/backend/app/api/llm_config.py:131` |

#### `market.py` (`/market`)

- 主要依赖：`from models.base import SessionLocal`；`from models.entities import MarketStat`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/market` | `market_stats` | `main/backend/app/api/market.py:23` |
| GET | `/api/v1/market/games` | `market_games` | `main/backend/app/api/market.py:100` |

#### `policies.py` (`/policies`)

- 主要依赖：`from models.base import SessionLocal`；`from models.entities import Document`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/policies` | `list_policies` | `main/backend/app/api/policies.py:40` |
| GET | `/api/v1/policies/stats` | `get_policy_stats` | `main/backend/app/api/policies.py:185` |
| GET | `/api/v1/policies/state/{state}` | `get_state_policies` | `main/backend/app/api/policies.py:312` |
| GET | `/api/v1/policies/{policy_id}` | `get_policy_detail` | `main/backend/app/api/policies.py:426` |

#### `process.py` (`/process`)

- 主要依赖：`from celery_app import celery_app`；`from models.base import SessionLocal`；`from models.entities import EtlJobRun`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/process/list` | `list_tasks` | `main/backend/app/api/process.py:39` |
| GET | `/api/v1/process/stats` | `get_task_stats` | `main/backend/app/api/process.py:146` |
| GET | `/api/v1/process/history` | `get_task_history` | `main/backend/app/api/process.py:188` |
| POST | `/api/v1/process/{task_id}/cancel` | `cancel_task` | `main/backend/app/api/process.py:261` |
| GET | `/api/v1/process/{task_id}` | `get_task_info` | `main/backend/app/api/process.py:281` |
| GET | `/api/v1/process/{task_id}/logs` | `get_task_logs` | `main/backend/app/api/process.py:321` |

#### `products.py` (`/products`)

- 主要依赖：`from models.base import SessionLocal`；`from models.entities import Product`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/products` | `list_products` | `main/backend/app/api/products.py:25` |
| POST | `/api/v1/products` | `create_product` | `main/backend/app/api/products.py:49` |
| PUT | `/api/v1/products/{product_id}` | `update_product` | `main/backend/app/api/products.py:67` |
| DELETE | `/api/v1/products/{product_id}` | `delete_product` | `main/backend/app/api/products.py:84` |

#### `projects.py` (`/projects`)

- 主要依赖：`from models.base import SessionLocal, engine`；`from models.base import Base`；`from models.entities import ConfigState, Document, Embedding, EtlJobRun, IngestChannel, LlmServiceConfig, MarketMetricPoint, MarketStat, PriceObservation, Product, Project, SearchHistory, SourceLibraryItem, Source, Topic`；`from services.projects.context import bind_schema, project_schema_name, _normalize_project_key`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/projects` | `list_projects` | `main/backend/app/api/projects.py:62` |
| POST | `/api/v1/projects` | `create_project` | `main/backend/app/api/projects.py:83` |
| PATCH | `/api/v1/projects/{project_key}` | `update_project` | `main/backend/app/api/projects.py:120` |
| POST | `/api/v1/projects/{project_key}/archive` | `archive_project` | `main/backend/app/api/projects.py:166` |
| POST | `/api/v1/projects/{project_key}/restore` | `restore_project` | `main/backend/app/api/projects.py:201` |
| POST | `/api/v1/projects/{project_key}/activate` | `activate_project` | `main/backend/app/api/projects.py:216` |
| DELETE | `/api/v1/projects/{project_key}` | `delete_project` | `main/backend/app/api/projects.py:237` |

#### `reports.py` (`/reports`)

- 主要依赖：`from services.report import generate_html_report, generate_csv_report`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| POST | `/api/v1/reports` | `create_report` | `main/backend/app/api/reports.py:18` |

#### `search.py` (`/search`)

- 主要依赖：`from services.search.es_client import get_es_client`；`from services.search.indexes import ensure_indices`；`from services.search.hybrid import hybrid_search`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/search` | `search` | `main/backend/app/api/search.py:13` |
| POST | `/api/v1/search/_init` | `init_search_indices` | `main/backend/app/api/search.py:43` |

#### `source_library.py` (`/source_library`)

- 主要依赖：`from models.base import SessionLocal`；`from models.entities import SourceLibraryItem`；`from services.projects import bind_project`；`from services.source_library import list_effective_channels, list_effective_items, run_item_by_key, sync_shared_library_from_files`；`from services.tasks import task_run_source_library_item`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/source_library/channels` | `list_channels` | `main/backend/app/api/source_library.py:46` |
| GET | `/api/v1/source_library/items` | `list_items` | `main/backend/app/api/source_library.py:58` |
| POST | `/api/v1/source_library/items` | `upsert_project_item` | `main/backend/app/api/source_library.py:70` |
| POST | `/api/v1/source_library/items/{item_key}/run` | `run_item` | `main/backend/app/api/source_library.py:98` |
| POST | `/api/v1/source_library/sync_shared_from_files` | `sync_shared_from_files` | `main/backend/app/api/source_library.py:119` |

#### `topics.py` (`/topics`)

- 主要依赖：`from models.base import SessionLocal`；`from models.entities import Topic`

| Method | Full Path (`/api/v1` + prefix) | Handler | 文件定位 |
| --- | --- | --- | --- |
| GET | `/api/v1/topics` | `list_topics` | `main/backend/app/api/topics.py:27` |
| POST | `/api/v1/topics` | `create_topic` | `main/backend/app/api/topics.py:51` |
| PUT | `/api/v1/topics/{topic_id}` | `update_topic` | `main/backend/app/api/topics.py:75` |
| DELETE | `/api/v1/topics/{topic_id}` | `delete_topic` | `main/backend/app/api/topics.py:99` |

## 5. 前端接口层（浏览器调用封装）

### 5.1 通用接口封装

- `main/frontend/static/js/app-shell.js`
- 功能：改写 `window.fetch`，统一注入 `X-Project-Key` 请求头与 `project_key` 查询参数；提供 `MarketApp.fetchJSON()`。
- 意义：前端页面无需显式处理多租户上下文，大多数同源请求自动带项目标识。

- `main/frontend/static/js/policy-api.js`
- 功能：封装政策模块专用 API（列表、统计、州详情、详情），统一 JSON 错误处理。
- 注意：该文件直接使用 `fetch`，但由于 `app-shell.js` 已改写全局 `window.fetch`，实际仍会携带项目上下文（前提是加载顺序正确）。

### 5.2 主要页面与接口依赖（按页面族）

| 页面/文件 | 功能 | 主要接口依赖 |
| --- | --- | --- |
| `index.html` | 首页/操作面板 | `/api/v1/ingest/* history` |
| `settings.html` | 配置页 | `/api/v1/config/env, /api/v1/llm-config` |
| `admin.html` | 管理页 | `/api/v1/admin/*` |
| `dashboard.html` | 综合仪表盘 | `/api/v1/dashboard/*` |
| `policy-dashboard.html / policy-visualization.html / policy-state-detail.html / policy-tracking.html` | 政策可视化页 | `/api/v1/policies*, /api/v1/maps/usa` |
| `market-data-visualization.html` | 市场可视化页 | `/api/v1/dashboard/market-trends, /api/v1/admin/market-graph, /api/v1/admin/documents/{id}` |
| `social-media-visualization.html / social-media-graph.html` | 社交可视化页 | `/api/v1/dashboard/sentiment-*, /api/v1/admin/content-graph, /api/v1/admin/documents/{id}` |
| `project-management.html / app.html` | 项目管理与壳层 | `/api/v1/projects*` |
| `process-management.html` | 任务管理页 | `/api/v1/process/*` |

## 6. 内部接口抽象层（服务边界）

### 6.1 统一响应 Contract（`main/backend/app/contracts`）

- `api.py`：定义 `success_response()` / `error_response()` 响应包裹结构。
- `errors.py`：定义 `ErrorCode` 枚举与 `map_exception_to_error()`，用于异常到业务错误码映射。
- `tasks.py`：定义 `task_result_response()`，统一异步任务返回结构（`task_id`、`async`、`status`、`result`）。

### 6.2 Port/Adapter 接口抽象

- `main/backend/app/services/discovery/ports.py`：定义 `DiscoverySearchPort`、`DiscoveryStorePort`（Protocol）。
- `main/backend/app/services/discovery/adapters.py`：`DefaultDiscoveryAdapter` 将发现接口调用桥接到 `search.web` / `search.smart` / `deep_search` / `store`。
- `main/backend/app/services/llm/ports.py`：定义 `ChatPort`、`EmbeddingPort`、`PromptConfigPort`。
- `main/backend/app/services/llm/adapters/langchain_provider.py`：LLM Provider 适配器，按配置切换 `OpenAI / Azure / Ollama`。

### 6.3 异步任务接口层（Celery）

- `main/backend/app/services/tasks.py` 将多个 ingest/index/source_library/governance 能力暴露为 Celery task，是 HTTP 接口层与后台执行层之间的桥接接口。
- 典型模式：HTTP 路由接受参数 -> 判断同步/异步模式 -> 调 Celery task 或直接调用 service -> 返回 `task_result_response` / 普通结果。

### 6.4 外部 HTTP 调用接口封装

- `main/backend/app/services/http/client.py` 提供 `HttpClient`（`get_json` / `get_text`），内置代理读取、重试、退避和统一 UA。
- 作用：给发现/抓取等服务作为底层上游调用接口，减少散落的 `httpx` 直连。

## 7. 关键接口调用链（典型路径）

1. 采集链路（`/api/v1/ingest/*`）
- `api/ingest.py` 接收请求并参数校验 -> `services.tasks`（异步）或 `services.ingest.*`（同步）-> 适配器层抓取外部数据 -> `models` 入库 -> （部分场景）索引/抽取。

2. 发现链路（`/api/v1/discovery/*`）
- `api/discovery.py` -> `DiscoveryApplicationService` -> `DefaultDiscoveryAdapter` -> `search.web/smart` 或 `deep_search` -> 可选 `store()` 落库。

3. 多租户路由上下文
- 前端 `app-shell.js` 注入 `X-Project-Key` / `project_key` -> 后端 `metrics_middleware` 调 `bind_project(project_key)` -> 后续数据库访问在当前租户 schema 上执行。

## 8. 现状观察（接口层风险与改进建议）

1. 响应格式不统一
- 部分接口使用 `contracts.success_response/error_response`，部分接口直接返回原始 dict/list 或抛 `HTTPException`。前端在跨模块复用时需要写分支逻辑。

2. 错误处理策略不统一
- 同时存在 `HTTPException`、`JSONResponse` 包装、异常直抛、合同化错误码映射，建议在 API 层增加统一异常处理器。

3. 多租户上下文依赖“隐式回退”
- 当请求未携带项目标识时会回退到激活项目，便于使用，但也提高了误写/误读到默认租户的风险。管理/写入接口建议强制显式项目键。

4. `main.py` 职责较重
- 同时承担项目 bootstrap/migration、middleware、监控、页面路由、API 装配，后续可拆为 `lifespan`/`routers/ui`/`routers/system`。

5. 大型管理接口模块体量过大
- `api/admin.py` 和 `api/dashboard.py` 路由密集且职责较宽，建议按“文档管理 / 图谱 / 搜索历史 / 统计分析”拆分。

6. 前端接口调用封装存在双轨
- 既有 `MarketApp.fetchJSON` 通用层，也有页面内 `fetch` 直连与 `policy-api.js` 专用封装。建议收敛到统一 SDK 风格（至少统一错误解析）。

## 9. 建议的后续产物（如需继续深入）

1. 生成机器可校验的 OpenAPI 差异基线（按版本管理接口变更）。
2. 为 17 个 API 模块补齐“请求参数/响应字段/错误码”级别的详细接口规范。
3. 建立前端页面 -> 后端端点依赖矩阵（含字段级依赖与刷新频率）。
4. 对写操作接口增加鉴权/审计策略梳理（当前代码层未见统一鉴权中间件）。

---

本调查文档基于代码静态扫描生成，统计口径以 `main/backend/app/main.py` 与 `main/backend/app/api/*.py` 当前代码为准。