# 图谱生成系统标准文档

> 最后更新：2026-02 | 文档索引：`docs/README.md`

## 1. 概述

### 1.1 功能说明

图谱生成系统是一个基于知识图谱的数据可视化与分析工具，支持两种类型的图谱：

1. **社交平台内容图谱**：从社交媒体数据中提取关键信息并构建关系网络，支持多平台数据（Reddit、Twitter等），能够识别关键词、实体、主题、情感等要素。

2. **市场数据图谱**：从市场数据中构建关系网络，展示市场数据、州、游戏类型、实体之间的关联关系，用于市场数据分析和可视化。

### 1.2 核心特性

- **多数据类型支持**：支持社交媒体内容和市场数据两种类型
- **多平台支持**：统一的数据模型，支持不同社交媒体平台
- **智能提取**：自动识别关键词、实体、主题、情感标签
- **关系构建**：构建数据点、关键词、实体、主题、用户之间的关联网络
- **权重计算**：支持TF-IDF权重计算和时间衰减（社交平台图谱）
- **子图提取**：支持按主题提取子图（社交平台图谱）
- **可视化展示**：提供交互式图谱可视化界面，支持全屏显示

### 1.2.1 内容图谱数据结构规范（精简版并入说明）

原独立文档 `社交平台数据结构说明.md` 已并入本标准与 `社交平台内容图谱API.md`。本标准负责结构建模与原则，API 文档负责接口与示例。

内容图谱最小建模对象（摘要）：

- 节点：`Post`、`Keyword`、`Entity`、`Topic`、`SentimentTag`、`User`、`Subreddit`
- 边：`MENTIONS_KEYWORD`、`MENTIONS_ENTITY`、`HAS_TOPIC`、`HAS_SENTIMENT`、`AUTHORED_BY`、`IN_SUBREDDIT`、`CO_OCCURS`

建议最小输入字段：

- `text`
- `keywords[]`
- `entities[]`
- `sentiment`（orientation/tags/key_phrases/emotion_words/topic）
- `username`
- `subreddit`

### 1.3 应用场景

**社交平台内容图谱：**
- 社交媒体内容分析
- 话题趋势追踪
- 用户行为分析
- 情感分析可视化
- 关键词共现分析
- 实体关系挖掘

**市场数据图谱：**
- 市场数据分析
- 州级数据对比
- 游戏类型分析
- 市场趋势可视化
- 数据关联性分析

## 2. 架构设计

### 2.1 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                     前端展示层                           │
│  ┌──────────────────────┐  ┌──────────────────────┐  │
│  │ social-media-graph   │  │ market-data-         │  │
│  │ .html                │  │ visualization.html   │  │
│  │ (ECharts可视化)      │  │ (ECharts可视化)      │  │
│  └──────────────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↕ HTTP/JSON
┌─────────────────────────────────────────────────────────┐
│                      API接口层                           │
│  ┌──────────────────────┐  ┌──────────────────────┐  │
│  │ /api/v1/admin/       │  │ /api/v1/admin/       │  │
│  │ content-graph        │  │ market-graph         │  │
│  │ - 查询参数过滤       │  │ - 查询参数过滤       │  │
│  │ - 数据规范化         │  │ - 数据规范化         │  │
│  │ - 图谱构建           │  │ - 图谱构建           │  │
│  │ - JSON导出           │  │ - JSON导出           │  │
│  └──────────────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────┐
│                     业务逻辑层                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  数据适配器   │  │  图谱构建器   │  │  数据导出器   │ │
│  │  adapters/   │→ │  builder.py  │→ │  exporter.py │ │
│  │  - reddit.py │  │  - build_     │  │              │ │
│  │  - market.py │  │    graph()   │  │              │ │
│  └──────────────┘  │  - build_     │  └──────────────┘ │
│                    │    market_    │                   │
│                    │    graph()    │                   │
│                    └──────────────┘                   │
└─────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────┐
│                     数据存储层                           │
│  ┌──────────────────────────────────────────────────┐  │
│  │  PostgreSQL (Document表)                         │  │
│  │  - doc_type = "social_sentiment" (社交平台)     │  │
│  │  - doc_type = "market" (市场数据)               │  │
│  │  - extracted_data (JSON)                        │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 目录结构

```
backend/
├── app/
│   ├── api/
│   │   └── admin.py              # API接口定义
│   ├── services/
│   │   └── graph/
│   │       ├── __init__.py
│   │       ├── models.py         # 数据模型定义
│   │       ├── builder.py        # 核心构图逻辑
│   │       ├── exporter.py       # 导出功能
│   │       └── adapters/
│   │           ├── __init__.py   # 适配器注册
│   │           ├── reddit.py      # Reddit平台适配器
│   │           └── market.py      # 市场数据适配器
│   └── settings/
│       └── graph.py              # 图谱配置
├── scripts/
│   └── export_content_graph.py   # CLI导出脚本
└── docs/
    └── 社交平台图谱生成标准文档.md  # 本文档

frontend/
└── templates/
    ├── social-media-graph.html    # 社交平台图谱页面
    └── market-data-visualization.html  # 市场数据图谱页面
```

## 3. API接口文档

### 3.1 获取社交平台内容图谱

**接口地址：** `GET /api/v1/admin/content-graph`

**接口描述：** 根据筛选条件获取社交平台内容图谱数据

**请求参数：**

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| start_date | string | 否 | - | 开始日期，格式：YYYY-MM-DD |
| end_date | string | 否 | - | 结束日期，格式：YYYY-MM-DD |
| platform | string | 否 | - | 平台名称，如：reddit, twitter |
| topic | string | 否 | - | 主题过滤（模糊匹配） |
| limit | integer | 否 | 100 | 限制文档数量，范围：1-500 |

**请求示例：**

```bash
# 获取最近30天的Reddit数据
GET /api/v1/admin/content-graph?start_date=2025-01-01&end_date=2025-01-31&platform=reddit&limit=100

# 获取特定主题的数据
GET /api/v1/admin/content-graph?topic=lottery&limit=200
```

**响应格式：**

```json
{
  "nodes": [
    {
      "type": "Post",
      "id": "12345",
      "properties": {
        "uri": "https://reddit.com/r/lottery/...",
        "platform": "reddit",
        "text": "帖子内容...",
        "publish_date": "2025-01-15T10:30:00",
        "sentiment_orientation": "positive",
        "username": "user123",
        "subreddit": "lottery"
      }
    },
    {
      "type": "Keyword",
      "id": "sha1_hash",
      "properties": {
        "text": "powerball"
      }
    }
  ],
  "edges": [
    {
      "type": "MENTIONS_KEYWORD",
      "from": {
        "type": "Post",
        "id": "12345"
      },
      "to": {
        "type": "Keyword",
        "id": "sha1_hash"
      },
      "properties": {
        "weight": 0.85
      }
    }
  ]
}
```

**响应状态码：**

- `200 OK`：成功返回图谱数据（即使数据为空也返回空图谱）
- `500 Internal Server Error`：服务器内部错误

**注意事项：**

1. 即使查询结果为空，API也会返回空图谱结构（`{"nodes": [], "edges": []}`），而不是错误
2. 主题过滤使用模糊匹配（`topic.lower() in doc_topic`）
3. 平台过滤区分大小写，但内部会转换为小写比较
4. 时间过滤会同时检查`publish_date`和`created_at`字段

### 3.2 获取市场数据图谱

**接口地址：** `GET /api/v1/admin/market-graph`

**接口描述：** 根据筛选条件获取市场数据图谱

**请求参数：**

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| start_date | string | 否 | - | 开始日期，格式：YYYY-MM-DD |
| end_date | string | 否 | - | 结束日期，格式：YYYY-MM-DD |
| state | string | 否 | - | 州代码过滤，如：CA |
| game | string | 否 | - | 游戏类型过滤（模糊匹配） |
| limit | integer | 否 | 100 | 限制数据数量，范围：1-500 |

**请求示例：**

```bash
# 获取加州的市场数据
GET /api/v1/admin/market-graph?start_date=2025-01-01&end_date=2025-01-31&state=CA&limit=100

# 获取特定游戏的数据
GET /api/v1/admin/market-graph?game=Powerball&limit=200
```

**响应格式：**

```json
{
  "nodes": [
    {
      "type": "MarketData",
      "id": "12345",
      "properties": {
        "title": "加州Powerball销售报告",
        "state": "CA",
        "game": "Powerball",
        "date": "2025-01-15T00:00:00",
        "revenue": 1500000.0,
        "sales_volume": 5000000.0,
        "source_name": "California Lottery"
      }
    },
    {
      "type": "State",
      "id": "CA",
      "properties": {
        "name": "CA"
      }
    },
    {
      "type": "Game",
      "id": "powerball",
      "properties": {
        "name": "Powerball"
      }
    }
  ],
  "edges": [
    {
      "type": "IN_STATE",
      "from": {
        "type": "MarketData",
        "id": "12345"
      },
      "to": {
        "type": "State",
        "id": "CA"
      },
      "properties": {
        "weight": 1.0
      }
    },
    {
      "type": "HAS_GAME",
      "from": {
        "type": "MarketData",
        "id": "12345"
      },
      "to": {
        "type": "Game",
        "id": "powerball"
      },
      "properties": {
        "weight": 1.0
      }
    }
  ]
}
```

**响应状态码：**

- `200 OK`：成功返回图谱数据（即使数据为空也返回空图谱）
- `500 Internal Server Error`：服务器内部错误

**注意事项：**

1. 即使查询结果为空，API也会返回空图谱结构（`{"nodes": [], "edges": []}`），而不是错误
2. 游戏过滤使用模糊匹配（`game.lower() in doc_game`）
3. 州代码过滤会同时检查`Document.state`和`extracted_data.market.state`
4. 时间过滤会同时检查`publish_date`、`created_at`和`extracted_data.market.report_date`字段

## 4. 数据模型

### 4.1 NormalizedMarketData（规范化市场数据）

市场数据的统一数据结构：

```python
@dataclass
class NormalizedMarketData:
    stat_id: int                    # 文档ID
    state: str                      # 州代码（如CA）
    game: Optional[str] = None      # 游戏类型
    date: Optional[datetime] = None # 报告日期
    sales_volume: Optional[float] = None  # 销售量
    revenue: Optional[float] = None       # 收入
    jackpot: Optional[float] = None       # 奖池
    ticket_price: Optional[float] = None  # 票价
    source_name: Optional[str] = None     # 数据源名称
    source_uri: Optional[str] = None      # 数据源URI
    title: Optional[str] = None          # 文档标题
    entities: List[Dict] = []            # 实体列表
```

### 4.1 NormalizedSocialPost（规范化社交媒体帖子）

统一的数据结构，用于跨平台数据标准化：

```python
@dataclass
class NormalizedSocialPost:
    doc_id: int                    # 文档ID
    uri: str                       # 原始URI
    platform: str                  # 平台名称（reddit, twitter等）
    text: str                      # 帖子文本内容
    username: Optional[str] = None # 用户名
    subreddit: Optional[str] = None # 子论坛（Reddit特有）
    publish_date: Optional[datetime] = None # 发布时间
    createdAt: Optional[datetime] = None    # 创建时间
    state: Optional[str] = None   # 州代码（如CA）
    sentiment_orientation: Optional[str] = None # 情感倾向：positive/negative/neutral
    sentiment_tags: List[str] = [] # 情感标签列表
    key_phrases: List[str] = []   # 关键短语
    emotion_words: List[str] = []  # 情感词
    topic: Optional[str] = None    # 主题
    entities: List[Dict] = []      # 实体列表
    keywords: List[str] = []       # 关键词列表
```

### 4.2 NormalizedSocialPost（规范化社交媒体帖子）

统一的数据结构，用于跨平台数据标准化：

```python
@dataclass
class NormalizedSocialPost:
    doc_id: int                    # 文档ID
    uri: str                       # 原始URI
    platform: str                  # 平台名称（reddit, twitter等）
    text: str                      # 帖子文本内容
    username: Optional[str] = None # 用户名
    subreddit: Optional[str] = None # 子论坛（Reddit特有）
    publish_date: Optional[datetime] = None # 发布时间
    createdAt: Optional[datetime] = None    # 创建时间
    state: Optional[str] = None   # 州代码（如CA）
    sentiment_orientation: Optional[str] = None # 情感倾向：positive/negative/neutral
    sentiment_tags: List[str] = [] # 情感标签列表
    key_phrases: List[str] = []   # 关键短语
    emotion_words: List[str] = []  # 情感词
    topic: Optional[str] = None    # 主题
    entities: List[Dict] = []      # 实体列表
    keywords: List[str] = []       # 关键词列表
```

### 4.3 Graph（图谱结构）

```python
@dataclass
class Graph:
    nodes: Dict[str, GraphNode]    # 节点字典，key为"Type:id"
    edges: List[GraphEdge]         # 边列表
    schema_version: str = "v1"     # 图谱版本
```

### 4.4 GraphNode（图谱节点）

```python
@dataclass
class GraphNode:
    type: str                      # 节点类型
    id: str                        # 节点唯一标识
    properties: Dict[str, Any]     # 节点属性
```

### 4.5 GraphEdge（图谱边）

```python
@dataclass
class GraphEdge:
    type: str                      # 边类型
    from_node: GraphNode           # 源节点
    to_node: GraphNode             # 目标节点
    properties: Dict[str, Any]     # 边属性（如权重）
```

## 5. 节点类型

### 5.1 社交平台内容图谱节点

#### 5.1.1 Post（帖子节点）

- **ID格式**：`Post:{doc_id}`
- **属性**：
  - `uri`: 原始URI
  - `platform`: 平台名称
  - `text`: 帖子文本（截取前500字符）
  - `publish_date`: 发布时间（ISO格式）
  - `created_at`: 创建时间（ISO格式）
  - `state`: 州代码
  - `sentiment_orientation`: 情感倾向
  - `username`: 用户名
  - `subreddit`: 子论坛
  - `topic`: 主题
  - `sentiment_tags`: 情感标签列表
  - `key_phrases`: 关键短语列表
  - `emotion_words`: 情感词列表

#### 5.1.2 Keyword（关键词节点）

- **ID格式**：`Keyword:{sha1(lower(text)+lang)}`
- **属性**：
  - `text`: 关键词文本（小写规范化）

**说明**：
- 关键词统一转换为小写并去重
- 每个帖子最多保留10个关键词（`MAX_KEYWORDS_PER_POST`）
- 使用SHA1哈希生成唯一ID

#### 5.1.3 Entity（实体节点）

- **ID格式**：`Entity:{kb_id}` 或 `Entity:{sha1(canonical_name+type)}`
- **属性**：
  - `canonical_name`: 规范名称
  - `type`: 实体类型（PERSON, ORGANIZATION, LOCATION等）
  - `kb_id`: 知识库ID（如果存在）

#### 5.1.4 Topic（主题节点）

- **ID格式**：`Topic:{label.lower().strip()}`
- **属性**：
  - `label`: 主题标签

#### 5.1.5 SentimentTag（情感标签节点）

- **ID格式**：`SentimentTag:{tag.lower().strip()}`
- **属性**：
  - `label`: 情感标签文本

#### 5.1.6 User（用户节点）

- **ID格式**：`User:{platform}:{username}`
- **属性**：
  - `platform`: 平台名称
  - `username`: 用户名

#### 5.1.7 Subreddit（子论坛节点）

### 5.2 市场数据图谱节点

#### 5.2.1 MarketData（市场数据节点）

- **ID格式**：`MarketData:{stat_id}`
- **属性**：
  - `title`: 文档标题
  - `state`: 州代码
  - `game`: 游戏类型
  - `date`: 报告日期（ISO格式）
  - `sales_volume`: 销售量
  - `revenue`: 收入
  - `jackpot`: 奖池金额
  - `ticket_price`: 票价
  - `source_name`: 数据源名称
  - `source_uri`: 数据源URI

#### 5.2.2 State（州节点）

- **ID格式**：`State:{state_code.upper().strip()}`
- **属性**：
  - `name`: 州代码（如CA）

#### 5.2.3 Game（游戏节点）

- **ID格式**：`Game:{game.lower().strip()}`
- **属性**：
  - `name`: 游戏名称（如Powerball）

#### 5.2.4 Entity（实体节点）

- **ID格式**：`Entity:{kb_id}` 或 `Entity:{sha1(canonical_name+type)}`
- **属性**：
  - `canonical_name`: 规范名称
  - `entity_type`: 实体类型（注意：使用`entity_type`避免与节点`type`冲突）
  - `kb_id`: 知识库ID（如果存在）

- **ID格式**：`Subreddit:{name.lower().strip()}`
- **属性**：
  - `name`: 子论坛名称

## 6. 边类型

### 6.1 社交平台内容图谱边

#### 6.1.1 MENTIONS_KEYWORD

- **方向**：`Post → Keyword`
- **说明**：帖子提及关键词
- **属性**：
  - `weight`: 权重（TF-IDF值或频次）

#### 6.1.2 MENTIONS_ENTITY

- **方向**：`Post → Entity`
- **说明**：帖子提及实体
- **属性**：
  - `positions`: 实体在文本中的位置
  - `confidence`: 置信度

#### 6.1.3 HAS_TOPIC

- **方向**：`Post → Topic`
- **说明**：帖子属于某个主题

#### 6.1.4 HAS_SENTIMENT

- **方向**：`Post → SentimentTag`
- **说明**：帖子包含情感标签
- **属性**：
  - `orientation`: 情感倾向（positive/negative/neutral）

#### 6.1.5 AUTHORED_BY

- **方向**：`Post → User`
- **说明**：帖子由用户发布

#### 6.1.6 IN_SUBREDDIT

- **方向**：`Post → Subreddit`
- **说明**：帖子发布在某个子论坛

#### 6.1.7 CO_OCCURS

- **方向**：`Keyword → Keyword`
- **说明**：关键词共现关系
- **属性**：
  - `weight`: 共现权重
  - `window`: 共现窗口大小

### 6.2 市场数据图谱边

#### 6.2.1 IN_STATE

- **方向**：`MarketData → State`
- **说明**：市场数据属于某个州
- **属性**：
  - `weight`: 权重（固定为1.0）

#### 6.2.2 HAS_GAME

- **方向**：`MarketData → Game`
- **说明**：市场数据关联某个游戏类型
- **属性**：
  - `weight`: 权重（固定为1.0）

#### 6.2.3 MENTIONS_ENTITY

- **方向**：`MarketData → Entity`
- **说明**：市场数据提及某个实体
- **属性**：
  - `weight`: 权重（固定为1.0）

## 7. 图谱构建流程

### 7.1 社交平台内容图谱构建步骤

1. **数据查询**
   - 从`Document`表查询`doc_type = "social_sentiment"`的文档
   - 根据时间、平台、主题等条件过滤

2. **数据规范化**
   - 使用适配器将原始文档转换为`NormalizedSocialPost`
   - 提取关键词、实体、主题、情感等信息

3. **节点构建（第一遍遍历）**
   - 创建Post节点
   - 创建Keyword节点（去重）
   - 创建Entity节点（去重）
   - 创建Topic节点
   - 创建SentimentTag节点
   - 创建User节点
   - 创建Subreddit节点

4. **权重计算**
   - 计算TF-IDF分数（如果启用）
   - 应用时间衰减（如果启用）

5. **边构建（第二遍遍历）**
   - 构建`Post → Keyword`边
   - 构建`Post → Entity`边
   - 构建`Post → Topic`边
   - 构建`Post → SentimentTag`边
   - 构建`Post → User`边
   - 构建`Post → Subreddit`边
   - 构建`Keyword → Keyword`共现边

6. **子图提取（可选）**
   - 如果指定了`topic`参数，提取主题子图

7. **数据导出**
   - 将图谱转换为JSON格式
   - 返回给前端

### 7.2 市场数据图谱构建步骤

1. **数据查询**
   - 从`Document`表查询`doc_type = "market"`的文档
   - 根据时间、州、游戏等条件过滤

2. **数据规范化**
   - 使用`MarketAdapter`将原始文档转换为`NormalizedMarketData`
   - 提取州、游戏、日期、收入、实体等信息

3. **节点构建（第一遍遍历）**
   - 创建MarketData节点
   - 创建State节点（去重）
   - 创建Game节点（去重）
   - 创建Entity节点（去重）

4. **边构建（第二遍遍历）**
   - 构建`MarketData → State`边（IN_STATE）
   - 构建`MarketData → Game`边（HAS_GAME）
   - 构建`MarketData → Entity`边（MENTIONS_ENTITY）

5. **数据导出**
   - 将图谱转换为JSON格式
   - 返回给前端

**注意**：市场数据图谱不使用共现边，相似的数据点会通过力导向图布局算法自然靠近（因为它们都连接到相同的State和Game节点）。

### 7.3 权重计算（仅社交平台内容图谱）

#### TF-IDF权重

如果启用`use_tfidf=True`：

```python
TF(t, d) = (关键词t在文档d中的出现次数) / (文档d的总词数)
IDF(t) = log(总文档数 / 包含关键词t的文档数)
TF-IDF(t, d) = TF(t, d) * IDF(t)
```

#### 时间衰减

如果启用时间衰减（`tau`参数）：

```python
decay = exp(-days_ago / tau)
weight = original_weight * decay
```

其中`days_ago`是距离参考日期的天数。

### 7.4 共现关系（仅社交平台内容图谱）

关键词共现关系支持两种模式：

1. **整帖共现**（`window=0`）：同一帖子中的所有关键词两两共现
2. **滑动窗口共现**（`window>0`）：在指定窗口大小内共现的关键词建立关系

## 8. 配置参数

配置文件：`app/settings/graph.py`

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `COOCCUR_WINDOW` | int | 0 | 共现窗口大小（0=整帖共现） |
| `USE_TFIDF` | bool | True | 是否使用TF-IDF计算权重 |
| `TIME_DECAY_TAU_DAYS` | Optional[int] | None | 时间衰减参数（天数） |
| `MAX_KEYWORDS_PER_POST` | int | 10 | 每个帖子最多保留的关键词数量 |

## 9. 使用示例

### 9.1 API调用示例

#### 社交平台内容图谱 - Python示例

```python
import requests

# 获取最近7天的Reddit数据
response = requests.get(
    'http://localhost:8000/api/v1/admin/content-graph',
    params={
        'start_date': '2025-01-24',
        'end_date': '2025-01-31',
        'platform': 'reddit',
        'limit': 100
    }
)

graph_data = response.json()
print(f"节点数: {len(graph_data['nodes'])}")
print(f"边数: {len(graph_data['edges'])}")
```

#### 社交平台内容图谱 - JavaScript示例

```javascript
// 获取特定主题的图谱数据
async function loadGraph() {
  const params = new URLSearchParams({
    start_date: '2025-01-01',
    end_date: '2025-01-31',
    topic: 'lottery',
    limit: 100
  });
  
  const response = await fetch(`/api/v1/admin/content-graph?${params}`);
  const graphData = await response.json();
  
  console.log('节点数:', graphData.nodes.length);
  console.log('边数:', graphData.edges.length);
  
  // 渲染图谱
  renderGraph(graphData);
}
```

#### 市场数据图谱 - Python示例

```python
import requests

# 获取加州的市场数据
response = requests.get(
    'http://localhost:8000/api/v1/admin/market-graph',
    params={
        'start_date': '2025-01-01',
        'end_date': '2025-01-31',
        'state': 'CA',
        'limit': 100
    }
)

graph_data = response.json()
print(f"节点数: {len(graph_data['nodes'])}")
print(f"边数: {len(graph_data['edges'])}")
```

#### 市场数据图谱 - JavaScript示例

```javascript
// 获取特定游戏的市场数据
async function loadMarketGraph() {
  const params = new URLSearchParams({
    start_date: '2025-01-01',
    end_date: '2025-01-31',
    game: 'Powerball',
    limit: 100
  });
  
  const response = await fetch(`/api/v1/admin/market-graph?${params}`);
  const graphData = await response.json();
  
  console.log('节点数:', graphData.nodes.length);
  console.log('边数:', graphData.edges.length);
  
  // 渲染图谱
  renderMarketGraph(graphData);
}
```

### 9.2 CLI导出示例

```bash
# 导出最近7天的内容图谱
python scripts/export_content_graph.py -o output/graph.json --days 7

# 导出指定时间范围
python scripts/export_content_graph.py -o output/graph.json \
    --since 2025-01-01T00:00:00 \
    --until 2025-01-31T23:59:59

# 导出特定主题的子图
python scripts/export_content_graph.py -o output/topic_graph.json \
    --days 30 \
    --topic "lottery strategy"

# 导出特定平台的数据
python scripts/export_content_graph.py -o output/reddit_graph.json \
    --days 30 \
    --platform reddit

# 使用滑动窗口共现
python scripts/export_content_graph.py -o output/graph.json \
    --days 7 \
    --window 5

# 启用时间衰减
python scripts/export_content_graph.py -o output/graph.json \
    --days 30 \
    --tau 30
```

## 10. 前端集成

### 10.1 页面结构

#### 10.1.1 社交平台内容图谱页面

前端页面：`frontend/templates/social-media-graph.html`

主要组件：
- 筛选器：日期范围、平台、主题
- 统计面板：节点数、边数、帖子数、关键词数
- 图谱可视化：基于ECharts的交互式图谱
- 详情模态框：点击节点显示详细信息
- 全屏功能：支持全屏显示，覆盖侧边栏

#### 10.1.2 市场数据图谱页面

前端页面：`frontend/templates/market-data-visualization.html`

主要组件：
- 筛选器：日期范围、州、游戏类型
- 统计面板：节点数、边数、市场数据数、州数、游戏数、实体数
- 图谱可视化：基于ECharts的交互式图谱
- 详情模态框：点击MarketData节点显示详细信息
- 全屏功能：支持全屏显示，覆盖侧边栏

### 10.2 数据加载流程

#### 社交平台内容图谱

```javascript
// 1. 用户设置筛选条件
const start = document.getElementById('filter-start').value;
const end = document.getElementById('filter-end').value;
const platform = document.getElementById('filter-platform').value;
const topic = document.getElementById('filter-topic').value;

// 2. 调用API获取数据
const response = await fetch(`/api/v1/admin/content-graph?${params}`);

// 3. 解析响应数据
const graphData = await response.json();

// 4. 转换为ECharts格式
const echartsNodes = convertNodes(graphData.nodes);
const echartsLinks = convertEdges(graphData.edges);

// 5. 渲染图谱
graphChart.setOption({
  series: [{
    type: 'graph',
    data: echartsNodes,
    links: echartsLinks,
    // ... 其他配置
  }]
});
```

#### 市场数据图谱

```javascript
// 1. 用户设置筛选条件
const start = document.getElementById('graph-filter-start').value;
const end = document.getElementById('graph-filter-end').value;
const state = document.getElementById('graph-filter-state').value;
const game = document.getElementById('graph-filter-game').value;

// 2. 调用API获取数据
const response = await fetch(`/api/v1/admin/market-graph?${params}`);

// 3. 解析响应数据
const graphData = await response.json();

// 4. 转换为ECharts格式
const echartsNodes = convertMarketNodes(graphData.nodes);
const echartsLinks = convertMarketEdges(graphData.edges);

// 5. 渲染图谱
marketGraphChart.setOption({
  series: [{
    type: 'graph',
    data: echartsNodes,
    links: echartsLinks,
    // ... 其他配置
  }]
});
```

### 10.3 节点大小算法

节点大小根据链接数量（度数）动态计算，使用非线性映射显著区分节点重要程度：

#### 社交平台内容图谱节点大小

```javascript
function getNodeSize(nodeType, normalizedDegree, degree, minDegree, maxDegree) {
  // 使用指数函数进行非线性映射
  const exponent = 0.5; // 平方根函数
  const degreeFactor = Math.pow(normalizedDegree, exponent);
  
  // 基础大小和最大大小
  const minSize = baseSize[nodeType] || 15;
  const maxSize = maxSize[nodeType] || 40;
  
  // 计算最终大小
  let size = minSize + (maxSize - minSize) * degreeFactor;
  
  // 高链接数节点额外放大
  if (normalizedDegree > 0.7) {
    const boost = 1.0 + (normalizedDegree - 0.7) * 0.5;
    size = Math.min(size * boost, maxSize);
  }
  
  return Math.round(size);
}
```

#### 市场数据图谱节点大小

```javascript
function getMarketNodeSize(nodeType, normalizedDegree, degree, minDegree, maxDegree) {
  // 基础大小
  const baseSize = {
    'MarketData': 15,
    'State': 30,
    'Game': 25,
    'Entity': 20
  };
  const maxSize = {
    'MarketData': 40,
    'State': 60,
    'Game': 50,
    'Entity': 45
  };
  
  const minSize = baseSize[nodeType] || 15;
  const maxNodeSize = maxSize[nodeType] || 40;
  
  // 如果度数为0，直接返回最小大小
  if (degree === 0) {
    return minSize;
  }
  
  // 使用指数函数进行非线性映射
  const exponent = 0.5; // 平方根函数
  const clampedNormalizedDegree = Math.max(0, Math.min(1, normalizedDegree));
  const degreeFactor = Math.pow(clampedNormalizedDegree, exponent);
  
  // 计算最终大小
  let size = minSize + (maxNodeSize - minSize) * degreeFactor;
  
  // 高链接数节点额外放大
  if (clampedNormalizedDegree > 0.7) {
    const highDegreeBoost = 1.0 + (clampedNormalizedDegree - 0.7) * 0.5;
    size = size * highDegreeBoost;
    size = Math.min(size, maxNodeSize);
  }
  
  // 有链接的节点设置最小底线
  if (degree > 0) {
    const minFloor = minSize * 1.2;
    size = Math.max(size, minFloor);
  }
  
  return Math.round(size);
}
```

### 10.4 全屏功能

两个图谱都支持全屏显示，覆盖整个视口（包括侧边栏）：

**实现原理：**
1. 创建独立的全屏视图容器（`#graph-fullscreen-view`）
2. 全屏时隐藏原图表，显示全屏容器
3. 复制图表配置到全屏容器，创建新的图表实例
4. 通过`postMessage`通知父窗口（`app.html`）隐藏侧边栏

**代码示例：**

```javascript
// 全屏功能 - 提取视图到全屏容器
let isFullscreen = false;
let fullscreenChart = null;

function toggleFullscreen() {
  const fullscreenView = document.getElementById('graph-fullscreen-view');
  const originalChart = document.getElementById('graph-chart');
  const fullscreenChartEl = document.getElementById('fullscreen-graph-chart');
  
  if (isFullscreen) {
    // 退出全屏
    isFullscreen = false;
    fullscreenView.classList.remove('active');
    
    // 销毁全屏图表
    if (fullscreenChart) {
      fullscreenChart.dispose();
      fullscreenChart = null;
    }
    
    // 恢复原图表显示
    originalChart.style.display = 'block';
    
    // 通知父窗口显示侧边栏
    window.parent.postMessage({ type: 'fullscreen', action: 'exit' }, '*');
  } else {
    // 进入全屏
    isFullscreen = true;
    originalChart.style.display = 'none';
    fullscreenView.classList.add('active');
    
    // 复制图表配置到全屏容器
    const option = graphChart.getOption();
    fullscreenChart = echarts.init(fullscreenChartEl);
    fullscreenChart.setOption(option);
    
    // 通知父窗口隐藏侧边栏
    window.parent.postMessage({ type: 'fullscreen', action: 'enter' }, '*');
  }
}
```

### 10.5 图例配置

两个图谱都使用图形符号而非颜色来区分节点类型：

**社交平台内容图谱图例：**
- Post: `circle` (圆形)
- Keyword: `diamond` (菱形)
- Entity: `rect` (矩形)
- Topic: `triangle` (三角形)
- SentimentTag: `pin` (图钉)
- User: `roundRect` (圆角矩形)
- Subreddit: `arrow` (箭头)

**市场数据图谱图例：**
- MarketData: `circle` (圆形)
- State: `rect` (矩形)
- Game: `diamond` (菱形)
- Entity: `triangle` (三角形)

### 10.6 缩放配置

两个图谱都支持缩放，缩放范围：
- **最小缩放**：0.05（可缩小到5%，便于查看全貌）
- **最大缩放**：3（可放大到3倍）

通过`scaleLimit`配置：
```javascript
scaleLimit: {
  min: 0.05,
  max: 3
}
```

## 11. 最佳实践

### 11.1 性能优化

1. **限制数据量**
   - 使用`limit`参数限制处理的文档数量（建议100-200）
   - 合理设置时间范围，避免查询过多数据

2. **索引优化**
   - 确保`Document`表的`doc_type`、`publish_date`、`created_at`字段有索引
   - 考虑为`extracted_data`字段添加GIN索引（PostgreSQL）

3. **缓存策略**
   - 对于频繁查询的图谱，可以考虑缓存结果
   - 使用Redis缓存热点数据

### 11.2 数据质量

1. **关键词提取**
   - 确保关键词提取算法质量
   - 过滤停用词和无关词汇
   - 控制每个帖子的关键词数量

2. **实体识别**
   - 使用高质量的知识库进行实体链接
   - 合并重复实体（通过`canonical_name`）

3. **主题分类**
   - 确保主题分类准确
   - 统一主题命名规范

### 11.3 错误处理

1. **API层面**
   - 即使查询失败，也返回空图谱而不是错误
   - 记录详细的错误日志
   - 优雅降级处理

2. **前端层面**
   - 显示友好的错误提示
   - 提供重试机制
   - 处理空数据情况

### 11.4 扩展性

1. **添加新平台**
   - 实现新的适配器（继承基础接口）
   - 在`adapters/__init__.py`中注册
   - 无需修改核心构图逻辑

2. **添加新节点类型**
   - 在`models.py`中定义新节点类型
   - 在`builder.py`中添加节点创建逻辑
   - 更新前端可视化配置

3. **添加新边类型**
   - 在`builder.py`中添加边创建逻辑
   - 更新前端边样式配置

## 12. 故障排查

### 12.1 常见问题

**问题1：图谱数据为空**

- **社交平台内容图谱**：检查数据库是否有`doc_type = "social_sentiment"`的文档
- **市场数据图谱**：检查数据库是否有`doc_type = "market"`的文档
- 检查筛选条件是否过于严格
- 查看日志确认数据规范化是否成功

**问题2：节点或边数量异常**

- 检查关键词提取是否正常
- 确认实体识别是否工作
- 查看TF-IDF计算是否有问题

**问题3：API响应慢**

- 检查数据库查询性能
- 考虑添加索引
- 减少`limit`参数值

**问题4：前端图谱不显示**

- 检查浏览器控制台错误
- 确认数据格式是否正确
- 验证ECharts初始化是否成功

### 12.2 日志查看

```bash
# 查看社交平台内容图谱API日志
tail -f logs/api.log | grep content-graph

# 查看市场数据图谱API日志
tail -f logs/api.log | grep market-graph

# 查看图谱构建日志
tail -f logs/api.log | grep "构建图谱"
```

## 13. 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v1.0 | 2025-01 | 初始版本，支持社交平台内容图谱构建 |
| v1.1 | 2025-01 | 添加主题子图提取功能 |
| v1.2 | 2025-01 | 优化节点大小算法，添加全屏功能 |
| v2.0 | 2025-01 | 添加市场数据图谱支持，统一文档 |

## 14. 参考资料

- [ECharts Graph文档](https://echarts.apache.org/zh/option.html#series-graph)
- [图谱数据库设计原则](https://neo4j.com/developer/graph-database/)
- [TF-IDF算法说明](https://en.wikipedia.org/wiki/Tf%E2%80%93idf)

## 15. 联系方式

如有问题或建议，请联系开发团队或提交Issue。

---

**文档版本：** v2.0  
**最后更新：** 2025-01-31  
**维护者：** 开发团队

## 附录：两种图谱对比

| 特性 | 社交平台内容图谱 | 市场数据图谱 |
|------|-----------------|-------------|
| **数据源** | `doc_type = "social_sentiment"` | `doc_type = "market"` |
| **API端点** | `/api/v1/admin/content-graph` | `/api/v1/admin/market-graph` |
| **节点类型** | Post, Keyword, Entity, Topic, SentimentTag, User, Subreddit | MarketData, State, Game, Entity |
| **边类型** | MENTIONS_KEYWORD, MENTIONS_ENTITY, HAS_TOPIC, HAS_SENTIMENT, AUTHORED_BY, IN_SUBREDDIT, CO_OCCURS | IN_STATE, HAS_GAME, MENTIONS_ENTITY |
| **权重计算** | 支持TF-IDF和时间衰减 | 固定权重（1.0） |
| **共现关系** | 支持关键词共现 | 不支持 |
| **子图提取** | 支持按主题提取 | 不支持 |
| **前端页面** | `social-media-graph.html` | `market-data-visualization.html` |
| **筛选参数** | start_date, end_date, platform, topic, limit | start_date, end_date, state, game, limit |
| **节点大小算法** | 非线性映射，支持高链接数节点放大 | 非线性映射，支持高链接数节点放大 |
| **缩放范围** | min: 0.05, max: 3 | min: 0.05, max: 3 |
| **全屏功能** | 支持 | 支持 |
| **图例类型** | 图形符号 | 图形符号 |
