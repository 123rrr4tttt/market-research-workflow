# 数据库说明文档

> 最后更新：2026-02 | 文档索引：`docs/README.md`

## 概述

本文档描述了市场情报系统（Market Intelligence）的数据库结构。数据库使用 PostgreSQL，并启用了 pgvector 扩展以支持向量搜索功能。

**数据库类型**: PostgreSQL  
**向量扩展**: pgvector  
**主键类型**: BigInteger（自增）

---

## 数据表列表

### 核心表（项目 schema）

1. [sources](#sources-数据源表)
2. [documents](#documents-文档表)
3. [market_stats](#market_stats-市场统计表)
4. [config_states](#config_states-配置状态表)
5. [embeddings](#embeddings-向量嵌入表)
6. [etl_job_runs](#etl_job_runs-etl任务运行表)
7. [search_history](#search_history-搜索历史表)

### 扩展表

8. [扩展表（项目级 schema）](#扩展表项目级-schema)：projects, topics, llm_service_configs, ingest_channels, source_library_items, market_metric_points, products, price_observations

---

## 数据表详细说明

### sources (数据源表)

存储数据源的基本信息，用于标识和管理不同的数据来源。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BigInteger | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| name | String(255) | NOT NULL | 数据源名称 |
| kind | String(32) | NOT NULL | 数据源类型（如：website, api等） |
| base_url | String(1024) | NULL | 数据源基础URL |
| enabled | Boolean | NOT NULL, DEFAULT true | 是否启用 |
| created_at | DateTime(timezone) | NOT NULL, DEFAULT now() | 创建时间 |
| updated_at | DateTime(timezone) | NOT NULL, DEFAULT now() | 更新时间（自动更新） |

**关系**:
- 一对多关联 `documents` 表（一个数据源可以有多份文档）

**用途**: 管理数据源配置，控制数据源的启用/禁用状态。

---

### documents (文档表)

存储从各种数据源获取的文档内容，包括原始内容和提取的结构化数据。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BigInteger | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| source_id | BigInteger | FOREIGN KEY(sources.id), NULL | 关联的数据源ID |
| state | String(8) | NULL | 州/地区代码（如：CA, NY等） |
| doc_type | String(16) | NOT NULL | 文档类型 |
| title | Text | NULL | 文档标题 |
| status | String(32) | NULL | 文档状态 |
| publish_date | Date | NULL | 发布日期 |
| content | Text | NULL | 文档内容（原始文本） |
| summary | Text | NULL | 文档摘要 |
| text_hash | String(64) | UNIQUE, NULL | 文本内容的哈希值（用于去重） |
| uri | Text | NULL | 文档URI/URL |
| extracted_data | JSONB | NULL | 提取的结构化数据（JSON格式） |
| created_at | DateTime(timezone) | NOT NULL, DEFAULT now() | 创建时间 |
| updated_at | DateTime(timezone) | NOT NULL, DEFAULT now() | 更新时间（自动更新） |

**关系**:
- 多对一关联 `sources` 表（多个文档可以属于同一个数据源）
- 一对多关联 `embeddings` 表（一个文档可以有多个向量嵌入）

**索引**:
- `text_hash` 字段有唯一索引，用于去重

**用途**: 存储从数据源获取的文档，支持全文搜索和向量搜索。

#### extracted_data 字段详解

`extracted_data` 字段是 JSONB 类型，存储根据文档类型（`doc_type`）提取的结构化数据。不同文档类型包含不同的结构化信息：

##### 1. 政策文档 (doc_type: "policy" 或 "policy_regulation")

```json
{
  "platform": "google_news",
  "source": "新闻来源名称",
  "keyword": "搜索关键词",
  "policy": {
    "state": "CA",
    "effective_date": "2025-01-15",
    "policy_type": "regulation",
    "key_points": [
      "关键要点1",
      "关键要点2"
    ]
  },
  "entities_relations": {
    "entities": [
      {
        "text": "California Lottery Commission",
        "type": "AGENCY",
        "span": [10, 35]
      }
    ],
    "relations": [
      {
        "subject": "California Lottery Commission",
        "predicate": "announces",
        "object": "new regulation",
        "evidence": "文本证据",
        "confidence": 0.95,
        "date": "2025-01-15"
      }
    ]
  }
}
```

**字段说明**:
- `platform`: 数据来源平台（如：google_news）
- `source`: 新闻来源名称
- `keyword`: 搜索时使用的关键词
- `policy`: 政策提取信息
  - `state`: 州代码（如：CA, NY）
  - `effective_date`: 生效日期（YYYY-MM-DD格式）
  - `policy_type`: 政策类型（regulation, bill, announcement, guidance等）
  - `key_points`: 关键要点列表（最多5条）
- `entities_relations`: 实体和关系信息（可选）
  - `entities`: 实体列表（最多5个）
    - `text`: 实体文本
    - `type`: 实体类型（ORG, LOC, PERSON, AGENCY, LAW, GAME）
    - `span`: 文本位置 [start, end]（可选）
  - `relations`: 关系列表（最多3条）
    - `subject`: 主体
    - `predicate`: 谓词（regulates, affects, announces, changes_rule, reports_sales）
    - `object`: 客体
    - `evidence`: 证据文本
    - `confidence`: 置信度（0.0-1.0）
    - `date`: 关系日期（ISO格式，可选）

##### 2. 市场数据文档 (doc_type: "market")

```json
{
  "market": {
    "state": "CA",
    "game": "Powerball",
    "report_date": "2025-01-15",
    "sales_volume": 15000000.50,
    "revenue": 7500000.25,
    "jackpot": 50000000.00,
    "ticket_price": 2.00,
    "draw_number": "12-25-33-44-55 PB: 10",
    "yoy_change": 5.5,
    "mom_change": -2.3,
    "key_findings": [
      "Sales volume increased 5.5% year-over-year",
      "Jackpot reached $50 million"
    ]
  },
  "entities_relations": {
    "entities": [...],
    "relations": [...]
  }
}
```

**字段说明**:
- `market`: 市场数据提取信息
  - `state`: 州代码
  - `game`: 游戏类型（如：Powerball, Mega Millions）
  - `report_date`: 报告日期（YYYY-MM-DD格式）
  - `sales_volume`: 销售额（数字）
  - `revenue`: 收入（数字）
  - `jackpot`: 奖池金额（数字）
  - `ticket_price`: 票价（数字）
  - `draw_number`: 开奖号码（字符串）
  - `yoy_change`: 同比变化百分比（数字）
  - `mom_change`: 环比变化百分比（数字）
  - `key_findings`: 关键发现列表（最多5条）

##### 3. 社交媒体舆论文档 (doc_type: "social_sentiment")

这是**舆论结构化数据的核心**，包含完整的社交媒体情感分析信息：

```json
{
  "platform": "reddit",
  "username": "lottery_player_123",
  "subreddit": "Lottery",
  "likes": 45,
  "comments": 12,
  "text": "原始文本内容...",
  "sentiment": {
    "sentiment_tags": [
      "entertainment",
      "hope",
      "addiction",
      "scam fear"
    ],
    "sentiment_orientation": "positive",
    "key_phrases": [
      "winning ticket",
      "jackpot dream",
      "lucky numbers"
    ],
    "emotion_words": [
      "excited",
      "hopeful",
      "anxious"
    ],
    "topic": "Powerball jackpot discussion"
  }
}
```

**字段说明**:
- `platform`: 社交媒体平台（如：reddit, twitter, facebook等）
- `username`: 用户名
- `subreddit`: Reddit子论坛名称（如果是Reddit数据）
- `likes`: 点赞数
- `comments`: 评论数
- `text`: 原始文本内容
- `sentiment`: **舆论情感分析结果**（通过LLM提取）
  - `sentiment_tags`: 情感标签列表
    - 常见标签包括：`entertainment`（娱乐）、`hope`（希望）、`addiction`（成瘾）、`scam fear`（诈骗担忧）、`excitement`（兴奋）、`disappointment`（失望）、`skepticism`（怀疑）等
  - `sentiment_orientation`: 情感倾向
    - `positive`: 正面情感
    - `negative`: 负面情感
    - `neutral`: 中性情感
  - `key_phrases`: 关键短语列表
    - 提取文本中的关键表达和重要短语
  - `emotion_words`: 情感表达词汇列表
    - 识别文本中的情感词汇，如：excited, hopeful, anxious, frustrated, happy等
  - `topic`: 主要主题关键词
    - 总结文本讨论的核心主题

##### 4. 新闻文档 (doc_type: "news")

```json
{
  "platform": "reddit",
  "username": "news_reader",
  "subreddit": "news",
  "likes": 120,
  "comments": 35,
  "text": "新闻内容..."
}
```

**字段说明**:
- 包含基本的平台信息和用户互动数据
- 可能包含 `sentiment` 字段（如果启用了情感分析）

#### 结构化数据的提取流程

1. **数据摄取阶段**:
   - 从数据源（Reddit、Google News等）获取原始数据
   - 根据 `doc_type` 选择相应的提取函数

2. **结构化提取阶段**:
   - **政策文档**: 使用 `extract_policy_info()` 提取政策信息，使用 `extract_entities_relations()` 提取实体关系
   - **市场数据**: 使用 `extract_market_info()` 提取市场信息，使用 `extract_entities_relations()` 提取实体关系
   - **社交媒体舆论**: 使用 `extract_structured_sentiment()` 提取情感信息

3. **存储阶段**:
   - 将提取的结构化数据合并到 `extracted_data` JSONB 字段
   - 支持后续的查询和分析

#### 舆论结构化数据的应用场景

1. **情感趋势分析**:
   - 通过 `sentiment_orientation` 统计正面/负面/中性情感分布
   - 追踪情感变化趋势

2. **主题聚类**:
   - 使用 `sentiment_tags` 和 `topic` 进行主题聚类
   - 识别热门讨论话题

3. **用户画像**:
   - 结合 `username`、`likes`、`comments` 分析用户活跃度
   - 识别意见领袖和关键影响者

4. **情感标签分析**:
   - 统计 `sentiment_tags` 的频率分布
   - 识别主要的情感类别（如：娱乐、希望、成瘾担忧等）

5. **关键短语挖掘**:
   - 分析 `key_phrases` 和 `emotion_words`
   - 发现用户常用的表达方式和情感词汇

#### 查询示例

```sql
-- 查询所有包含情感分析的社交媒体文档
SELECT id, title, extracted_data->'sentiment' as sentiment
FROM documents
WHERE doc_type = 'social_sentiment'
  AND extracted_data->'sentiment' IS NOT NULL;

-- 查询正面情感的文档
SELECT id, title, extracted_data->'sentiment'->>'sentiment_orientation' as orientation
FROM documents
WHERE extracted_data->'sentiment'->>'sentiment_orientation' = 'positive';

-- 查询包含特定情感标签的文档
SELECT id, title, extracted_data->'sentiment'->'sentiment_tags' as tags
FROM documents
WHERE extracted_data->'sentiment'->'sentiment_tags' @> '["hope"]'::jsonb;

-- 统计各平台的情感分布
SELECT 
  extracted_data->>'platform' as platform,
  extracted_data->'sentiment'->>'sentiment_orientation' as orientation,
  COUNT(*) as count
FROM documents
WHERE doc_type = 'social_sentiment'
  AND extracted_data->'sentiment' IS NOT NULL
GROUP BY platform, orientation;
```

---

### market_stats (市场统计表)

存储各州彩票市场的统计数据，包括销售额、收入、奖池等信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BigInteger | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| state | String(8) | NOT NULL | 州/地区代码 |
| game | String(32) | NULL | 游戏类型/名称 |
| date | Date | NOT NULL | 统计日期 |
| sales_volume | Numeric(18,2) | NULL | 销售额 |
| revenue | Numeric(18,2) | NULL | 收入 |
| revenue_estimated | Numeric(18,2) | NULL | 估算收入 |
| jackpot | Numeric(18,2) | NULL | 奖池金额 |
| ticket_price | Numeric(10,2) | NULL | 票价 |
| draw_number | String(32) | NULL | 开奖号码 |
| yoy | Numeric(10,4) | NULL | 同比（Year-over-Year）增长率 |
| mom | Numeric(10,4) | NULL | 环比（Month-over-Month）增长率 |
| source_name | String(128) | NULL | 数据源名称 |
| source_uri | Text | NULL | 数据源URI |
| extra | JSONB | NULL | 额外信息（JSON格式） |
| created_at | DateTime(timezone) | NOT NULL, DEFAULT now() | 创建时间 |

**唯一约束**:
- `uq_market_state_game_date`: (state, game, date) 组合唯一，确保同一州、同一游戏、同一日期的数据不重复

**用途**: 存储彩票市场统计数据，支持按州、游戏、日期进行查询和分析。

---

### config_states (配置状态表)

存储各州的配置状态，用于控制哪些州的数据需要处理。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BigInteger | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| state_name | String(32) | NOT NULL, UNIQUE | 州名称 |
| enabled | Boolean | NOT NULL, DEFAULT true | 是否启用 |

**唯一约束**:
- `state_name` 字段唯一

**用途**: 管理各州的数据处理配置，控制哪些州的数据需要采集和处理。

---

### embeddings (向量嵌入表)

存储文档或其他对象的向量嵌入，用于语义搜索和相似度计算。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BigInteger | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| object_id | BigInteger | NOT NULL | 关联对象ID（如document.id） |
| object_type | String(32) | NOT NULL | 对象类型（如：document） |
| modality | String(16) | NOT NULL | 模态类型（如：text, image等） |
| vector | Vector(3072) | NOT NULL | 向量数据（3072维） |
| dim | Integer | NOT NULL, DEFAULT 3072 | 向量维度 |
| provider | String(32) | NOT NULL, DEFAULT 'openai' | 向量提供者 |
| model | String(128) | NOT NULL, DEFAULT 'text-embedding-3-large' | 使用的模型名称 |
| created_at | DateTime(timezone) | NOT NULL, DEFAULT now() | 创建时间 |

**索引**:
- `ix_embeddings_object`: (object_id, object_type) 组合索引，用于快速查找对象的向量

**关系**:
- 多对一关联 `documents` 表（通过 object_id 和 object_type）

**用途**: 存储向量嵌入数据，支持语义搜索和相似文档推荐。

---

### etl_job_runs (ETL任务运行表)

存储ETL（Extract, Transform, Load）任务的运行记录和状态。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BigInteger | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| job_type | String(16) | NOT NULL | 任务类型 |
| params | JSONB | NULL | 任务参数（JSON格式） |
| status | String(16) | NOT NULL, DEFAULT 'queued' | 任务状态（queued, running, completed, failed等） |
| started_at | DateTime(timezone) | NULL | 开始时间 |
| finished_at | DateTime(timezone) | NULL | 完成时间 |
| error | Text | NULL | 错误信息（如果任务失败） |

**索引**:
- `ix_etl_job_runs_type_status`: (job_type, status) 组合索引，用于快速查询特定类型和状态的任务

**用途**: 跟踪ETL任务的执行状态，支持任务监控和错误排查。

---

### search_history (搜索历史表)

存储用户的搜索历史记录，用于跟踪搜索主题和最后搜索时间。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BigInteger | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| topic | String(255) | NOT NULL, UNIQUE | 搜索主题 |
| last_search_time | DateTime(timezone) | NOT NULL, DEFAULT now() | 最后搜索时间 |

**唯一约束**:
- `uq_search_history_topic`: `topic` 字段唯一，确保每个主题只有一条记录

**用途**: 记录搜索历史，支持搜索主题的去重和最后搜索时间的跟踪。

---

## 扩展表（项目级 schema）

以下表存在于 `public` 或各项目 schema（如 `project_online_lottery`）中，按需创建。

| 表名 | 说明 |
|------|------|
| `projects` | 项目/租户配置（public） |
| `project_sync_state` | 项目同步游标（public） |
| `topics` | 主题管理 |
| `llm_service_configs` | LLM 服务配置（提取/搜索等） |
| `ingest_channels` | 摄取频道配置 |
| `source_library_items` | 信息源库条目 |
| `market_metric_points` | 市场指标时间序列 |
| `products` | 商品管理 |
| `price_observations` | 价格观测 |

详细字段见 `app/models/entities.py` 及迁移脚本 `migrations/versions/`。

---

## 数据库关系图

```
sources (1) ──< (N) documents (1) ──< (N) embeddings
                                    │
                                    └──> (N) market_stats
                                    │
                                    └──> (N) search_history

config_states (独立表)
etl_job_runs (独立表)
```

---

## 索引说明

### 主要索引

1. **documents.text_hash**: 唯一索引，用于文档去重
2. **embeddings.ix_embeddings_object**: (object_id, object_type) 组合索引，用于快速查找对象的向量
3. **etl_job_runs.ix_etl_job_runs_type_status**: (job_type, status) 组合索引，用于任务查询
4. **market_stats.uq_market_state_game_date**: (state, game, date) 唯一约束，防止重复数据
5. **search_history.uq_search_history_topic**: topic 唯一约束，确保主题唯一

---

## 数据类型说明

### 数值类型
- **BigInteger**: 大整数，用于主键ID，支持更大的数据量
- **Numeric(precision, scale)**: 精确数值类型，用于金额和百分比
  - `Numeric(18,2)`: 18位精度，2位小数（用于金额）
  - `Numeric(10,4)`: 10位精度，4位小数（用于百分比）

### 文本类型
- **String(n)**: 固定长度字符串
- **Text**: 可变长度文本，无长度限制

### 日期时间类型
- **Date**: 日期类型
- **DateTime(timezone)**: 带时区的时间戳

### 特殊类型
- **JSONB**: PostgreSQL的二进制JSON类型，支持高效的JSON查询和索引
- **Vector(n)**: pgvector扩展的向量类型，用于存储向量嵌入
- **Boolean**: 布尔类型

---

## 扩展说明

### pgvector 扩展

数据库启用了 `pgvector` 扩展，用于支持向量相似度搜索。主要用于 `embeddings` 表中的向量数据存储和查询。

**向量维度**: 3072（默认）  
**向量模型**: text-embedding-3-large（OpenAI）  
**向量提供者**: OpenAI（默认）

---

## 使用建议

### 查询优化

1. **documents表**: 使用 `text_hash` 进行去重查询，使用 `source_id` 进行关联查询
2. **market_stats表**: 使用 (state, game, date) 组合进行查询，利用唯一约束提高性能
3. **embeddings表**: 使用 (object_id, object_type) 索引进行向量查询
4. **etl_job_runs表**: 使用 (job_type, status) 索引进行任务状态查询

### 数据维护

1. **定期清理**: 建议定期清理过期的 `etl_job_runs` 记录
2. **向量更新**: 当文档内容更新时，需要同步更新对应的 `embeddings` 记录
3. **去重机制**: 使用 `text_hash` 字段防止重复文档入库

---

## 版本历史

- **2025-10-29**: 初始版本，创建基础表结构
- **2025-10-29**: 添加 market_stats 表的 source 相关字段
- **2025-10-29**: 添加 market_stats 表的 game 字段
- **2025-11-01**: 添加 search_history 表和 documents.extracted_data 字段
- **2025-11-02**: 将所有表的主键ID从 Integer 升级为 BigInteger

---

## 可视化设计建议

基于此数据库结构，建议的可视化设计包括：

### 基础数据可视化

1. **数据源管理面板**: 展示 sources 表数据，支持启用/禁用操作
2. **文档浏览界面**: 展示 documents 表数据，支持按数据源、州、类型筛选
3. **市场统计仪表板**: 展示 market_stats 表数据，支持按州、游戏、日期范围查询，展示趋势图表
4. **搜索历史界面**: 展示 search_history 表数据，支持按时间排序
5. **ETL任务监控**: 展示 etl_job_runs 表数据，支持任务状态监控和错误查看
6. **向量搜索界面**: 基于 embeddings 表实现语义搜索功能

### 舆论结构化数据可视化（重点）

基于 `documents.extracted_data` 中的舆论结构化数据，建议设计以下可视化界面：

#### 1. 情感分析仪表板

**功能**: 展示社交媒体舆论的情感分布和趋势

**可视化组件**:
- **情感倾向饼图**: 展示正面/负面/中性情感的比例分布
- **情感趋势折线图**: 按时间维度展示情感变化趋势
- **情感标签云图**: 展示 `sentiment_tags` 的频率分布，标签大小表示出现频率
- **平台对比柱状图**: 对比不同平台（Reddit、Twitter等）的情感分布差异

**数据来源**:
```sql
-- 情感倾向统计
SELECT 
  extracted_data->'sentiment'->>'sentiment_orientation' as orientation,
  COUNT(*) as count
FROM documents
WHERE doc_type = 'social_sentiment'
  AND extracted_data->'sentiment' IS NOT NULL
GROUP BY orientation;

-- 情感趋势（按日期）
SELECT 
  DATE(created_at) as date,
  extracted_data->'sentiment'->>'sentiment_orientation' as orientation,
  COUNT(*) as count
FROM documents
WHERE doc_type = 'social_sentiment'
  AND extracted_data->'sentiment' IS NOT NULL
GROUP BY date, orientation
ORDER BY date DESC;
```

#### 2. 主题聚类可视化

**功能**: 展示舆论讨论的主要主题和话题

**可视化组件**:
- **主题词云**: 基于 `topic` 字段生成词云图
- **主题时间线**: 展示不同主题随时间的热度变化
- **主题关联网络图**: 展示主题之间的关联关系

**数据来源**:
```sql
-- 主题统计
SELECT 
  extracted_data->'sentiment'->>'topic' as topic,
  COUNT(*) as count
FROM documents
WHERE doc_type = 'social_sentiment'
  AND extracted_data->'sentiment'->>'topic' IS NOT NULL
GROUP BY topic
ORDER BY count DESC
LIMIT 20;
```

#### 3. 情感标签分析界面

**功能**: 深入分析情感标签的分布和含义

**可视化组件**:
- **标签频率柱状图**: 展示各情感标签的出现频率
- **标签共现矩阵**: 展示哪些标签经常一起出现
- **标签情感映射**: 将标签映射到情感倾向，展示标签的情感分布

**数据来源**:
```sql
-- 标签频率统计（需要展开JSONB数组）
SELECT 
  tag,
  COUNT(*) as frequency
FROM documents,
  jsonb_array_elements_text(extracted_data->'sentiment'->'sentiment_tags') as tag
WHERE doc_type = 'social_sentiment'
  AND extracted_data->'sentiment'->'sentiment_tags' IS NOT NULL
GROUP BY tag
ORDER BY frequency DESC;
```

#### 4. 用户互动分析

**功能**: 分析社交媒体用户的互动行为

**可视化组件**:
- **点赞/评论散点图**: 展示点赞数和评论数的关系
- **活跃用户排行榜**: 基于 `likes` 和 `comments` 识别活跃用户
- **平台互动对比**: 对比不同平台的用户互动水平

**数据来源**:
```sql
-- 用户互动统计
SELECT 
  extracted_data->>'platform' as platform,
  AVG((extracted_data->>'likes')::int) as avg_likes,
  AVG((extracted_data->>'comments')::int) as avg_comments,
  COUNT(*) as post_count
FROM documents
WHERE doc_type = 'social_sentiment'
GROUP BY platform;
```

#### 5. 关键短语和情感词分析

**功能**: 挖掘用户常用的表达方式和情感词汇

**可视化组件**:
- **关键短语词云**: 基于 `key_phrases` 生成词云
- **情感词频率图**: 展示 `emotion_words` 的频率分布
- **短语-情感关联图**: 展示关键短语与情感倾向的关联

**数据来源**:
```sql
-- 关键短语统计
SELECT 
  phrase,
  COUNT(*) as frequency
FROM documents,
  jsonb_array_elements_text(extracted_data->'sentiment'->'key_phrases') as phrase
WHERE doc_type = 'social_sentiment'
  AND extracted_data->'sentiment'->'key_phrases' IS NOT NULL
GROUP BY phrase
ORDER BY frequency DESC
LIMIT 50;
```

#### 6. 舆论时间线视图

**功能**: 展示舆论事件的时间演变过程

**可视化组件**:
- **时间轴视图**: 展示重要舆论事件的时间线
- **情感演变曲线**: 展示特定主题的情感随时间的变化
- **事件热力图**: 展示不同时间段的事件热度

**数据来源**:
```sql
-- 时间线数据
SELECT 
  DATE(created_at) as date,
  title,
  extracted_data->'sentiment'->>'sentiment_orientation' as orientation,
  extracted_data->'sentiment'->>'topic' as topic,
  (extracted_data->>'likes')::int as likes
FROM documents
WHERE doc_type = 'social_sentiment'
  AND extracted_data->'sentiment' IS NOT NULL
ORDER BY created_at DESC;
```

#### 7. 舆论对比分析

**功能**: 对比不同维度（平台、时间、主题）的舆论差异

**可视化组件**:
- **多维度对比表**: 支持按平台、时间、主题等维度进行对比
- **雷达图**: 展示不同平台的情感标签分布
- **热力图**: 展示不同主题在不同平台的情感分布

#### 8. 实时舆论监控

**功能**: 实时展示最新的舆论动态

**可视化组件**:
- **实时数据流**: 展示最新采集的舆论数据
- **实时情感指标**: 展示当前的情感倾向分布
- **热点话题列表**: 实时更新的热门话题

### 可视化设计要点

1. **数据层次**: 
   - 概览层：整体情感分布和趋势
   - 分析层：详细的情感标签和主题分析
   - 明细层：具体的文档和用户评论

2. **交互功能**:
   - 支持时间范围筛选
   - 支持平台筛选
   - 支持主题/标签筛选
   - 支持钻取（从概览到明细）

3. **视觉设计**:
   - 使用颜色编码情感倾向（绿色=正面，红色=负面，灰色=中性）
   - 使用大小表示频率/重要性
   - 使用动画展示趋势变化

4. **性能优化**:
   - 对 `extracted_data` JSONB 字段建立 GIN 索引以加速查询
   - 使用物化视图缓存常用统计结果
   - 实现数据分页和懒加载

### JSONB 索引建议

为了优化舆论数据的查询性能，建议创建以下索引：

```sql
-- 为 sentiment 字段创建 GIN 索引
CREATE INDEX idx_documents_extracted_data_sentiment 
ON documents USING GIN ((extracted_data->'sentiment'));

-- 为 sentiment_tags 数组创建 GIN 索引
CREATE INDEX idx_documents_extracted_data_sentiment_tags 
ON documents USING GIN ((extracted_data->'sentiment'->'sentiment_tags'));

-- 为 platform 字段创建索引
CREATE INDEX idx_documents_extracted_data_platform 
ON documents ((extracted_data->>'platform'))
WHERE doc_type = 'social_sentiment';
```

---

*文档生成时间: 2025-11-02*  
*数据库版本: PostgreSQL (支持 pgvector)*

