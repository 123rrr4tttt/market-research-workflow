# 政策可视化数据校验与实时性说明

> 最后更新：2026-02 | 文档索引：`docs/README.md`

## 1. 文档定位

本文件合并“政策统计一致性检查”和“热力图数据实时性分析”两类报告，作为政策可视化统计接口的主说明。

历史报告位于 `main/backend/docs/archive/policy-visualization/`。

## 2. 检查范围

- 后端接口：`/api/v1/policies/stats`
- 前端页面：`policy-dashboard.html`（及相关政策可视化页面）
- 数据模型：`Document` 与相关统计字段

## 3. 一致性校验结论（汇总）

### 3.1 历史已识别问题（含修复项）

- 州分布统计曾与列表过滤口径不一致
  - 列表逻辑会兼容 `Document.state` 与 `extracted_data.policy.state`
  - 统计逻辑曾仅使用 `Document.state`
  - 历史报告标记该问题已修复

### 3.2 仍需明确的统计口径

- 时间趋势统计可能排除 `publish_date` 为空的记录
- 因此趋势图总和可能小于总数（口径差异）

建议：

- 明确时间统计口径（仅 `publish_date` 或回退 `created_at`）
- 在接口/前端展示中标注该口径

### 3.3 性能风险

- 部分统计若在 Python 层内存聚合，数据量大时会有性能压力

建议：

- 优先评估数据库端聚合
- 增加接口耗时监控

## 4. 实时性结论（汇总）

### 4.1 后端层

- 无应用层缓存时，接口按请求实时查询数据库
- 数据库更新后，后端返回值原则上实时反映变化

### 4.2 前端层

- 常见触发点：页面加载、筛选、重置
- 默认不一定有自动刷新机制

影响：

- 页面停留期间，数据可能不会自动更新

### 4.3 浏览器缓存风险

- 若未显式设置缓存控制，浏览器可能缓存统计接口响应

建议：

- 后端设置 `Cache-Control`
- 前端 `fetch()` 使用 `cache: 'no-cache'`（实时性要求高的页面）

## 5. 推荐改进清单

1. 明确并返回统计口径（高优先级）
2. 禁用或控制统计接口缓存（高优先级）
3. 为前端页面增加手动刷新或可选自动刷新（中优先级）
4. 在大数据量场景优化聚合逻辑（中优先级）

## 6. 回归验证清单

1. 数据库更新后接口返回是否变化
2. 前端刷新/筛选后图表是否同步更新
3. 浏览器 Network 面板是否符合缓存预期
4. 趋势图与总数差异是否可由口径解释
5. 大数据量下接口耗时是否可接受

## 7. 相关文档

- `政策数据结构说明.md`
- `接口层调查文档.md`
- `main/backend/API接口文档.md`

## 8. 历史归档（来源）

- `main/backend/docs/archive/policy-visualization/政策统计一致性检查报告.md`
- `main/backend/docs/archive/policy-visualization/热力图数据实时性分析.md`

