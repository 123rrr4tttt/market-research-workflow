services:
  db:
    image: ankane/pgvector:latest
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  es:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.3
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=${ES_JAVA_OPTS:--Xms512m -Xmx512m}
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7.4
    ports:
      - "6379:6379"

  backend:
    build:
      context: ../
      dockerfile: ./backend/Dockerfile
    env_file:
      - ../backend/.env
    environment:
      DOCKER_ENV: "true"
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://postgres:postgres@db:5432/postgres}
      ES_URL: ${ES_URL:-http://es:9200}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      RUN_MIGRATIONS: ${RUN_MIGRATIONS_BACKEND:-true}
      CELERY_LOG_FILE: /var/log/celery/worker.log
      OPENAI_API_BASE: "https://api.openai.com/v1"
      MODERN_FRONTEND_URL: ${MODERN_FRONTEND_URL:-http://localhost:5174}
    depends_on:
      db:
        condition: service_healthy
      es:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "8000:8000"
    volumes:
      - ../backend:/app
      - ../frontend:/app/frontend
      # 信息源库（来源库配置）挂载，供 source_library 加载
      - ../../信息源库:/app/信息源库:ro
      # 单独挂载启动脚本，确保entrypoint可用
      - ../backend/docker-entrypoint.sh:/docker-entrypoint.sh:ro
      - ../logs:/var/log/celery
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Celery Worker服务（用于异步任务处理）
  celery-worker:
    build:
      context: ../
      dockerfile: ./backend/Dockerfile
    environment:
      DOCKER_ENV: "true"
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://postgres:postgres@db:5432/postgres}
      ES_URL: ${ES_URL:-http://es:9200}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      RUN_MIGRATIONS: ${RUN_MIGRATIONS_WORKER:-false}
      CELERY_LOG_FILE: /var/log/celery/worker.log
    depends_on:
      backend:
        condition: service_healthy
      db:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - ../backend:/app
      - ../../信息源库:/app/信息源库:ro
      - ../logs:/var/log/celery
    command: >-
      celery -A app.celery_app worker
      --loglevel=${CELERY_LOG_LEVEL:-info}
      --concurrency=${CELERY_CONCURRENCY:-1}
      --prefetch-multiplier=${CELERY_PREFETCH_MULTIPLIER:-1}
      --max-tasks-per-child=${CELERY_MAX_TASKS_PER_CHILD:-50}
      --max-memory-per-child=${CELERY_MAX_MEMORY_PER_CHILD:-300000}
      --logfile=/var/log/celery/worker.log
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.celery_app inspect ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # 独立测试服务（不影响运行时镜像）
  backend-test:
    build:
      context: ../
      dockerfile: ./backend/Dockerfile.test
    environment:
      DOCKER_ENV: "true"
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@db:5432/postgres
      ES_URL: http://es:9200
      REDIS_URL: redis://redis:6379/0
    depends_on:
      db:
        condition: service_healthy
      es:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - ../backend:/app
      - ../frontend:/app/frontend
    profiles:
      - test

  frontend-modern:
    build:
      context: ../frontend-modern
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-}
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "5174:80"
    profiles:
      - modern-ui

volumes:
  db_data:
  es_data:
